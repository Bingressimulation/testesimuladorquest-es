<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PQO Risco ‚Äî Simulador (Layout novo)</title>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* ===== Paleta Azul + Verde (com neutros) ===== */
      --bg: #F6F9FC;
      --panel: #FFFFFF;
      --panel-2: #F0F6FF;

      --text: #0B1220;
      --muted: #5B677A;

      --border: rgba(15, 23, 42, .10);
      --shadow: 0 14px 40px rgba(2, 8, 23, .08);

      --blue-950:#07132B;
      --blue-900:#0B1B3A;
      --blue-800:#0E2A5A;
      --blue-700:#1742A3;
      --blue-600:#2563EB;
      --blue-500:#3B82F6;

      --green-700:#0D7A4E;
      --green-600:#16A34A;
      --green-500:#22C55E;
      --green-200:#BBF7D0;

      --warn:#F59E0B;
      --danger:#EF4444;

      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;

      --side-w: 292px;
      --top-h: 64px;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== Layout geral (Sidebar + Conte√∫do) ===== */
    .app{
      display:grid;
      grid-template-columns: var(--side-w) 1fr;
      min-height: 100vh;
    }

    /* ===== Sidebar (estilo B3) ===== */
    .sidebar{
      position: sticky;
      top: 0;
      height: 100vh;
      background: linear-gradient(180deg, var(--blue-900), var(--blue-950));
      color: #EAF1FF;
      padding: 18px 14px;
      border-right: 1px solid rgba(255,255,255,.08);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px 16px 12px;
    }
    .brand-badge{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: rgba(59,130,246,.18);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.12);
    }
    .brand-badge svg{ width: 20px; height: 20px; fill:#CFE2FF; }
    .brand h1{
      font-size: 14px;
      margin:0;
      line-height: 1.15;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .brand small{
      display:block;
      opacity:.8;
      font-weight: 500;
      margin-top: 2px;
      font-size: 12px;
    }

    .side-section{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.06);
    }
    .side-title{
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .4px;
      opacity: .95;
      margin: 0 0 10px 2px;
      text-transform: uppercase;
    }

    .nav{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .nav button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: #EAF1FF;
      border-radius: 12px;
      padding: 10px 10px;
      text-align:left;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      transition: .15s ease;
      font-weight: 700;
      font-size: 13px;
    }
    .nav button:hover{ background: rgba(59,130,246,.16); border-color: rgba(59,130,246,.35); }
    .nav button.active{ background: rgba(59,130,246,.22); border-color: rgba(59,130,246,.45); }
    .nav .hint{
      font-weight: 700;
      opacity: .75;
      font-size: 12px;
    }

    .side-controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      font-weight: 700;
    }
    .switch{
      width: 42px; height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.18);
      position: relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      top: 2px; left: 2px;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 999px;
      transition: .15s ease;
    }
    .switch.on{ background: rgba(34,197,94,.28); border-color: rgba(34,197,94,.45); }
    .switch.on::after{ transform: translateX(18px); }

    .side-footer{
      position:absolute;
      bottom: 14px;
      left: 14px;
      right: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .pill{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
      font-size: 12px;
      color: rgba(234,241,255,.92);
    }
    .pill strong{ font-size: 12px; }
    .pill .mini{ opacity:.78; font-weight: 650; }

    /* ===== √Årea principal ===== */
    .main{
      display:flex;
      flex-direction: column;
      min-width: 0;
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      height: var(--top-h);
      background: rgba(246,249,252,.82);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 18px;
      gap: 12px;
    }
    .top-left{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .page-title{
      display:flex;
      flex-direction: column;
      min-width: 0;
    }
    .page-title strong{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .page-title span{
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .top-right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 8px 18px rgba(2, 8, 23, .06);
      font-size: 12px;
      font-weight: 800;
      color: var(--blue-900);
      white-space: nowrap;
    }
    .chip b{ color: var(--green-700); }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 850;
      font-size: 13px;
      cursor:pointer;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      box-shadow: 0 10px 22px rgba(2, 8, 23, .06);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue-700), var(--blue-600));
      border-color: rgba(37,99,235,.55);
      color:#fff;
    }
    .btn.success{
      background: linear-gradient(135deg, var(--green-700), var(--green-600));
      border-color: rgba(22,163,74,.6);
      color:#fff;
    }
    .btn.danger{
      background: #fff;
      border-color: rgba(239,68,68,.35);
      color: var(--danger);
    }

    /* Conte√∫do */
    .content{
      padding: 18px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
      align-items: start;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,0));
    }
    .card-header h2{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .card-header .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
    }

    .card-body{ padding: 16px; }

    /* Bloco de filtros */
    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      font-weight: 850;
      color: var(--blue-900);
    }
    .field select, .field input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 13px;
      font-weight: 650;
      outline: none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .inline-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    /* Quest√£o */
    .q-meta{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.18);
      font-size: 12px;
      font-weight: 800;
      color: var(--blue-900);
    }
    .tag.green{
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.18);
      color: var(--green-700);
    }
    .tag.gray{
      background: rgba(15,23,42,.06);
      border-color: rgba(15,23,42,.10);
      color: var(--muted);
    }

    .q-title{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      margin: 0 0 10px 0;
    }
    .q-text{
      margin: 0 0 14px 0;
      line-height: 1.55;
      font-size: 14px;
      color: rgba(11,18,32,.92);
      white-space: pre-wrap;
    }

    .options{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .opt{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      cursor:pointer;
      transition: .15s ease;
      user-select: none;
    }
    .opt:hover{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 12px 26px rgba(2,8,23,.08);
      transform: translateY(-1px);
    }
    .opt .letter{
      width: 28px; height: 28px;
      border-radius: 10px;
      display:grid; place-items:center;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.18);
      font-weight: 900;
      color: var(--blue-900);
      flex: 0 0 auto;
    }
    .opt .txt{
      font-size: 13px;
      font-weight: 650;
      color: rgba(11,18,32,.92);
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .opt.selected{
      border-color: rgba(22,163,74,.45);
      background: rgba(34,197,94,.07);
    }
    .opt.selected .letter{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.25);
      color: var(--green-700);
    }

    .explain{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(37,99,235,.18);
      background: rgba(37,99,235,.06);
      color: rgba(11,18,32,.92);
      font-size: 13px;
      line-height: 1.45;
      display:none;
      white-space: pre-wrap;
    }
    .explain.show{ display:block; }

    .result-row{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .status{
      font-size: 13px;
      font-weight: 900;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
    }
    .status.ok{ color: var(--green-700); border-color: rgba(22,163,74,.30); background: rgba(34,197,94,.08); }
    .status.bad{ color: var(--danger); border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.06); }
    .status.neutral{ color: var(--muted); }

    /* Painel lateral direito */
    .side-card .card-body{ padding: 14px; }
    .mini-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(34,197,94,.08), rgba(255,255,255,0));
      padding: 12px 12px;
    }
    .kpi .lbl{
      font-size: 12px;
      font-weight: 850;
      color: var(--muted);
    }
    .kpi .val{
      font-size: 18px;
      font-weight: 950;
      margin-top: 4px;
      letter-spacing: .2px;
      color: var(--blue-900);
    }

    .hr{
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .muted{ color: var(--muted); font-weight: 650; font-size: 12px; }

    /* Dashboard final */
    .final{
      display:none;
      grid-column: 1 / -1;
    }
    .final.show{ display:block; }

    .final-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .chart-wrap{
      padding: 12px;
    }

    /* Responsivo */
    @media (max-width: 1100px){
      .content{ grid-template-columns: 1fr; }
      .sidebar{ position: relative; height: auto; }
      .app{ grid-template-columns: 1fr; }
      .side-footer{ position: static; margin-top: 10px; }
      .final-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- ========================= SIDEBAR ========================= -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 2a10 10 0 0 0-3.16 19.49c.5.09.68-.22.68-.48v-1.7c-2.77.6-3.36-1.18-3.36-1.18-.46-1.17-1.12-1.48-1.12-1.48-.91-.62.07-.61.07-.61 1 .07 1.53 1.04 1.53 1.04.9 1.54 2.37 1.09 2.95.83.09-.66.35-1.09.64-1.34-2.21-.25-4.54-1.11-4.54-4.95 0-1.09.39-1.98 1.03-2.68-.1-.25-.45-1.27.1-2.65 0 0 .84-.27 2.75 1.02A9.6 9.6 0 0 1 12 6.8c.85 0 1.71.12 2.51.35 1.91-1.29 2.75-1.02 2.75-1.02.55 1.38.2 2.4.1 2.65.64.7 1.03 1.59 1.03 2.68 0 3.85-2.33 4.7-4.55 4.95.36.31.68.92.68 1.86v2.76c0 .26.18.58.69.48A10 10 0 0 0 12 2z"/>
          </svg>
        </div>
        <div>
          <h1>PQO Risco</h1>
          <small>Banco de Quest√µes ‚Ä¢ Simulador</small>
        </div>
      </div>

      <div class="side-section">
        <div class="side-title">Navega√ß√£o</div>
        <div class="nav">
          <button id="navSimulado" class="active" type="button">
            Simulado
            <span class="hint" id="navCount">0</span>
          </button>
          <button id="navDashboard" type="button">
            Dashboard final
            <span class="hint">üìä</span>
          </button>
        </div>
      </div>

      <div class="side-section">
        <div class="side-title">Prefer√™ncias</div>
        <div class="side-controls">
          <div class="toggle" title="Evita repetir quest√µes j√° feitas">
            N√£o repetir
            <div id="swNoRepeat" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
          <div class="toggle" title="Embaralha a ordem das quest√µes">
            Embaralhar
            <div id="swShuffle" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
        </div>

        <div class="side-controls" style="margin-top:10px;">
          <div class="toggle" title="Revela explica√ß√£o ap√≥s confirmar a resposta">
            Mostrar explica√ß√£o
            <div id="swExplain" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
          <div class="toggle" title="Modo prova (60 quest√µes)">
            Modo prova (60)
            <div id="swExam" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
        </div>
      </div>

      <div class="side-footer">
        <div class="pill">
          <div>
            <strong>Progresso</strong>
            <div class="mini" id="pillProgress">0 / 0</div>
          </div>
          <div class="mini" id="pillAccuracy">‚Äî</div>
        </div>
        <div class="pill">
          <div>
            <strong>Tempo</strong>
            <div class="mini" id="pillTime">00:00:00</div>
          </div>
          <div class="mini" id="pillMode">Treino</div>
        </div>
      </div>
    </aside>

    <!-- ========================= MAIN ========================= -->
    <main class="main">
      <header class="topbar">
        <div class="top-left">
          <div class="page-title">
            <strong id="topTitle">Simulado</strong>
            <span id="topSub">Selecione os filtros e inicie. Seu resultado s√≥ aparece no final.</span>
          </div>
        </div>

        <div class="top-right">
          <div class="chip">Quest√µes: <b id="chipTotal">0</b></div>
          <div class="chip">Respondidas: <b id="chipDone">0</b></div>
          <div class="chip">Timer: <b id="chipTimer">00:00:00</b></div>

          <button class="btn primary" id="btnStart" type="button">Iniciar</button>
          <button class="btn" id="btnNext" type="button" disabled>Pr√≥xima</button>
          <button class="btn success" id="btnFinish" type="button" disabled>Finalizar</button>
          <button class="btn danger" id="btnResetHistory" type="button" title="Limpa hist√≥rico de 'n√£o repetir' e tentativas">Limpar hist√≥rico</button>
        </div>
      </header>

      <section class="content">

        <!-- Card principal: filtros + quest√£o -->
        <section class="card" id="cardMain">
          <div class="card-header">
            <div>
              <h2>Configura√ß√£o</h2>
              <div class="sub">Filtros por T√≠tulo (m√≥dulo), Cap√≠tulo, Tema e Dificuldade</div>
            </div>
            <div class="sub" id="dbInfo">Base: 0 quest√µes</div>
          </div>

          <div class="card-body">
            <div class="filters">
              <div class="field">
                <label for="selModule">T√≠tulo (M√≥dulo)</label>
                <select id="selModule"></select>
              </div>
              <div class="field">
                <label for="selChapter">Cap√≠tulo</label>
                <select id="selChapter"></select>
              </div>

              <div class="field">
                <label for="selTheme">Tema</label>
                <select id="selTheme"></select>
              </div>
              <div class="field">
                <label for="selLevel">Dificuldade</label>
                <select id="selLevel"></select>
              </div>

              <div class="field" style="grid-column: 1 / -1;">
                <label for="searchText">Busca (texto livre)</label>
                <input id="searchText" type="text" placeholder="Ex.: margem, CCP, nova√ß√£o, op√ß√µes, ICVM..." />
              </div>
            </div>

            <div class="inline-actions">
              <button class="btn" id="btnApply" type="button">Aplicar filtros</button>
              <button class="btn" id="btnClearFilters" type="button">Limpar filtros</button>
            </div>

            <div class="hr"></div>

            <!-- Quest√£o -->
            <div id="questionArea" style="display:none;">
              <div class="q-meta" id="qMeta"></div>
              <h3 class="q-title" id="qTitle"></h3>
              <p class="q-text" id="qText"></p>

              <div class="options" id="qOptions"></div>

              <div class="result-row">
                <span class="status neutral" id="qStatus">Selecione uma alternativa.</span>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="btnConfirm" type="button" disabled>Confirmar resposta</button>
                  <button class="btn" id="btnShowExplain" type="button" disabled>Ver explica√ß√£o</button>
                </div>
              </div>

              <div class="explain" id="qExplain"></div>
              <div class="muted" id="qHint" style="margin-top:10px;"></div>
            </div>
          </div>
        </section>

        <!-- Card lateral: KPIs r√°pidos -->
        <aside class="card side-card">
          <div class="card-header">
            <div>
              <h2>Resumo</h2>
              <div class="sub">Acompanhe sem spoiler (sem ‚Äúacertos‚Äù no meio)</div>
            </div>
          </div>
          <div class="card-body">
            <div class="mini-grid">
              <div class="kpi">
                <div class="lbl">No modo</div>
                <div class="val" id="kpiMode">Treino</div>
              </div>
              <div class="kpi">
                <div class="lbl">Qtd. quest√µes</div>
                <div class="val" id="kpiTotal">0</div>
              </div>
              <div class="kpi">
                <div class="lbl">Respondidas</div>
                <div class="val" id="kpiAnswered">0</div>
              </div>
              <div class="kpi">
                <div class="lbl">Restantes</div>
                <div class="val" id="kpiRemaining">0</div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="muted">
              ‚Ä¢ ‚ÄúN√£o repetir‚Äù usa hist√≥rico local do navegador.<br/>
              ‚Ä¢ Resultado (acertos/erros) aparece somente no <b>Dashboard final</b>.<br/>
              ‚Ä¢ Se quiser simular a prova: ative <b>Modo prova (60)</b>.
            </div>
          </div>
        </aside>

        <!-- Dashboard Final -->
        <section class="final" id="finalSection">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>Dashboard final</h2>
                <div class="sub">Tempo, taxa de acerto, total de quest√µes e acertos por m√≥dulo/tema</div>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btnReviewWrong" type="button">Refazer erradas</button>
                <button class="btn" id="btnExportJson" type="button">Exportar resultado (JSON)</button>
              </div>
            </div>

            <div class="card-body">
              <div class="final-grid">
                <div class="card" style="box-shadow:none;">
                  <div class="card-header">
                    <div>
                      <h2>KPIs</h2>
                      <div class="sub">Vis√£o geral do simulado</div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="mini-grid">
                      <div class="kpi">
                        <div class="lbl">Dura√ß√£o</div>
                        <div class="val" id="finalTime">00:00:00</div>
                      </div>
                      <div class="kpi">
                        <div class="lbl">Taxa de acerto</div>
                        <div class="val" id="finalAcc">0%</div>
                      </div>
                      <div class="kpi">
                        <div class="lbl">Quantidade</div>
                        <div class="val" id="finalQtd">0</div>
                      </div>
                      <div class="kpi">
                        <div class="lbl">Acertos</div>
                        <div class="val" id="finalHits">0/0</div>
                      </div>
                    </div>
                    <div class="hr"></div>
                    <div class="muted" id="finalNotes"></div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none;">
                  <div class="card-header">
                    <div>
                      <h2>Acertos por M√≥dulo/Tema</h2>
                      <div class="sub">Barras em quantidade (acertos)</div>
                    </div>
                  </div>
                  <div class="card-body chart-wrap">
                    <canvas id="chartByModule"></canvas>
                    <div class="muted" style="margin-top:10px;">
                      Dica: use os filtros na pr√≥xima rodada para treinar exatamente onde estiver errando.
                    </div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none; grid-column: 1 / -1;">
                  <div class="card-header">
                    <div>
                      <h2>Detalhamento</h2>
                      <div class="sub">Lista resumida das quest√µes erradas (para revis√£o r√°pida)</div>
                    </div>
                  </div>
                  <div class="card-body" id="wrongList"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </section>
    </main>
  </div>

  <!-- =================================================================================
       BANCO DE QUEST√ïES (EMBUTIDO)
       Cole aqui o SEU JSON completo (700k chars ok).
       O formato esperado por quest√£o:
       {
         "id": "Q....",
         "module": "T√≠tulo ...",
         "chapter": "Cap√≠tulo ...",
         "theme": "Tema ...",
         "level": "F√°cil|M√©dio|Dif√≠cil",
         "q": "enunciado",
         "options": { "A":"...", "B":"...", "C":"...", "D":"..." },
         "answer": "A|B|C|D",
         "explain": "explica√ß√£o"
       }
  ================================================================================== -->
  <script id="QUESTIONS_DB" type="application/json">
  [
    {
      "id": "Q199544304",
      "module": "T√≠tulo II ‚Äì Mercados de bolsa e de balc√£o",
      "chapter": "Cap√≠tulo II ‚Äì Mercado de derivativos",
      "theme": "Resultado em Op√ß√µes - Lan√ßador Put",
      "level": "M√©dio",
      "q": "Um determinado investidor faz o lan√ßamento de uma PUT descoberta conforme dados abaixo:\\nPUT Pr√™mio: 1,20 Pre√ßo Exerc√≠cio: R$ 20,00 Pre√ßo de Mercado no Vencimento: R$ 25,00\\nNessa situa√ß√£o, qual ser√° o resultado financeiro dessa opera√ß√£o para esse lan√ßador:",
      "options": {
        "A": "‚Äì R$ 3,80",
        "B": "‚Äì R$ 1,20",
        "C": "+ R$ 3,80",
        "D": "+ R$ 1,20"
      },
      "answer": "D",
      "explain": "Lan√ßador de put recebe pr√™mio (R$ 1,20). No vencimento, pre√ßo (R$ 25) > pre√ßo de exerc√≠cio (R$ 20), a put n√£o √© exercida. Resultado do lan√ßador = pr√™mio recebido: +R$ 1,20."
    }
  ]
  </script>

  <script>
    ;(() => {
      /* =========================
         Helpers
      ========================== */
      const $ = (id) => document.getElementById(id);
      const fmtTime = (ms) => {
        const total = Math.max(0, Math.floor(ms/1000));
        const h = String(Math.floor(total/3600)).padStart(2,'0');
        const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
        const s = String(total%60).padStart(2,'0');
        return `${h}:${m}:${s}`;
      };
      const uniq = (arr) => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      const safeText = (v) => (v ?? '').toString();

      function normalizeStr(s){
        return safeText(s).toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      }

      function shuffle(arr){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [a[i],a[j]]=[a[j],a[i]];
        }
        return a;
      }

      /* =========================
         Estado + Storage
      ========================== */
      const LS_KEY = "pqo_risco_state_v2";
      const LS_HIST = "pqo_risco_history_v2"; // ids j√° vistos (n√£o repetir)
      const LS_ATT  = "pqo_risco_attempts_v2"; // tentativas/respostas

      const state = {
        all: [],
        filtered: [],
        queue: [],
        idx: 0,
        started: false,
        startAt: null,
        elapsedMs: 0,
        timerId: null,

        // settings
        noRepeat: false,
        shuffle: true,
        showExplain: true,
        examMode: false,

        // current
        current: null,
        selected: null,
        confirmed: false,

        // results
        answers: [] // {id, module, chapter, theme, level, selected, correct, ts}
      };

      function loadPrefs(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return;
          const p = JSON.parse(raw);
          state.noRepeat = !!p.noRepeat;
          state.shuffle = p.shuffle !== false;
          state.showExplain = p.showExplain !== false;
          state.examMode = !!p.examMode;
        }catch{}
      }

      function savePrefs(){
        const p = {
          noRepeat: state.noRepeat,
          shuffle: state.shuffle,
          showExplain: state.showExplain,
          examMode: state.examMode
        };
        localStorage.setItem(LS_KEY, JSON.stringify(p));
      }

      function getHistorySet(){
        try{
          return new Set(JSON.parse(localStorage.getItem(LS_HIST) || "[]"));
        }catch{
          return new Set();
        }
      }
      function addToHistory(id){
        const s = getHistorySet();
        s.add(id);
        localStorage.setItem(LS_HIST, JSON.stringify([...s]));
      }
      function clearHistory(){
        localStorage.removeItem(LS_HIST);
        localStorage.removeItem(LS_ATT);
      }
      function saveAttempts(){
        localStorage.setItem(LS_ATT, JSON.stringify(state.answers));
      }

      /* =========================
         DB
      ========================== */
      function loadDb(){
        const raw = $("QUESTIONS_DB").textContent.trim();
        let data = [];
        try{
          data = JSON.parse(raw);
        }catch(err){
          alert("Erro ao ler o JSON embutido. Verifique se o JSON est√° v√°lido.\n\nDica: use aspas duplas e evite v√≠rgula sobrando.");
          data = [];
        }

        // saneamento m√≠nimo
        data = (Array.isArray(data) ? data : []).map(q => ({
          id: safeText(q.id),
          module: safeText(q.module),
          chapter: safeText(q.chapter),
          theme: safeText(q.theme),
          level: safeText(q.level),
          q: safeText(q.q),
          options: q.options || {},
          answer: safeText(q.answer).trim().toUpperCase(),
          explain: safeText(q.explain)
        })).filter(q => q.id && q.q && q.options && q.answer);

        state.all = data;
        state.filtered = data.slice();
        updateDbInfo();
      }

      /* =========================
         UI - Switches
      ========================== */
      function setSwitch(el, on){
        el.classList.toggle("on", !!on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      }
      function bindSwitch(el, getter, setter){
        const toggle = () => {
          setter(!getter());
          setSwitch(el, getter());
          savePrefs();
          refreshModeBadges();
        };
        el.addEventListener("click", toggle);
        el.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(); }
        });
      }

      /* =========================
         UI - Filtros
      ========================== */
      function fillSelect(sel, values, placeholder){
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = placeholder;
        sel.appendChild(opt0);

        values.forEach(v => {
          const op = document.createElement("option");
          op.value = v;
          op.textContent = v;
          sel.appendChild(op);
        });
      }

      function buildFilterOptions(){
        const modules = uniq(state.all.map(x=>x.module));
        const chapters = uniq(state.all.map(x=>x.chapter));
        const themes = uniq(state.all.map(x=>x.theme));
        const levels = uniq(state.all.map(x=>x.level));

        fillSelect($("selModule"), modules, "Todos");
        fillSelect($("selChapter"), chapters, "Todos");
        fillSelect($("selTheme"), themes, "Todos");
        fillSelect($("selLevel"), levels, "Todas");
      }

      function applyFilters(){
        const m = $("selModule").value;
        const c = $("selChapter").value;
        const t = $("selTheme").value;
        const l = $("selLevel").value;
        const s = normalizeStr($("searchText").value);

        const hist = getHistorySet();

        let base = state.all.filter(q => {
          if(m && q.module !== m) return false;
          if(c && q.chapter !== c) return false;
          if(t && q.theme !== t) return false;
          if(l && q.level !== l) return false;
          if(s){
            const blob = normalizeStr([q.id,q.module,q.chapter,q.theme,q.level,q.q,
              q.options?.A,q.options?.B,q.options?.C,q.options?.D,q.explain].join(" "));
            if(!blob.includes(s)) return false;
          }
          if(state.noRepeat && hist.has(q.id)) return false;
          return true;
        });

        state.filtered = base;

        // monta fila
        state.queue = state.shuffle ? shuffle(base) : base.slice();

        // modo prova = 60 (se tiver menos, usa o que tem)
        if(state.examMode){
          state.queue = state.queue.slice(0, 60);
        }

        state.idx = 0;
        state.current = null;
        state.selected = null;
        state.confirmed = false;
        state.answers = [];

        updateDbInfo();
        updateCounts();
        renderQuestion(null);
        disableQuizControls(true);

        $("questionArea").style.display = "none";
        $("btnStart").disabled = state.queue.length === 0;

        // Ajuste textos topo
        $("topTitle").textContent = "Simulado";
        $("topSub").textContent = state.queue.length
          ? "Clique em Iniciar para come√ßar. O resultado aparece no Dashboard final."
          : "Nenhuma quest√£o encontrada com esses filtros (ou todas j√° foram feitas com ‚ÄúN√£o repetir‚Äù).";
      }

      function clearFilters(){
        $("selModule").value = "";
        $("selChapter").value = "";
        $("selTheme").value = "";
        $("selLevel").value = "";
        $("searchText").value = "";
        applyFilters();
      }

      /* =========================
         UI - Quest√£o
      ========================== */
      function disableQuizControls(disabled){
        $("btnNext").disabled = disabled;
        $("btnFinish").disabled = disabled;
        $("btnConfirm").disabled = disabled;
        $("btnShowExplain").disabled = disabled;
      }

      function renderQuestion(q){
        const area = $("questionArea");
        if(!q){
          area.style.display = "none";
          $("qMeta").innerHTML = "";
          $("qTitle").textContent = "";
          $("qText").textContent = "";
          $("qOptions").innerHTML = "";
          $("qExplain").textContent = "";
          $("qExplain").classList.remove("show");
          $("qStatus").textContent = "Selecione uma alternativa.";
          $("qStatus").className = "status neutral";
          $("qHint").textContent = "";
          return;
        }

        area.style.display = "";
        $("qExplain").classList.remove("show");
        $("qExplain").textContent = safeText(q.explain || "");

        $("qMeta").innerHTML = "";
        const mkTag = (txt, cls="") => {
          const s = document.createElement("span");
          s.className = `tag ${cls}`.trim();
          s.textContent = txt;
          return s;
        };
        $("qMeta").appendChild(mkTag(q.module || "Sem m√≥dulo"));
        $("qMeta").appendChild(mkTag(q.chapter || "Sem cap√≠tulo","gray"));
        $("qMeta").appendChild(mkTag(q.theme || "Sem tema","gray"));
        $("qMeta").appendChild(mkTag(q.level || "N√≠vel","green"));

        $("qTitle").textContent = `Quest√£o ${state.idx + 1} de ${state.queue.length}`;
        $("qText").textContent = safeText(q.q);

        const opts = $("qOptions");
        opts.innerHTML = "";

        state.selected = null;
        state.confirmed = false;

        const letters = ["A","B","C","D","E"];
        letters.forEach(L => {
          if(q.options && q.options[L] != null && safeText(q.options[L]).trim() !== ""){
            const row = document.createElement("div");
            row.className = "opt";
            row.tabIndex = 0;

            const box = document.createElement("div");
            box.className = "letter";
            box.textContent = L;

            const txt = document.createElement("div");
            txt.className = "txt";
            txt.textContent = safeText(q.options[L]);

            row.appendChild(box);
            row.appendChild(txt);

            const selectThis = () => {
              if(state.confirmed) return;
              [...opts.querySelectorAll(".opt")].forEach(x => x.classList.remove("selected"));
              row.classList.add("selected");
              state.selected = L;
              $("qStatus").textContent = "Alternativa selecionada. Confirme para registrar.";
              $("qStatus").className = "status neutral";
              $("btnConfirm").disabled = false;
            };

            row.addEventListener("click", selectThis);
            row.addEventListener("keydown", (e) => {
              if(e.key === "Enter" || e.key === " "){
                e.preventDefault();
                selectThis();
              }
            });

            opts.appendChild(row);
          }
        });

        $("qStatus").textContent = "Selecione uma alternativa.";
        $("qStatus").className = "status neutral";
        $("btnConfirm").disabled = true;
        $("btnShowExplain").disabled = !state.showExplain;
        $("qHint").textContent = state.noRepeat
          ? "Dica: esta quest√£o ser√° marcada como ‚Äúfeita‚Äù no seu navegador ao confirmar."
          : "Dica: ative ‚ÄúN√£o repetir‚Äù para variar as quest√µes nas pr√≥ximas sess√µes.";
      }

      function confirmAnswer(){
        if(!state.current || !state.selected || state.confirmed) return;

        state.confirmed = true;

        // registra tentativa
        const q = state.current;
        const correct = (state.selected === q.answer);

        state.answers.push({
          id: q.id,
          module: q.module,
          chapter: q.chapter,
          theme: q.theme,
          level: q.level,
          selected: state.selected,
          correct,
          ts: Date.now()
        });

        addToHistory(q.id);
        saveAttempts();

        // UI: sem ‚Äúconsolidado‚Äù no meio, mas pode dar feedback m√≠nimo por quest√£o
        if(correct){
          $("qStatus").textContent = "Registrado.";
          $("qStatus").className = "status ok";
        }else{
          $("qStatus").textContent = "Registrado.";
          $("qStatus").className = "status bad";
        }

        if(state.showExplain){
          $("btnShowExplain").disabled = false;
        }

        $("btnNext").disabled = false;
        $("btnFinish").disabled = false;

        updateCounts();
      }

      function showExplain(){
        if(!state.current) return;
        $("qExplain").classList.toggle("show");
      }

      function nextQuestion(){
        if(!state.started) return;

        // se ainda n√£o confirmou, permite avan√ßar? (n√£o)
        if(!state.confirmed){
          $("qStatus").textContent = "Confirme a resposta antes de avan√ßar.";
          $("qStatus").className = "status neutral";
          return;
        }

        state.idx++;
        if(state.idx >= state.queue.length){
          finishQuiz();
          return;
        }

        state.current = state.queue[state.idx];
        renderQuestion(state.current);
        $("btnNext").disabled = true;
        $("btnFinish").disabled = false;
      }

      /* =========================
         Timer + Start/Finish
      ========================== */
      function tick(){
        state.elapsedMs = Date.now() - state.startAt;
        const t = fmtTime(state.elapsedMs);
        $("chipTimer").textContent = t;
        $("pillTime").textContent = t;
      }

      function startQuiz(){
        if(state.queue.length === 0) return;

        // reset
        state.started = true;
        state.idx = 0;
        state.current = state.queue[0];
        state.answers = [];
        state.startAt = Date.now();
        state.elapsedMs = 0;

        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(tick, 250);

        $("questionArea").style.display = "";
        renderQuestion(state.current);

        $("btnStart").disabled = true;
        $("btnNext").disabled = true;
        $("btnFinish").disabled = false;

        $("topTitle").textContent = "Simulado em andamento";
        $("topSub").textContent = "Sem spoiler: acertos e taxa aparecem apenas no Dashboard final.";

        updateCounts();
        refreshModeBadges();
      }

      function finishQuiz(){
        if(!state.started) return;

        // se terminou sem confirmar a √∫ltima, n√£o obriga ‚Äî MAS o requisito era:
        // "sempre que eu finalizar a prova... ele deve corrigir no final"
        // Ent√£o, se ainda n√£o confirmou a √∫ltima, a gente simplesmente encerra sem registrar essa quest√£o.
        // (Melhor UX: n√£o inventar resposta.) Se quiser obrigar, podemos bloquear finish.
        clearInterval(state.timerId);
        state.timerId = null;

        state.started = false;

        buildFinalDashboard();
        goDashboard();
      }

      /* =========================
         Dashboard Final
      ========================== */
      let chartRef = null;

      function buildFinalDashboard(){
        const total = state.queue.length;
        const answered = state.answers.length;
        const hits = state.answers.filter(x=>x.correct).length;
        const acc = total ? Math.round((hits/total)*100) : 0;

        $("finalTime").textContent = fmtTime(state.elapsedMs);
        $("finalAcc").textContent = `${acc}%`;
        $("finalQtd").textContent = String(total);
        $("finalHits").textContent = `${hits}/${total}`;

        const notes = [];
        notes.push(`Respondidas: ${answered}/${total}.`);
        if(answered < total) notes.push(`Voc√™ finalizou antes de responder todas as quest√µes.`);
        notes.push(`Modo: ${state.examMode ? "Prova (60)" : "Treino"}.`);
        $("finalNotes").textContent = notes.join(" ");

        // erradas
        const wrong = state.answers.filter(x=>!x.correct);
        const wrongBox = $("wrongList");
        wrongBox.innerHTML = "";
        if(!wrong.length){
          wrongBox.innerHTML = `<div class="muted">Nenhuma errada üéâ</div>`;
        }else{
          const ul = document.createElement("ul");
          ul.style.margin = "0";
          ul.style.paddingLeft = "18px";
          ul.style.lineHeight = "1.5";

          wrong.slice(0, 150).forEach(w => {
            const li = document.createElement("li");
            li.innerHTML = `<b>${w.id}</b> ‚Äî ${safeText(w.module)} ‚Ä¢ ${safeText(w.theme)} (marcou ${w.selected}, gabarito correto)`;
            ul.appendChild(li);
          });
          wrongBox.appendChild(ul);
          if(wrong.length > 150){
            const more = document.createElement("div");
            more.className = "muted";
            more.style.marginTop = "10px";
            more.textContent = `+ ${wrong.length - 150} itens ocultos para n√£o poluir a tela.`;
            wrongBox.appendChild(more);
          }
        }

        // chart por m√≥dulo/tema (agrupa: "M√≥dulo ‚Äî Tema")
        const map = new Map();
        state.answers.forEach(a => {
          const key = `${a.module} ‚Äî ${a.theme}`;
          const cur = map.get(key) || {hits:0,total:0};
          cur.total += 1;
          if(a.correct) cur.hits += 1;
          map.set(key, cur);
        });

        // ordena por total desc
        const entries = [...map.entries()].sort((a,b)=>b[1].total - a[1].total);
        const labels = entries.map(e=>e[0]);
        const dataHits = entries.map(e=>e[1].hits);

        const ctx = $("chartByModule").getContext("2d");
        if(chartRef) chartRef.destroy();
        chartRef = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Acertos",
              data: dataHits
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true }
            },
            scales: {
              x: { ticks: { maxRotation: 60, minRotation: 0 } },
              y: { beginAtZero: true, precision: 0 }
            }
          }
        });

        // Ajuste altura canvas (pra n√£o ficar esmagado)
        $("chartByModule").parentElement.style.height = Math.max(320, 42 * Math.min(labels.length, 10)) + "px";
      }

      function goSimulado(){
        $("finalSection").classList.remove("show");
        $("cardMain").style.display = "";
        $("navSimulado").classList.add("active");
        $("navDashboard").classList.remove("active");

        $("topTitle").textContent = "Simulado";
        $("topSub").textContent = "Selecione os filtros e inicie. Seu resultado s√≥ aparece no final.";
      }

      function goDashboard(){
        $("finalSection").classList.add("show");
        $("cardMain").style.display = "none";
        $("navDashboard").classList.add("active");
        $("navSimulado").classList.remove("active");

        $("topTitle").textContent = "Dashboard final";
        $("topSub").textContent = "Veja seu desempenho e revise os pontos fracos por m√≥dulo/tema.";
      }

      function reviewWrong(){
        // monta fila com erradas (usando a base carregada)
        const wrongIds = new Set(state.answers.filter(x=>!x.correct).map(x=>x.id));
        const wrongQs = state.all.filter(q => wrongIds.has(q.id));
        state.queue = state.shuffle ? shuffle(wrongQs) : wrongQs.slice();
        state.idx = 0;
        state.current = null;
        state.answers = [];
        state.started = false;
        state.startAt = null;
        state.elapsedMs = 0;

        updateCounts();
        goSimulado();
        renderQuestion(null);
        $("questionArea").style.display = "none";
        $("btnStart").disabled = state.queue.length === 0;

        $("topTitle").textContent = "Revis√£o das erradas";
        $("topSub").textContent = state.queue.length
          ? "Clique em Iniciar para refazer apenas as quest√µes erradas."
          : "Sem quest√µes erradas para revisar.";
      }

      function exportResultJson(){
        const payload = {
          generatedAt: new Date().toISOString(),
          durationMs: state.elapsedMs,
          totalQuestions: state.queue.length,
          answers: state.answers
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "resultado_pqo_risco.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }

      /* =========================
         Counters / Badges
      ========================== */
      function updateDbInfo(){
        $("dbInfo").textContent = `Base: ${state.all.length} quest√µes ‚Ä¢ Filtro atual: ${state.filtered.length}`;
        $("navCount").textContent = String(state.filtered.length);
      }

      function updateCounts(){
        const total = state.queue.length;
        const done = state.answers.length;

        $("chipTotal").textContent = String(total);
        $("chipDone").textContent = String(done);

        $("kpiTotal").textContent = String(total);
        $("kpiAnswered").textContent = String(done);
        $("kpiRemaining").textContent = String(Math.max(0, total - done));

        $("pillProgress").textContent = `${done} / ${total}`;
        // sem revelar acertos durante a prova: s√≥ mostra ‚Äú‚Äî‚Äù at√© terminar
        $("pillAccuracy").textContent = state.started ? "‚Äî" : (total ? "‚Äî" : "‚Äî");
      }

      function refreshModeBadges(){
        $("kpiMode").textContent = state.examMode ? "Prova" : "Treino";
        $("pillMode").textContent = state.examMode ? "Prova (60)" : "Treino";
      }

      /* =========================
         Bind events
      ========================== */
      function bind(){
        // switches
        bindSwitch($("swNoRepeat"), () => state.noRepeat, v => state.noRepeat = v);
        bindSwitch($("swShuffle"), () => state.shuffle, v => state.shuffle = v);
        bindSwitch($("swExplain"), () => state.showExplain, v => state.showExplain = v);
        bindSwitch($("swExam"), () => state.examMode, v => state.examMode = v);

        // nav
        $("navSimulado").addEventListener("click", goSimulado);
        $("navDashboard").addEventListener("click", () => {
          if(!$("finalSection").classList.contains("show")){
            // se n√£o tem dashboard ainda, s√≥ vai se tiver algo respondido
            if(state.answers.length){
              buildFinalDashboard();
              goDashboard();
            }else{
              alert("Finalize um simulado (ou responda ao menos 1 quest√£o) para ver o Dashboard final.");
            }
          }
        });

        // filtros
        $("btnApply").addEventListener("click", applyFilters);
        $("btnClearFilters").addEventListener("click", clearFilters);

        // a√ß√µes
        $("btnStart").addEventListener("click", startQuiz);
        $("btnConfirm").addEventListener("click", confirmAnswer);
        $("btnShowExplain").addEventListener("click", showExplain);
        $("btnNext").addEventListener("click", nextQuestion);
        $("btnFinish").addEventListener("click", finishQuiz);

        $("btnResetHistory").addEventListener("click", () => {
          if(confirm("Tem certeza que deseja limpar o hist√≥rico local (n√£o repetir + tentativas)?")){
            clearHistory();
            applyFilters();
            alert("Hist√≥rico limpo.");
          }
        });

        // dashboard
        $("btnReviewWrong").addEventListener("click", reviewWrong);
        $("btnExportJson").addEventListener("click", exportResultJson);

        // melhora UX: aplicar filtros ao mudar select (opcional e leve)
        ["selModule","selChapter","selTheme","selLevel"].forEach(id => {
          $(id).addEventListener("change", () => {
            // s√≥ atualiza a fila ao clicar em Aplicar, para n√£o ‚Äúpiscar‚Äù (UX)
          });
        });

        // enter no search
        $("searchText").addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            applyFilters();
          }
        });
      }

      /* =========================
         Boot
      ========================== */
      function boot(){
        loadPrefs();
        setSwitch($("swNoRepeat"), state.noRepeat);
        setSwitch($("swShuffle"), state.shuffle);
        setSwitch($("swExplain"), state.showExplain);
        setSwitch($("swExam"), state.examMode);

        loadDb();
        buildFilterOptions();
        refreshModeBadges();
        applyFilters(); // monta fila inicial

        updateCounts();
        tick(); // timer 00:00:00
        bind();

        // Ajuste dos bot√µes iniciais
        $("btnStart").disabled = state.queue.length === 0;
        $("btnNext").disabled = true;
        $("btnFinish").disabled = true;

        $("topTitle").textContent = "Simulado";
        $("topSub").textContent = "Selecione os filtros e inicie. Seu resultado s√≥ aparece no final.";
      }

      // Override: quando inicia, mostrar quest√£o
      const _renderQuestion = renderQuestion;
      renderQuestion = function(q){
        _renderQuestion(q);
        if(q){
          $("questionArea").style.display = "";
        }
      };

      // Pequeno ajuste: ao iniciar, habilita area e bot√µes
      const _startQuiz = startQuiz;
      startQuiz = function(){
        _startQuiz();
        $("questionArea").style.display = "";
        disableQuizControls(false);
        $("btnNext").disabled = true; // s√≥ depois de confirmar
        $("btnConfirm").disabled = true;
        $("btnShowExplain").disabled = !state.showExplain;
        updateCounts();
      };

      // Quando muda filtros ap√≥s j√° ter respondido, for√ßa reset seguro
      const _applyFilters = applyFilters;
      applyFilters = function(){
        if(state.timerId){
          clearInterval(state.timerId);
          state.timerId = null;
        }
        state.started = false;
        $("chipTimer").textContent = "00:00:00";
        $("pillTime").textContent = "00:00:00";
        _applyFilters();
        refreshModeBadges();
        updateCounts();
      };

      boot();

      // Expor state no console (debug)
      window.__PQO = state;
    })();
  </script>
</body>
</html>
