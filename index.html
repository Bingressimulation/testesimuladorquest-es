<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PQO Risco — Simulador</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --b3-blue:#2f2e7d; --b3-blue-light:#3a38a8; --b3-green:#16a34a; --b3-red:#ef4444; --b3-yellow:#f59e0b; --b3-purple:#7c3aed;
      --bg:#f8fafc; --surface:#fff; --surface-2:#f1f5f9; --text:#0f172a; --muted:#64748b; --border:rgba(15,23,42,.08);
      --shadow:0 10px 25px rgba(15,23,42,.06); --radius:16px; --radius-sm:12px; --focus:0 0 0 4px rgba(47,46,125,.15);
    }
    body.dark{
      --bg:#0f172a; --surface:#1e293b; --surface-2:#334155; --text:#f1f5f9; --muted:#94a3b8; --border:rgba(241,245,249,.08);
      --shadow:0 10px 25px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    a{color:inherit;text-decoration:none}

    /* ===== HEADER MODERNO ===== */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 20px rgba(15, 23, 42, 0.05);
      transition: all 0.3s ease;
    }

    body.dark header {
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid rgba(241, 245, 249, 0.1);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 16px;
    }

    /* Primeira linha */
    .topline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 200px;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--b3-blue), var(--b3-purple));
      box-shadow: var(--shadow);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 950;
      font-size: 18px;
      transition: transform 0.2s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .brand-text h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 900;
      line-height: 1.2;
      letter-spacing: -0.2px;
    }

    .brand-text .sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      font-weight: 500;
    }

    /* Ações principais */
    .main-actions {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .header-btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .header-btn:hover {
      background: var(--surface-2);
      transform: translateY(-2px);
      border-color: var(--b3-blue);
      box-shadow: 0 4px 12px rgba(47, 46, 125, 0.1);
    }

    .header-btn i {
      font-size: 14px;
      opacity: 0.8;
    }

    .header-btn .btn-label {
      display: inline-block;
    }

    @media (max-width: 768px) {
      .header-btn .btn-label {
        display: none;
      }
      .header-btn {
        padding: 10px;
      }
    }

    /* Ações do usuário */
    .user-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 8px;
      background: rgba(47, 46, 125, 0.08);
      border: 1px solid rgba(47, 46, 125, 0.2);
      color: var(--b3-blue);
      font-size: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 80px;
    }

    .theme-toggle, .user-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover, .user-btn:hover {
      background: var(--surface-2);
      transform: translateY(-2px);
    }

    /* Segunda linha */
    .status-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-top: 1px solid rgba(15, 23, 42, 0.05);
    }

    body.dark .status-line {
      border-top: 1px solid rgba(241, 245, 249, 0.05);
    }

    .stats {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .stat-item i {
      font-size: 13px;
    }

    .stat-item strong {
      color: var(--text);
      font-weight: 800;
    }

    #statusPill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: var(--b3-green);
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #timerBadge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .home-btn {
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .home-btn:hover {
      background: var(--surface-2);
      border-color: var(--b3-blue);
    }

    /* Barra de progresso */
    .progress-row {
      margin-top: 12px;
      display: none;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
    }

    .progress {
      height: 6px;
      border-radius: 999px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--b3-blue), var(--b3-purple));
      transition: width 0.3s ease;
      border-radius: 999px;
    }

    /* Responsividade */
    @media (max-width: 640px) {
      .topline {
        flex-wrap: wrap;
      }
      
      .brand {
        min-width: unset;
      }
      
      .main-actions {
        order: 3;
        width: 100%;
        justify-content: space-between;
        margin-top: 8px;
      }
      
      .status-line {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      
      .stats {
        justify-content: space-between;
      }
    }

    /* Switch (mantido para o tema) */
    .switch{position:relative;display:inline-block;width:46px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:var(--surface-2);border:1px solid var(--border);transition:.25s;border-radius:999px}
    .slider:before{content:"";position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:var(--text);transition:.25s;border-radius:50%}
    input:checked + .slider{background:var(--b3-blue);border-color:var(--b3-blue)}
    input:checked + .slider:before{transform:translateX(22px);background:#fff}

    main{max-width:1200px;margin:0 auto;padding:22px 16px 42px}
    .view{display:none}
    .view.active{display:block}

    /* HOME */
    .home-head{display:flex;align-items:end;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .home-title{margin:0;font-size:22px;letter-spacing:-.2px}
    .home-sub{margin:6px 0 0 0;color:var(--muted);font-size:13px}
    .course-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:16px}
    .course-card{grid-column:span 4;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:transform .15s ease, filter .15s ease;min-height:220px;display:flex;flex-direction:column}
    .course-card:hover{transform:translateY(-3px);filter:brightness(.99)}
    .course-hero{height:120px;background:linear-gradient(135deg,rgba(47,46,125,.9),rgba(124,58,237,.75));position:relative;display:grid;place-items:center}
    .course-hero .badge{position:absolute;top:12px;left:12px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:850;display:inline-flex;gap:8px;align-items:center}
    .course-hero .big{color:#fff;font-weight:950;font-size:34px;letter-spacing:1px;opacity:.9}
    .course-body{padding:14px 14px 16px;display:flex;flex-direction:column;gap:8px;flex:1}
    .course-body h3{margin:0;font-size:15px}
    .course-body p{margin:0;color:var(--muted);font-size:13px}
    .course-footer{padding:12px 14px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-top:1px solid var(--border);background:rgba(241,245,249,.5)}
    body.dark .course-footer{background:rgba(51,65,85,.25)}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:12px;display:inline-flex;align-items:center;gap:8px}

    @media(max-width:1024px){.course-card{grid-column:span 6}}
    @media(max-width:640px){.course-card{grid-column:span 12}}

    /* EXAM */
    .exam-shell{display:grid;grid-template-columns:1fr;gap:16px;align-items:start}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .q-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .tag{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2);color:var(--muted);font-size:12px;font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .tag-primary{background:rgba(47,46,125,.10);color:var(--b3-blue);border-color:rgba(47,46,125,.22)}
    .tag-success{background:rgba(34,197,94,.10);color:var(--b3-green);border-color:rgba(34,197,94,.22)}
    .tag-danger{background:rgba(239,68,68,.10);color:var(--b3-red);border-color:rgba(239,68,68,.22)}
    .q-title{margin:0 0 10px 0;font-size:20px;line-height:1.35;font-weight:900;letter-spacing:-.2px}
    .q-instructions{margin:0 0 18px 0;font-size:13px;color:var(--muted)}

    .options{margin:16px 0}
    .option{
      display:grid;grid-template-columns:22px 40px 1fr 28px;gap:12px;align-items:center;
      padding:14px 16px;border-radius:14px;border:1px solid rgba(15,23,42,.10);
      background:#f3f6fb;cursor:pointer;transition:all .14s ease;margin-bottom:10px;position:relative
    }
    body.dark .option{background:rgba(51,65,85,.35);border-color:rgba(241,245,249,.08)}
    .option:hover{border-color:var(--b3-blue);background:var(--surface);transform:translateY(-1px);box-shadow:0 4px 12px rgba(15,23,42,.05)}
    .option.selected{border-color:var(--b3-blue);background:rgba(47,46,125,.06);box-shadow:0 0 0 1px var(--b3-blue)}
    .option.correct{border-color:rgba(34,197,94,.45)!important;background:rgba(34,197,94,.12)!important}
    .option.incorrect{border-color:rgba(239,68,68,.45)!important;background:rgba(239,68,68,.12)!important}
    .option.locked{cursor:default;transform:none!important;box-shadow:none!important}
    .option input{margin:0;transform:scale(1.05)}
    .option-letter{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-weight:950;font-size:13px;background:#e7e9ff;color:#3b3aa8}
    .option.selected .option-letter{background:var(--b3-blue);color:#fff}
    .option-text{font-size:14px;line-height:1.45;text-align:left}
    
    /* Estilos para o botão de desconsiderar questão */
    .option-dismiss {
      width:28px;height:28px;border-radius:50%;display:grid;place-items:center;
      background:var(--surface-2);border:1px solid var(--border);color:var(--muted);
      cursor:pointer;transition:all .12s ease;flex-shrink:0;margin-left:auto
    }
    .option-dismiss:hover {
      background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);
      color:var(--b3-red);transform:scale(1.05)
    }
    .option-dismiss:active{transform:scale(0.95)}
    .option.dismissed {
      opacity:0.6;filter:grayscale(0.7);background:repeating-linear-gradient(
        45deg,transparent,transparent 10px,rgba(239,68,68,0.03) 10px,rgba(239,68,68,0.03) 20px
      );border-color:rgba(239,68,68,0.2);border-style:dashed;position:relative
    }
    .option.dismissed::before {
      content:"DESCONSIDERADA";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      background:var(--b3-red);color:white;padding:4px 8px;border-radius:4px;font-size:10px;
      font-weight:800;letter-spacing:0.5px;z-index:2;opacity:0.9;white-space:nowrap
    }
    .option.dismissed .option-letter{background:var(--surface-2)!important;color:var(--muted)!important}
    .option.dismissed .option-text{color:var(--muted);text-decoration:line-through}
    .option.dismissed:hover::before{opacity:0}
    .dismiss-undo {
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      background:var(--b3-blue);color:white;padding:4px 8px;border-radius:4px;font-size:10px;
      font-weight:800;cursor:pointer;z-index:3;opacity:0;transition:opacity .2s ease;white-space:nowrap
    }
    .option.dismissed:hover .dismiss-undo{opacity:1}

    @media(max-width:520px){
      .option{grid-template-columns:22px 34px 1fr 28px;padding:12px 12px;gap:8px}
    }

    .feedback{margin-top:18px;padding:18px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface-2);display:none}
    .feedback.show{display:block}
    .feedback.correct{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.06)}
    .feedback.incorrect{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.06)}
    .feedback-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-weight:950}
    .feedback-tags{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .feedback-body{font-size:14px;line-height:1.55}
    .explanation{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:14px}

    .action-bar{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}
    .action-bar .group{display:flex;gap:10px;flex-wrap:wrap}

    button{
      padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface);cursor:pointer;font-weight:900;font-size:14px;color:var(--text);
      transition:all .13s ease;font-family:Inter,sans-serif;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-width:120px
    }
    button:hover:not(:disabled){filter:brightness(.97);transform:translateY(-1px)}
    button:active:not(:disabled){transform:translateY(0)}
    button:focus{box-shadow:var(--focus);outline:none}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(135deg,var(--b3-blue),var(--b3-blue-light));border-color:transparent;color:#fff}
    .btn-success{background:linear-gradient(135deg,var(--b3-green),#22c55e);border-color:transparent;color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--b3-red),#fb7185);border-color:transparent;color:#fff}
    .btn-ghost{background:transparent}
    .small{font-size:12px;color:var(--muted);margin-top:12px}

    /* Dashboard */
    .dashboard{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin:14px 0 20px}
    @media(max-width:860px){.dashboard{grid-template-columns:1fr}}
    .results-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:14px}
    .result-card{padding:16px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--border);text-align:center}
    .result-value{font-size:28px;font-weight:950;margin-bottom:6px;letter-spacing:-.3px}
    .result-label{font-size:12px;color:var(--muted);font-weight:850}
    .chart-container{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;height:320px;position:relative}
    .review-item{border:1px solid var(--border);border-radius:var(--radius);padding:14px;background:var(--surface);margin-top:10px;cursor:pointer;transition:transform .15s ease}
    .review-item:hover{transform:translateY(-2px);border-color:rgba(47,46,125,.25)}
    .review-header{display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--muted);font-size:12px;margin-bottom:8px}
    .review-question{color:var(--text);font-size:14px;line-height:1.4}
    .review-answer{margin-top:8px;font-size:13px;color:var(--muted)}
    .review-answer strong{color:var(--text)}

    /* Notification */
    .notification{position:fixed;top:18px;right:18px;padding:12px 14px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow);
      display:flex;align-items:center;gap:10px;z-index:120;transform:translateX(120%);transition:transform .28s ease;max-width:360px}
    .notification.show{transform:translateX(0)}
    .notification i{font-size:18px}
    .notification-success{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.06)}
    .notification-error{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.06)}

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;z-index:110;padding:18px}
    .modal-backdrop.show{display:grid;place-items:center}
    .modal{width:min(980px,100%);max-height:90vh;overflow:auto;background:var(--surface);border:1px solid var(--border);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.35)}
    .modal-header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;z-index:1}
    .modal-header h3{margin:0;font-size:14px;font-weight:950;letter-spacing:-.2px}
    .modal-close{min-width:unset;width:40px;height:40px;padding:0;border-radius:12px}
    .modal-body{padding:16px}

    .panel{border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);padding:14px}
    .panel h4{margin:0 0 10px 0;font-size:13px;font-weight:950}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;font-weight:850}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);
      background:var(--surface);color:var(--text);outline:none;font-family:Inter,sans-serif;font-size:13px;transition:all .2s ease
    }
    textarea{min-height:120px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:var(--surface-2)}
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus);border-color:var(--b3-blue)}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row2{grid-template-columns:1fr}}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .hint{padding:10px 12px;border-radius:var(--radius-sm);background:var(--surface-2);border:1px dashed var(--border);color:var(--muted);font-size:12px;line-height:1.5}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:rgba(15,23,42,.08);padding:2px 6px;border-radius:6px;border:1px solid var(--border);font-size:12px;color:var(--text)}
    body.dark .kbd{background:rgba(241,245,249,.10)}

    .hidden-file{position:absolute;width:1px;height:1px;opacity:0;pointer-events:none}

    /* Manager list UX */
    .list{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .list-top{display:flex;gap:10px;padding:12px;border-bottom:1px solid var(--border);background:var(--surface-2);align-items:center;flex-wrap:wrap}
    .list-top input{flex:1;min-width:220px;background:var(--surface)}
    .list-body{padding:12px;display:grid;gap:10px}
    .qrow{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--surface);display:grid;gap:6px}
    .qrow .mini{display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .qrow .title{font-size:13px;color:var(--text);font-weight:850}
    .qrow .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .qrow .actions button{min-width:120px}

    /* Prova: distribuição custom */
    .pct-row{display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:center;margin-top:8px}
    .pct-row input{min-width:120px}
    .pct-total{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:12px;color:var(--muted);font-weight:850}
    .pct-total strong{color:var(--text)}
    .warn{color:var(--b3-red)}

    /* Arquivos PDF */
    .file-card{
      border:1px solid var(--border); border-radius:var(--radius); background:var(--surface);
      padding:16px; display:flex; align-items:center; gap:14px; cursor:pointer;
      transition:transform .15s ease, border-color .15s ease;
    }
    .file-card:hover{
      transform:translateY(-2px); border-color:rgba(239,68,68,.35);
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .file-icon{ width:48px; height:48px; border-radius:12px; background:linear-gradient(135deg, #ef4444, #f97316); 
      display:grid; place-items:center; color:#fff; font-size:20px; flex-shrink:0; }
    .file-info{ flex:1; min-width:0; }
    .file-name{ font-size:14px; font-weight:850; margin:0 0 4px 0; color:var(--text); }
    .file-meta{ font-size:12px; color:var(--muted); display:flex; gap:12px; flex-wrap:wrap; }
    .file-actions{ display:flex; gap:8px; flex-shrink:0; }
    .file-btn{ width:40px; height:40px; border-radius:10px; border:1px solid var(--border); 
      background:var(--surface-2); display:grid; place-items:center; cursor:pointer; 
      transition:all .12s ease; color:var(--text); }
    .file-btn:hover{ background:var(--surface); transform:translateY(-1px); }
    .file-btn.download:hover{ background:rgba(34,197,94,.1); border-color:rgba(34,197,94,.3); }
    .file-btn.delete:hover{ background:rgba(239,68,68,.1); border-color:rgba(239,68,68,.3); }

    /* Para visualização inline */
    .pdf-viewer{ width:100%; height:500px; border:1px solid var(--border); border-radius:var(--radius); 
      background:var(--surface-2); }
    .pdf-iframe{ width:100%; height:100%; border:none; border-radius:var(--radius); }

    /* Login modal */
    .login-form{ max-width:380px; margin:0 auto; }
    .login-logo{ width:60px; height:60px; margin:0 auto 16px; border-radius:16px; 
      background:linear-gradient(135deg, var(--b3-blue), var(--b3-purple));
      display:grid; place-items:center; color:#fff; font-size:24px; font-weight:950; }
    .login-title{ text-align:center; margin:0 0 8px 0; font-size:18px; }
    .login-sub{ text-align:center; color:var(--muted); font-size:13px; margin-bottom:24px; }
    .login-btn{ width:100%; margin-top:16px; }
    .logout-btn{ background:linear-gradient(135deg, #64748b, #475569); border-color:transparent; color:#fff; }

    /* DASHBOARD APERFEIÇOADO */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin: 20px 0;
    }

    .dashboard-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .card-lg { grid-column: span 8; }
    .card-md { grid-column: span 4; }
    .card-sm { grid-column: span 3; }
    .card-full { grid-column: span 12; }

    @media (max-width: 1024px) {
      .card-lg, .card-md, .card-sm { grid-column: span 12; }
    }

    /* Score cards */
    .score-card {
      text-align: center;
      padding: 24px 16px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--surface), var(--surface-2));
    }

    .score-value {
      font-size: 48px;
      font-weight: 950;
      line-height: 1;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }

    .score-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 850;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .score-desc {
      font-size: 12px;
      margin-top: 8px;
      color: var(--muted);
    }

    /* Performance rings */
    .ring-container {
      width: 120px;
      height: 120px;
      margin: 0 auto 16px;
      position: relative;
    }

    .ring-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--surface-2);
      border: 8px solid var(--surface-2);
    }

    .ring-progress {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 8px solid transparent;
      clip-path: inset(0 0 0 50%);
    }

    .ring-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      font-weight: 950;
      color: var(--text);
    }

    .ring-label {
      position: absolute;
      bottom: -24px;
      width: 100%;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }

    /* Heatmap */
    .heatmap {
      display: flex;
      gap: 4px;
      margin-top: 12px;
    }

    .heatmap-day {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: var(--surface-2);
      position: relative;
      cursor: help;
    }

    .heatmap-day[data-level="0"] { background: var(--surface-2); }
    .heatmap-day[data-level="1"] { background: rgba(34, 197, 94, 0.2); }
    .heatmap-day[data-level="2"] { background: rgba(34, 197, 94, 0.4); }
    .heatmap-day[data-level="3"] { background: rgba(34, 197, 94, 0.6); }
    .heatmap-day[data-level="4"] { background: rgba(34, 197, 94, 0.8); }
    .heatmap-day[data-level="5"] { background: rgba(34, 197, 94, 1); }

    /* Badges */
    .badge-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .badge-item {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 850;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-bronze {
      background: linear-gradient(135deg, #f59e0b20, #f59e0b10);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #f59e0b;
    }

    .badge-silver {
      background: linear-gradient(135deg, #94a3b820, #94a3b810);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #94a3b8;
    }

    .badge-gold {
      background: linear-gradient(135deg, #f59e0b20, #f59e0b10);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #f59e0b;
    }

    .badge-platinum {
      background: linear-gradient(135deg, #7c3aed20, #7c3aed10);
      border: 1px solid rgba(124, 58, 237, 0.3);
      color: #7c3aed;
    }

    /* Progress tracks */
    .progress-track {
      margin: 12px 0;
    }

    .track-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .track-bar {
      height: 8px;
      border-radius: 4px;
      background: var(--surface-2);
      overflow: hidden;
    }

    .track-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
    }

    /* Comparison meter */
    .comparison-meter {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
    }

    .meter-bar {
      flex: 1;
      height: 20px;
      border-radius: 10px;
      background: var(--surface-2);
      overflow: hidden;
      position: relative;
    }

    .meter-fill {
      height: 100%;
      border-radius: 10px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      background: var(--text);
      opacity: 0.5;
    }

    .meter-you {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--b3-blue), var(--b3-purple));
    }

    .meter-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Recommendation cards */
    .recommendation-card {
      padding: 12px;
      border-radius: 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .recommendation-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: rgba(47, 46, 125, 0.1);
      display: grid;
      place-items: center;
      color: var(--b3-blue);
      flex-shrink: 0;
    }

    .recommendation-content {
      flex: 1;
    }

    .recommendation-title {
      font-size: 13px;
      font-weight: 850;
      margin-bottom: 2px;
    }

    .recommendation-desc {
      font-size: 12px;
      color: var(--muted);
    }

    /* Estilos para o gráfico de categorias */
    #categoryChart {
      width: 100% !important;
      height: 300px !important;
    }

    #chartCategory {
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    #refreshChartBtn {
      transition: all 0.2s ease;
    }

    #refreshChartBtn:hover {
      transform: rotate(15deg);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <!-- Primeira linha: Logo e Ações Principais -->
    <div class="topline">
      <div class="brand">
        <div class="logo">B3</div>
        <div class="brand-text">
          <h1>PQO Riscos — Simulador</h1>
          <div class="sub">Treinamento para Prova de Qualificação Operacional</div>
        </div>
      </div>

      <div class="main-actions">
        <!-- Ações principais em ícones -->
        <button class="header-btn" id="openBankBtn" title="Banco de questões">
          <i class="fas fa-database"></i>
          <span class="btn-label">Banco</span>
        </button>
        
        <button class="header-btn" id="openConfigBtn" title="Configurar simulado">
          <i class="fas fa-sliders-h"></i>
          <span class="btn-label">Configurar</span>
        </button>
        
        <button class="header-btn" id="openManagerBtn" title="Gerenciar questões">
          <i class="fas fa-edit"></i>
          <span class="btn-label">Gerenciar</span>
        </button>
        
        <button class="header-btn" id="openFilesBtn" title="Arquivos PDF">
          <i class="fas fa-folder"></i>
          <span class="btn-label">Arquivos</span>
        </button>
      </div>

      <div class="user-actions">
        <!-- Modo e Status -->
        <div class="status-badge" id="modeBadge">
          <i class="fas fa-play-circle"></i>
          <span id="modeLabel">Início</span>
        </div>
        
        <!-- Tema -->
        <button class="theme-toggle" id="themeToggleBtn" title="Alternar tema">
          <i class="fas fa-moon"></i>
        </button>
        
        <!-- Login -->
        <button class="user-btn" id="authBtn" title="Login/Logout">
          <i class="fas fa-user-circle"></i>
        </button>
      </div>
    </div>

    <!-- Segunda linha: Status e Progresso -->
    <div class="status-line">
      <div class="stats">
        <span class="stat-item">
          <i class="fas fa-question-circle"></i>
          <span>Questões: <strong id="countLabel">0</strong></span>
        </span>
        
        <span class="stat-item" id="statusPill">
          <i class="fas fa-check-circle"></i>
          <span>Pronto</span>
        </span>
        
        <span class="stat-item" id="timerBadge">
          <i class="fas fa-clock"></i>
          <span id="timer">00:00</span>
        </span>
      </div>
      
      <button class="home-btn" id="goHomeBtn" title="Voltar para início">
        <i class="fas fa-home"></i>
        <span>Início</span>
      </button>
    </div>

    <!-- Barra de Progresso (só aparece durante simulado) -->
    <div class="progress-row" id="progressWrap">
      <div class="progress-label">
        <span>Progresso</span>
        <span id="progressText">0/0</span>
      </div>
      <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section class="view active" id="homeView">
    <div class="home-head">
      <div>
        <h2 class="home-title">Meus Cursos</h2>
        <p class="home-sub">
          Fluxo recomendado: <span class="kbd">Banco</span> → <span class="kbd">Configurar</span> → Iniciar.
        </p>
      </div>
      <div class="chip">
        <i class="fas fa-database"></i>
        <span>Banco: <strong id="homeBankCount">0</strong> questões</span>
      </div>
    </div>

    <div class="course-grid">
      <div class="course-card" id="coursePQO">
        <div class="course-hero">
          <span class="badge"><i class="fas fa-graduation-cap"></i> Curso</span>
          <div class="big">PQO</div>
        </div>
        <div class="course-body">
          <h3>PQO Riscos</h3>
          <p>Simulados, modo prova e revisão por erros.</p>
          <div class="chip"><i class="fas fa-bolt"></i> Modo prova (tela cheia)</div>
        </div>
        <div class="course-footer">
          <span class="chip"><i class="fas fa-list-check"></i> Filtros avançados</span>
          <button class="btn-primary" id="homeStartBtn"><i class="fas fa-play"></i> Configurar & Iniciar</button>
        </div>
      </div>

      <!-- Novo card para Arquivos -->
      <div class="course-card" id="courseFiles">
        <div class="course-hero" style="background: linear-gradient(135deg, rgba(239,68,68,.9), rgba(245,158,11,.75));">
          <span class="badge"><i class="fas fa-file-pdf"></i> Documentos</span>
          <div class="big">PDF</div>
        </div>
        <div class="course-body">
          <h3>Arquivos de Consulta</h3>
          <p>Manuais, regulamentos e materiais de apoio para estudo.</p>
          <div class="chip"><i class="fas fa-download"></i> Download direto</div>
        </div>
        <div class="course-footer">
          <span class="chip"><i class="fas fa-database"></i> Local storage</span>
          <button class="btn-primary" id="homeFilesBtn"><i class="fas fa-folder-open"></i> Acessar Arquivos</button>
        </div>
      </div>

      <div class="course-card" style="opacity:.65; cursor:not-allowed;">
        <div class="course-hero" style="background: linear-gradient(135deg, rgba(100,116,139,.9), rgba(148,163,184,.75));">
          <span class="badge"><i class="fas fa-lock"></i> Em breve</span>
          <div class="big">—</div>
        </div>
        <div class="course-body">
          <h3>Outros cursos</h3>
          <p>Estruture novos simulados no mesmo padrão (futuro).</p>
          <div class="chip"><i class="fas fa-wand-magic-sparkles"></i> Expansível</div>
        </div>
        <div class="course-footer">
          <span class="chip"><i class="fas fa-clock"></i> Aguardando</span>
          <button disabled><i class="fas fa-ban"></i> Indisponível</button>
        </div>
      </div>
    </div>
  </section>

  <!-- EXAM -->
  <section class="view" id="examView">
    <div class="exam-shell">
      <section class="card">
        <div class="q-meta">
          <span class="tag tag-primary" id="qIndex">—</span>
          <span class="tag" id="qModule">—</span>
          <span class="tag" id="qChapter">—</span>
          <span class="tag" id="qTheme">—</span>
          <span class="tag" id="qLevel">—</span>
          <span class="tag" id="qId">—</span>
        </div>

        <h3 class="q-title" id="qText">Carregue um banco de questões e inicie o simulado.</h3>
        <p class="q-instructions" id="qSub">
          Dica: clique em <span class="kbd">Banco</span> para carregar o JSON.
        </p>

        <div class="options" id="options"></div>

        <div class="feedback" id="feedback">
          <div class="feedback-header" id="feedbackHeader">
            <i class="fas fa-check-circle"></i>
            <span>Resposta Correta!</span>
          </div>

          <div class="feedback-body">
            <div class="feedback-tags">
              <span class="tag" id="userAnswerTag">Sua: —</span>
              <span class="tag tag-success" id="correctAnswerTag">Gabarito: —</span>
            </div>

            <div id="feedbackText"></div>
            <div class="explanation" id="explanation"></div>
          </div>
        </div>

        <div class="action-bar">
          <div class="group">
            <button id="prevBtn"><i class="fas fa-arrow-left"></i> Anterior</button>
          </div>

          <div class="group">
            <button class="btn-danger" id="finishBtn"><i class="fas fa-flag-checkered"></i> Finalizar</button>
            <button class="btn-success" id="confirmBtn"><i class="fas fa-check"></i> Corrigir</button>
            <button class="btn-primary" id="nextBtn">Próxima <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <p class="small" id="simInfo">
          <i class="fas fa-info-circle"></i> Simulado: 0 questões • Sem tempo limite • Corrige tudo ao final.
        </p>
      </section>
    </div>
  </section>
</main>

<!-- Notification -->
<div class="notification" id="notification">
  <i class="fas fa-check-circle"></i>
  <span id="notificationText">OK</span>
</div>

<!-- =========================
     MODAL 1: BANCO (arquivo)
     ========================= -->
<div class="modal-backdrop" id="bankBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Banco de questões">
    <div class="modal-header">
      <h3><i class="fas fa-folder-open"></i> Banco de Questões (JSON)</h3>
      <button class="modal-close" id="closeBankBtn" title="Fechar (Esc)"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="panel">
        <h4>Selecionar arquivo</h4>

        <input class="hidden-file" id="jsonFileInput" type="file" accept=".json,application/json">
        <button class="btn-success" id="pickFileBtn">
          <i class="fas fa-folder-open"></i> Selecionar arquivo JSON
        </button>

        <div class="divider"></div>

        <div class="hint" id="bankHint">
          Nenhum arquivo selecionado. Selecione um JSON para ver um resumo do banco e carregar.
        </div>

        <div id="bankSummary" style="display:none; margin-top:12px;">
          <div class="row2">
            <div class="result-card">
              <div class="result-value" id="sumCount">0</div>
              <div class="result-label">Questões</div>
            </div>
            <div class="result-card">
              <div class="result-value" id="sumThemes">0</div>
              <div class="result-label">Temas</div>
            </div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div class="result-card">
              <div class="result-value" id="sumModules">0</div>
              <div class="result-label">Módulos</div>
            </div>
            <div class="result-card">
              <div class="result-value" id="sumChapters">0</div>
              <div class="result-label">Capítulos</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="hint">
            <strong>Arquivo:</strong> <span id="sumFileName">—</span><br>
            <strong>Campos suportados:</strong> <span class="kbd">id</span>, <span class="kbd">q</span>, <span class="kbd">options(A-D)</span>, <span class="kbd">answer</span>, <span class="kbd">explain</span>,
            e opcionalmente <span class="kbd">theme</span>, <span class="kbd">level</span>, <span class="kbd">module</span>, <span class="kbd">chapter</span>.
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="btn-primary" id="loadBankBtn"><i class="fas fa-upload"></i> Carregar banco</button>
            <button class="btn-ghost" id="exportBtn"><i class="fas fa-download"></i> Exportar banco atual</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     MODAL 2: CONFIGURAÇÃO PROVA
     ========================= -->
<div class="modal-backdrop" id="configBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Configuração da prova">
    <div class="modal-header">
      <h3><i class="fas fa-sliders"></i> Configuração do Simulado</h3>
      <button class="modal-close" id="closeConfigBtn" title="Fechar (Esc)"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="row2">
        <div class="panel">
          <h4>Modo</h4>

          <label for="modeSelect">Tipo de simulado</label>
          <select id="modeSelect">
            <option value="TREINO" selected>Treino (quantidade livre)</option>
            <option value="PROVA">Prova (60 questões, distribuição por módulo)</option>
            <option value="CUSTOM_PCT">Prova custom (% por módulo)</option>
          </select>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label for="simN">Quantidade</label>
              <input id="simN" type="number" min="5" max="200" value="10">
            </div>
            <div>
              <label for="simMinutes">Tempo (min)</label>
              <input id="simMinutes" type="number" min="0" max="240" value="60">
            </div>
          </div>

          <label for="repeatRule">Repetição</label>
          <select id="repeatRule">
            <option value="ALLOW">Permitir repetir (padrão)</option>
            <option value="HIDE_DONE">Não mostrar as que eu já resolvi</option>
            <option value="HIDE_CORRECT">Não mostrar as que eu acertei</option>
          </select>

          <div class="divider"></div>

          <div class="hint">
            <strong>Nota:</strong> os filtros abaixo dependem do seu JSON ter <span class="kbd">module</span> e <span class="kbd">chapter</span>.
            Se não tiver, o simulador cria automaticamente "Geral".
          </div>

          <div class="divider"></div>

          <button class="btn-primary" id="startBtn"><i class="fas fa-play"></i> Iniciar modo prova</button>
          <button id="resetBtn" style="margin-top:10px;"><i class="fas fa-rotate"></i> Resetar sessão</button>
        </div>

        <div class="panel">
          <h4>Filtros</h4>

          <label for="themeFilter">Tema</label>
          <select id="themeFilter">
            <option value="ALL">Todos</option>
          </select>

          <label for="moduleFilter">Módulo</label>
          <select id="moduleFilter">
            <option value="ALL">Todos</option>
          </select>

          <label for="chapterFilter">Capítulo</label>
          <select id="chapterFilter">
            <option value="ALL">Todos</option>
          </select>

          <label for="levelFilter">Dificuldade</label>
          <select id="levelFilter">
            <option value="ALL">Todas</option>
            <option value="Fácil">Fácil</option>
            <option value="Médio">Médio</option>
            <option value="Difícil">Difícil</option>
          </select>

          <div class="divider"></div>

          <div id="pctBox" style="display:none;">
            <h4>Distribuição por Módulo (%)</h4>
            <div class="hint">
              Digite percentuais por módulo somando <strong>100%</strong>. O simulador monta 60 questões nessa proporção.
            </div>
            <div id="pctList" style="margin-top:10px;"></div>
            <div class="pct-total">
              <span>Total:</span>
              <span><strong id="pctTotal">0%</strong> <span id="pctWarn" class=""></span></span>
            </div>
          </div>

          <div id="provaHint" class="hint" style="display:none;">
            <strong>Prova (60):</strong> o sistema distribui automaticamente entre os módulos existentes no banco.
            Se quiser controlar, use "Prova custom (% por módulo)".
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     MODAL 3: GERENCIADOR (CRUD)
     ========================= -->
<div class="modal-backdrop" id="managerBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Gerenciador de questões">
    <div class="modal-header">
      <h3><i class="fas fa-pen-to-square"></i> Gerenciador de Questões</h3>
      <button class="modal-close" id="closeManagerBtn" title="Fechar (Esc)"><i class="fas fa-xmark"></i></button>
    </div>

    <div class="modal-body">
      <div class="row2">
        <div class="panel">
          <h4>Adicionar / Editar</h4>

          <div class="row2">
            <div>
              <label for="qIdInput">ID</label>
              <input id="qIdInput" placeholder="Ex.: Q0001">
            </div>
            <div>
              <label for="qLevelInput">Dificuldade</label>
              <select id="qLevelInput">
                <option value="Fácil">Fácil</option>
                <option value="Médio" selected>Médio</option>
                <option value="Difícil">Difícil</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="qModuleInput">Módulo</label>
              <input id="qModuleInput" placeholder="Ex.: Estrutura de Mercado">
            </div>
            <div>
              <label for="qChapterInput">Capítulo</label>
              <input id="qChapterInput" placeholder="Ex.: Negociação">
            </div>
          </div>

          <label for="qThemeInput">Tema</label>
          <input id="qThemeInput" placeholder="Ex.: Tipos de ordem">

          <label for="qTextInput">Enunciado</label>
          <textarea id="qTextInput" placeholder="Digite o enunciado..."></textarea>

          <div class="row2">
            <div><label for="optA">Alternativa A</label><input id="optA" placeholder="Texto A"></div>
            <div><label for="optB">Alternativa B</label><input id="optB" placeholder="Texto B"></div>
          </div>
          <div class="row2">
            <div><label for="optC">Alternativa C</label><input id="optC" placeholder="Texto C"></div>
            <div><label for="optD">Alternativa D</label><input id="optD" placeholder="Texto D"></div>
          </div>

          <label for="answerInput">Gabarito</label>
          <select id="answerInput">
            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
          </select>

          <label for="explainInput">Explicação</label>
          <textarea id="explainInput" placeholder="Explique por que está correta..."></textarea>

          <div class="row2" style="margin-top:10px;">
            <button class="btn-success" id="saveQuestionBtn"><i class="fas fa-floppy-disk"></i> Salvar</button>
            <button class="btn-ghost" id="clearFormBtn"><i class="fas fa-broom"></i> Limpar</button>
          </div>

          <div class="divider"></div>

          <div class="hint">
            <strong>UX:</strong> para criar rápido, preencha ID + módulo/capítulo/tema + enunciado + A–D + gabarito.
            Depois exporte o banco em <span class="kbd">Banco</span>.
          </div>
        </div>

        <div class="panel">
          <h4>Lista / Busca</h4>
          <div class="list">
            <div class="list-top">
              <input id="searchQuestions" placeholder="Buscar por id, módulo, capítulo, tema, nível, texto...">
              <span class="chip"><i class="fas fa-list"></i> <strong id="managerCount">0</strong></span>
            </div>
            <div class="list-body" id="questionList"></div>
          </div>

          <p class="small" style="margin:12px 0 0;">
            <i class="fas fa-circle-info"></i> Tudo fica local no navegador. Use <span class="kbd">Banco</span> para exportar JSON.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     MODAL 4: ARQUIVOS PDF
     ========================= -->
<div class="modal-backdrop" id="filesBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Arquivos de consulta">
    <div class="modal-header">
      <h3><i class="fas fa-file-pdf"></i> Arquivos de Consulta</h3>
      <button class="modal-close" id="closeFilesBtn" title="Fechar (Esc)"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="panel">
        <h4>📚 Documentos para Estudo</h4>
        <p style="margin:0 0 14px 0; color:var(--muted); font-size:13px;">
          Baixe ou visualize diretamente os arquivos importantes para a prova PQO Riscos.
        </p>
        
        <div id="filesList" class="list-body" style="display:grid; gap:12px; margin-top:12px;">
          <!-- Os arquivos serão inseridos aqui via JavaScript -->
        </div>
        
        <div class="divider"></div>
        
        <div id="adminSection" style="display:none;">
          <h4 style="margin:0 0 10px 0;">🔧 Administração (Apenas Admin)</h4>
          <div class="hint" style="margin-bottom:14px;">
            <strong>Nota:</strong> Esta seção só está visível porque você está logado como administrador.
          </div>
          
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
            <div style="flex:1; min-width:200px;">
              <label for="fileNameInput">Nome do arquivo</label>
              <input id="fileNameInput" placeholder="Ex: Manual B3 - Risco de Mercado">
            </div>
            <div style="flex:1; min-width:200px;">
              <label for="fileUploadInput">Arquivo PDF</label>
              <input type="file" id="fileUploadInput" accept=".pdf,application/pdf" style="padding:8px;">
            </div>
            <button class="btn-primary" id="addFileBtn" style="min-width:120px;">
              <i class="fas fa-plus"></i> Adicionar
            </button>
          </div>
          
          <div class="hint" style="margin-top:12px;">
            <strong>Limite:</strong> 10MB por arquivo. Use nomes descritivos para facilitar a busca.
          </div>
        </div>
        
        <div id="loginPrompt" class="hint">
          <strong>⚙️ Para gerenciar arquivos:</strong> Faça login como administrador usando o botão <span class="kbd">Login</span> no menu superior.
          <br><br>
          <strong>Credenciais padrão:</strong><br>
          • Login: <span class="kbd">admin</span><br>
          • Senha: <span class="kbd">admin</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     MODAL 5: LOGIN
     ========================= -->
<div class="modal-backdrop" id="loginBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Login" style="width:min(400px,90vw);">
    <div class="modal-header">
      <h3><i class="fas fa-user"></i> Login Administrativo</h3>
      <button class="modal-close" id="closeLoginBtn" title="Fechar (Esc)"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="login-form">
        <div class="login-logo">B3</div>
        <h3 class="login-title">PQO Simulador</h3>
        <p class="login-sub">Acesso administrativo para gerenciar arquivos</p>
        
        <div id="loginError" class="hint" style="display:none; border-color:var(--b3-red); background:rgba(239,68,68,.06);">
          <i class="fas fa-exclamation-circle"></i> <span id="errorText">Login ou senha incorretos</span>
        </div>
        
        <label for="loginUsername">Login</label>
        <input type="text" id="loginUsername" placeholder="Digite seu login" value="admin">
        
        <label for="loginPassword" style="margin-top:12px;">Senha</label>
        <input type="password" id="loginPassword" placeholder="Digite sua senha" value="admin">
        
        <button class="btn-primary login-btn" id="loginSubmitBtn">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
        
        <div class="hint" style="margin-top:16px; text-align:center;">
          <strong>Credenciais padrão:</strong><br>
          Login: <span class="kbd">admin</span> | Senha: <span class="kbd">admin</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // =========================
  // BANCO
  // =========================
  let questionBank = [];

  // =========================
  // ESTADO
  // =========================
  const appState = {
    mode: "home", // home | sim | results
    configMode: "TREINO", // TREINO | PROVA | CUSTOM_PCT
    theme: "ALL",
    module: "ALL",
    chapter: "ALL",
    level: "ALL",
    simN: 10,
    simMinutes: 60,
    repeatRule: "ALLOW",

    customPct: {}, // {module: number}
    questionList: [],
    currentIndex: 0,
    userAnswers: {},

    started: false,
    startTime: null,
    endTime: null,
    timerInterval: null,
    deadline: null,

    pendingBankText: null,
    pendingBankName: null,
    pendingParsedBank: null,

    // Estado para alternativas desconsideradas
    dismissedAlternatives: {}, // { questionId: ['A', 'C'] }
    dismissedQuestions: [], // Lista de IDs de questões completamente desconsideradas
    
    // Estado de autenticação
    isAuthenticated: false,
    authToken: null
  };

  // =========================
  // DOM
  // =========================
  const el = {
    homeView: document.getElementById("homeView"),
    examView: document.getElementById("examView"),

    // Novos elementos do cabeçalho
    modeLabel: document.getElementById("modeLabel"),
    countLabel: document.getElementById("countLabel"),
    statusPill: document.getElementById("statusPill"),
    progressWrap: document.getElementById("progressWrap"),
    progressBar: document.getElementById("progressBar"),
    progressText: document.getElementById("progressText"),
    timer: document.getElementById("timer"),

    // Botões do cabeçalho
    openBankBtn: document.getElementById("openBankBtn"),
    openConfigBtn: document.getElementById("openConfigBtn"),
    openManagerBtn: document.getElementById("openManagerBtn"),
    openFilesBtn: document.getElementById("openFilesBtn"),
    authBtn: document.getElementById("authBtn"),
    themeToggleBtn: document.getElementById("themeToggleBtn"),
    goHomeBtn: document.getElementById("goHomeBtn"),

    homeBankCount: document.getElementById("homeBankCount"),
    homeStartBtn: document.getElementById("homeStartBtn"),
    homeFilesBtn: document.getElementById("homeFilesBtn"),
    coursePQO: document.getElementById("coursePQO"),
    courseFiles: document.getElementById("courseFiles"),

    qIndex: document.getElementById("qIndex"),
    qModule: document.getElementById("qModule"),
    qChapter: document.getElementById("qChapter"),
    qTheme: document.getElementById("qTheme"),
    qLevel: document.getElementById("qLevel"),
    qId: document.getElementById("qId"),
    qText: document.getElementById("qText"),
    qSub: document.getElementById("qSub"),
    options: document.getElementById("options"),

    feedback: document.getElementById("feedback"),
    feedbackHeader: document.getElementById("feedbackHeader"),
    userAnswerTag: document.getElementById("userAnswerTag"),
    correctAnswerTag: document.getElementById("correctAnswerTag"),
    feedbackText: document.getElementById("feedbackText"),
    explanation: document.getElementById("explanation"),

    prevBtn: document.getElementById("prevBtn"),
    nextBtn: document.getElementById("nextBtn"),
    confirmBtn: document.getElementById("confirmBtn"),
    finishBtn: document.getElementById("finishBtn"),
    simInfo: document.getElementById("simInfo"),

    notification: document.getElementById("notification"),
    notificationText: document.getElementById("notificationText"),

    // Bank modal
    bankBackdrop: document.getElementById("bankBackdrop"),
    closeBankBtn: document.getElementById("closeBankBtn"),
    jsonFileInput: document.getElementById("jsonFileInput"),
    pickFileBtn: document.getElementById("pickFileBtn"),
    bankHint: document.getElementById("bankHint"),
    bankSummary: document.getElementById("bankSummary"),
    sumCount: document.getElementById("sumCount"),
    sumThemes: document.getElementById("sumThemes"),
    sumModules: document.getElementById("sumModules"),
    sumChapters: document.getElementById("sumChapters"),
    sumFileName: document.getElementById("sumFileName"),
    loadBankBtn: document.getElementById("loadBankBtn"),
    exportBtn: document.getElementById("exportBtn"),

    // Config modal
    configBackdrop: document.getElementById("configBackdrop"),
    closeConfigBtn: document.getElementById("closeConfigBtn"),
    modeSelect: document.getElementById("modeSelect"),
    simN: document.getElementById("simN"),
    simMinutes: document.getElementById("simMinutes"),
    repeatRule: document.getElementById("repeatRule"),

    themeFilter: document.getElementById("themeFilter"),
    moduleFilter: document.getElementById("moduleFilter"),
    chapterFilter: document.getElementById("chapterFilter"),
    levelFilter: document.getElementById("levelFilter"),

    pctBox: document.getElementById("pctBox"),
    pctList: document.getElementById("pctList"),
    pctTotal: document.getElementById("pctTotal"),
    pctWarn: document.getElementById("pctWarn"),
    provaHint: document.getElementById("provaHint"),

    startBtn: document.getElementById("startBtn"),
    resetBtn: document.getElementById("resetBtn"),

    // Manager modal
    managerBackdrop: document.getElementById("managerBackdrop"),
    closeManagerBtn: document.getElementById("closeManagerBtn"),

    qIdInput: document.getElementById("qIdInput"),
    qLevelInput: document.getElementById("qLevelInput"),
    qModuleInput: document.getElementById("qModuleInput"),
    qChapterInput: document.getElementById("qChapterInput"),
    qThemeInput: document.getElementById("qThemeInput"),
    qTextInput: document.getElementById("qTextInput"),
    optA: document.getElementById("optA"),
    optB: document.getElementById("optB"),
    optC: document.getElementById("optC"),
    optD: document.getElementById("optD"),
    answerInput: document.getElementById("answerInput"),
    explainInput: document.getElementById("explainInput"),
    saveQuestionBtn: document.getElementById("saveQuestionBtn"),
    clearFormBtn: document.getElementById("clearFormBtn"),
    searchQuestions: document.getElementById("searchQuestions"),
    questionList: document.getElementById("questionList"),
    managerCount: document.getElementById("managerCount"),

    // Files modal
    filesBackdrop: document.getElementById("filesBackdrop"),
    closeFilesBtn: document.getElementById("closeFilesBtn"),
    filesList: document.getElementById("filesList"),
    adminSection: document.getElementById("adminSection"),
    loginPrompt: document.getElementById("loginPrompt"),
    fileNameInput: document.getElementById("fileNameInput"),
    fileUploadInput: document.getElementById("fileUploadInput"),
    addFileBtn: document.getElementById("addFileBtn"),

    // Login modal
    loginBackdrop: document.getElementById("loginBackdrop"),
    closeLoginBtn: document.getElementById("closeLoginBtn"),
    loginUsername: document.getElementById("loginUsername"),
    loginPassword: document.getElementById("loginPassword"),
    loginSubmitBtn: document.getElementById("loginSubmitBtn"),
    loginError: document.getElementById("loginError"),
    errorText: document.getElementById("errorText")
  };

  // =========================
  // UTILS
  // =========================
  function showNotification(message, type="success"){
    el.notificationText.textContent = message;
    el.notification.className = `notification show notification-${type}`;
    const icon = el.notification.querySelector("i");
    icon.className = type==="success" ? "fas fa-check-circle" : "fas fa-exclamation-circle";
    setTimeout(()=>el.notification.classList.remove("show"), 2400);
  }

  function setView(view){
    el.homeView.classList.toggle("active", view==="home");
    el.examView.classList.toggle("active", view==="exam");
    if(view==="home") el.progressWrap.style.display="none";
  }

  function safeText(s){
    return String(s ?? "").replace(/[<>&"]/g, c => ({ "<":"&lt;", ">":"&gt;", "&":"&amp;", "\"":"&quot;" }[c]));
  }

  function formatTime(ms){
    const totalSeconds = Math.floor(ms/1000);
    const minutes = Math.floor(totalSeconds/60);
    const seconds = totalSeconds%60;
    return `${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")}`;
  }

  function shuffleArray(array){
    const a=[...array];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // ===== history (localStorage)
  function loadHistory(){
    try{ return JSON.parse(localStorage.getItem("pqo_history")||"{}"); }catch{ return {}; }
  }
  function saveHistory(h){ localStorage.setItem("pqo_history", JSON.stringify(h)); }
  function markHistory(questionId, correct){
    const h=loadHistory();
    if(!h[questionId]) h[questionId]={done:true,correct:!!correct};
    else{ h[questionId].done=true; h[questionId].correct = h[questionId].correct || !!correct; }
    saveHistory(h);
  }

  // =========================
  // NORMALIZA CAMPOS (module/chapter defaults)
  // =========================
  function normalizeQuestion(q){
    const module = (q.module && String(q.module).trim()) ? String(q.module).trim() : "Geral";
    const chapter = (q.chapter && String(q.chapter).trim()) ? String(q.chapter).trim() : "Geral";
    const theme = (q.theme && String(q.theme).trim()) ? String(q.theme).trim() : "Geral";
    const level = (q.level && String(q.level).trim()) ? String(q.level).trim() : "Médio";
    return {
      ...q,
      module, chapter, theme, level,
    };
  }

  function validateParsedBank(parsed){
    if(!Array.isArray(parsed)) throw new Error("O JSON deve conter uma lista (array) de questões.");
    const out = parsed.map(normalizeQuestion);
    out.forEach((q,idx)=>{
      if(!q || typeof q!=="object") throw new Error(`Item ${idx+1} inválido.`);
      if(!q.id || !q.q || !q.options || !q.answer) throw new Error(`Questão ${idx+1} incompleta (id, q, options, answer).`);
      if(!["A","B","C","D"].includes(q.answer)) throw new Error(`Questão ${q.id}: answer deve ser A, B, C ou D.`);
      const ok = q.options?.A && q.options?.B && q.options?.C && q.options?.D;
      if(!ok) throw new Error(`Questão ${q.id}: options deve conter A, B, C e D.`);
    });
    return out;
  }

  // =========================
  // LISTAS / FILTROS
  // =========================
  function uniqSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
  }

  function getThemes(){ return ["ALL", ...uniqSorted(questionBank.map(q=>q.theme))]; }
  function getModules(){ return ["ALL", ...uniqSorted(questionBank.map(q=>q.module))]; }
  function getChapters(){ return ["ALL", ...uniqSorted(questionBank.map(q=>q.chapter))]; }
  function getLevels(){ return ["ALL", ...uniqSorted(questionBank.map(q=>q.level))]; }

  function fillSelect(selectEl, values, labelAll="Todos"){
    selectEl.innerHTML="";
    values.forEach(v=>{
      const opt=document.createElement("option");
      opt.value=v;
      opt.textContent = (v==="ALL") ? labelAll : v;
      selectEl.appendChild(opt);
    });
  }

  function updateConfigDropdowns(){
    fillSelect(el.themeFilter, getThemes(), "Todos");
    fillSelect(el.moduleFilter, getModules(), "Todos");
    fillSelect(el.chapterFilter, getChapters(), "Todos");
  }

  function filterQuestions(){
    let filtered=[...questionBank];

    if(appState.theme!=="ALL") filtered = filtered.filter(q=>q.theme===appState.theme);
    if(appState.module!=="ALL") filtered = filtered.filter(q=>q.module===appState.module);
    if(appState.chapter!=="ALL") filtered = filtered.filter(q=>q.chapter===appState.chapter);
    if(appState.level!=="ALL") filtered = filtered.filter(q=>q.level===appState.level);

    const hist=loadHistory();
    if(appState.repeatRule==="HIDE_DONE") filtered = filtered.filter(q=>!hist[q.id]?.done);
    if(appState.repeatRule==="HIDE_CORRECT") filtered = filtered.filter(q=>!(hist[q.id]?.done && hist[q.id]?.correct));

    return filtered;
  }

  // =========================
  // HEADER / STATUS ATUALIZADO
  // =========================
  function updateHeaderStatus(){
    el.countLabel.textContent = String(questionBank.length || 0);
    el.homeBankCount.textContent = String(questionBank.length || 0);

    const statusPill = el.statusPill;
    const modeBadge = document.getElementById('modeBadge');
    
    if(appState.mode==="home"){ 
      el.modeLabel.textContent="Início"; 
      statusPill.innerHTML = '<i class="fas fa-check-circle"></i><span>Pronto</span>';
      modeBadge.innerHTML = '<i class="fas fa-home"></i><span>Início</span>';
    }
    else if(appState.mode==="sim"){ 
      el.modeLabel.textContent="Simulado"; 
      statusPill.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Em andamento</span>';
      modeBadge.innerHTML = '<i class="fas fa-play-circle"></i><span>Simulado</span>';
    }
    else { 
      el.modeLabel.textContent="Resultados"; 
      statusPill.innerHTML = '<i class="fas fa-flag-checkered"></i><span>Finalizado</span>';
      modeBadge.innerHTML = '<i class="fas fa-chart-bar"></i><span>Resultados</span>';
    }
    
    // Atualizar texto de progresso
    if(appState.started && appState.questionList.length > 0){
      el.progressText.textContent = `${appState.currentIndex + 1}/${appState.questionList.length}`;
    }
  }

  function showProgressBar(show){ 
    el.progressWrap.style.display = show ? "block" : "none"; 
  }

  function updateProgressBar(){
    if(!appState.started || appState.mode!=="sim") return;
    const total = appState.questionList.length || 1;
    const progress = ((appState.currentIndex+1)/total)*100;
    el.progressBar.style.width = `${progress}%`;
    
    // Atualizar texto
    if(el.progressText){
      el.progressText.textContent = `${appState.currentIndex + 1}/${total}`;
    }
  }

  // =========================
  // TIMER
  // =========================
  function updateTimer(){
    if(!appState.deadline) return;
    const now=Date.now();
    const remaining = appState.deadline-now;
    if(remaining<=0){ stopTimer(); finishSimulation(true); return; }
    el.timer.textContent = formatTime(remaining);

    const minutesLeft=Math.floor(remaining/60000);
    const timerBadge = document.getElementById('timerBadge');
    timerBadge.className = "stat-item";
    if(minutesLeft<5) timerBadge.style.color = "var(--b3-red)";
    else if(minutesLeft<15) timerBadge.style.color = "var(--b3-yellow)";
  }

  function startTimer(){
    if(appState.simMinutes<=0){ el.timer.textContent="Sem tempo"; return; }
    appState.deadline = Date.now() + appState.simMinutes*60*1000;
    updateTimer();
    stopTimer();
    appState.timerInterval = setInterval(updateTimer, 1000);
  }

  function stopTimer(){
    if(appState.timerInterval) clearInterval(appState.timerInterval);
    appState.timerInterval=null;
  }

  function calculateDuration(){
    if(!appState.startTime || !appState.endTime) return "00:00";
    return formatTime(appState.endTime - appState.startTime);
  }

  // =========================
  // EXAM
  // =========================
  function getCurrentQuestion(){ return appState.questionList[appState.currentIndex]; }

  function getSelectedOption(){
    const selected=document.querySelector('input[name="option"]:checked');
    return selected ? selected.value : null;
  }

  // Função para desconsiderar/reconsiderar uma alternativa
  function toggleDismiss(questionId, letter) {
    // Inicializar se não existir
    if (!appState.dismissedAlternatives) {
      appState.dismissedAlternatives = {};
    }
    
    // Obter as alternativas desconsideradas para esta questão
    const dismissed = appState.dismissedAlternatives[questionId] || [];
    
    if (dismissed.includes(letter)) {
      // Remover da lista (reconsiderar)
      appState.dismissedAlternatives[questionId] = dismissed.filter(l => l !== letter);
      showNotification(`Alternativa ${letter} reconsiderada`, "success");
    } else {
      // Adicionar à lista (desconsiderar)
      dismissed.push(letter);
      appState.dismissedAlternatives[questionId] = dismissed;
      showNotification(`Alternativa ${letter} desconsiderada`, "success");
    }
    
    // Se todas as alternativas foram desconsideradas, marcar a questão toda como desconsiderada
    const question = questionBank.find(q => q.id === questionId);
    const allAlternatives = ['A', 'B', 'C', 'D'];
    const allDismissed = allAlternatives.every(l => 
        appState.dismissedAlternatives[questionId]?.includes(l)
    );
    
    if (allDismissed) {
        if (!appState.dismissedQuestions) {
            appState.dismissedQuestions = [];
        }
        if (!appState.dismissedQuestions.includes(questionId)) {
            appState.dismissedQuestions.push(questionId);
            showNotification(`Todas as alternativas desconsideradas - questão marcada como desconsiderada`, "warning");
        }
    } else {
        // Remover da lista de questões desconsideradas se não estiver mais completamente desconsiderada
        if (appState.dismissedQuestions) {
            appState.dismissedQuestions = appState.dismissedQuestions.filter(id => id !== questionId);
        }
    }
    
    // Re-renderizar a questão atual
    renderQuestion();
  }

  function renderOptions(question) {
    el.options.innerHTML = "";
    
    // Verificar se a questão foi desconsiderada
    const isDismissed = appState.dismissedQuestions?.includes(question.id);
    const dismissedAlternatives = appState.dismissedAlternatives?.[question.id] || [];
    
    const ua = appState.userAnswers[question.id];
    const selectedOption = ua ? ua.answer : null;
    const corrected = !!ua?.answered;

    ["A","B","C","D"].forEach(letter => {
        const optionText = safeText(question.options?.[letter] || "");
        const optionDiv = document.createElement("div");
        optionDiv.className = "option";
        
        // Verificar se esta alternativa específica foi desconsiderada
        const isAlternativeDismissed = dismissedAlternatives.includes(letter);
        
        // Adicionar classe dismissed se a alternativa foi desconsiderada
        if (isAlternativeDismissed || isDismissed) {
            optionDiv.classList.add("dismissed");
        }
        
        if(!corrected && selectedOption===letter && !isAlternativeDismissed && !isDismissed) {
            optionDiv.classList.add("selected");
        }
        
        if(corrected || isAlternativeDismissed || isDismissed){
            optionDiv.classList.add("locked");
            const isCorrect = letter===question.answer;
            const isUserPick = letter===ua?.answer;
            
            if(isCorrect && !isAlternativeDismissed && !isDismissed) {
                optionDiv.classList.add("correct");
            }
            if(isUserPick && !isCorrect && !isAlternativeDismissed && !isDismissed) {
                optionDiv.classList.add("incorrect");
            }
        }

        const isDismissedState = isAlternativeDismissed || isDismissed;
        
        optionDiv.innerHTML = `
            <input type="radio" name="option" value="${letter}" 
                   ${selectedOption===letter?"checked":""} 
                   ${(corrected || isDismissedState)?"disabled":""}>
            <div class="option-letter">${letter}</div>
            <div class="option-text">${optionText}</div>
            <div class="option-dismiss" data-letter="${letter}" 
                 title="${isDismissedState ? 'Reconsiderar esta alternativa' : 'Desconsiderar esta alternativa'}">
                <i class="fas fa-${isDismissedState ? 'rotate-left' : 'xmark'}"></i>
            </div>
            ${isDismissedState ? '<div class="dismiss-undo" data-letter="' + letter + '">Clique para reconsiderar</div>' : ''}
        `;

        // Evento para clicar na opção (somente se não estiver desconsiderada)
        optionDiv.addEventListener("click", (e) => {
            if (corrected || isDismissedState) return;
            if (!e.target.closest('.option-dismiss')) {
                selectOption(letter);
            }
        });

        // Evento para o botão de desconsiderar
        const dismissBtn = optionDiv.querySelector('.option-dismiss');
        if (dismissBtn) {
            dismissBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDismiss(question.id, letter);
            });
        }

        // Evento para o botão de reconsiderar (quando desconsiderado)
        if (isDismissedState) {
            const undoBtn = optionDiv.querySelector('.dismiss-undo');
            if (undoBtn) {
                undoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDismiss(question.id, letter);
                });
            }
        }

        el.options.appendChild(optionDiv);
    });
  }

  function selectOption(letter){
    const q=getCurrentQuestion(); if(!q) return;
    
    // Verificar se a alternativa está desconsiderada
    const dismissedAlternatives = appState.dismissedAlternatives?.[q.id] || [];
    if (dismissedAlternatives.includes(letter)) return;
    
    // Verificar se a questão toda está desconsiderada
    if (appState.dismissedQuestions?.includes(q.id)) return;
    
    const existing=appState.userAnswers[q.id];
    if(existing?.answered) return;

    // clear UI selections
    el.options.querySelectorAll(".option").forEach(opt=>{
      opt.classList.remove("selected");
      const input=opt.querySelector("input");
      if(input) input.checked=false;
    });

    // set selection
    const selectedInput = el.options.querySelector(`input[value="${letter}"]`);
    if(selectedInput){
      selectedInput.checked=true;
      selectedInput.closest(".option").classList.add("selected");
    }

    const prev=appState.userAnswers[q.id]||{};
    appState.userAnswers[q.id] = { ...prev, answer: letter, answered:false, timestamp: Date.now() };

    el.feedback.classList.remove("show");
  }

  function updateFeedback(question){
    const ua=appState.userAnswers[question.id];
    if(!ua || !ua.answered){ el.feedback.classList.remove("show"); return; }

    const isCorrect = ua.answer === question.answer;
    el.feedback.className = `feedback show ${isCorrect ? "correct" : "incorrect"}`;

    el.feedbackHeader.innerHTML = isCorrect
      ? `<i class="fas fa-check-circle"></i><span>Resposta Correta!</span>`
      : `<i class="fas fa-times-circle"></i><span>Resposta Incorreta</span>`;

    el.userAnswerTag.textContent = `Sua: ${ua.answer}`;
    el.correctAnswerTag.textContent = `Gabarito: ${question.answer}`;
    el.correctAnswerTag.className = "tag tag-success";

    el.feedbackText.innerHTML = `<strong>Alternativa correta:</strong> ${safeText(question.options[question.answer]||"")}`;
    el.explanation.textContent = question.explain || "Sem explicação disponível.";
  }

  function updateNavigationButtons(){
    el.prevBtn.disabled = appState.currentIndex===0;
    const isLast = appState.currentIndex === appState.questionList.length-1;
    el.nextBtn.disabled=false;
    el.nextBtn.innerHTML = isLast ? 'Final <i class="fas fa-flag-checkered"></i>' : 'Próxima <i class="fas fa-arrow-right"></i>';
  }

  function updateSimInfo(){
    const total=appState.questionList.length||0;
    el.simInfo.innerHTML =
      `<i class="fas fa-info-circle"></i> Simulado: ${total} questões • ` +
      `${appState.simMinutes>0 ? `${appState.simMinutes} minutos` : "Sem tempo limite"} • ` +
      `Corrige tudo ao final.`;
  }

  function renderQuestion(){
    const q=getCurrentQuestion();
    if(!q){ finishSimulation(false); return; }

    // Verificar se a questão foi desconsiderada
    const isDismissed = appState.dismissedQuestions?.includes(q.id);
    
    el.qIndex.textContent = `Questão ${appState.currentIndex+1}/${appState.questionList.length}`;
    el.qModule.textContent = q.module || "—";
    el.qChapter.textContent = q.chapter || "—";
    el.qTheme.textContent = q.theme || "—";
    el.qLevel.textContent = q.level || "—";
    el.qId.textContent = q.id || "—";

    // Adicionar ícone se a questão foi desconsiderada
    if (isDismissed) {
        el.qText.innerHTML = `<span style="color:var(--b3-red); margin-right:8px;"><i class="fas fa-eye-slash"></i></span>${safeText(q.q)}`;
    } else {
        el.qText.textContent = q.q || "—";
    }
    
    el.qSub.textContent = "Selecione uma alternativa, clique em 'Corrigir' para ver gabarito e explicação. Avance em 'Próxima'.";

    renderOptions(q);
    updateFeedback(q);
    updateNavigationButtons();
    updateProgressBar();
    updateSimInfo();
  }

  function confirmAnswer(){
    const q=getCurrentQuestion(); if(!q) return;
    
    // Verificar se a questão está desconsiderada
    if (appState.dismissedQuestions?.includes(q.id)) {
        showNotification("Esta questão foi desconsiderada. Reconsidere-a antes de corrigir.", "error");
        return;
    }
    
    const existing=appState.userAnswers[q.id];
    if(existing?.answered){ showNotification("Esta questão já foi corrigida.", "error"); return; }

    const selected=getSelectedOption();
    if(!selected){ showNotification("Selecione uma alternativa antes de corrigir.", "error"); return; }

    const isCorrect = selected===q.answer;
    appState.userAnswers[q.id] = { answer:selected, answered:true, correct:isCorrect, timestamp:Date.now() };
    markHistory(q.id, isCorrect);

    renderOptions(q);
    updateFeedback(q);
  }

  function previousQuestion(){ if(appState.currentIndex>0){ appState.currentIndex--; renderQuestion(); } }

  function nextQuestion(){
    const isLast = appState.currentIndex >= appState.questionList.length-1;
    if(!isLast){ appState.currentIndex++; renderQuestion(); }
    else{
      if(confirm("Esta é a última questão. Deseja finalizar?")) finishSimulation(false);
    }
  }

  // =========================
  // DASHBOARD FUNCTIONS
  // =========================
  function getScoreColor(score) {
    if (score >= 80) return '#16a34a'; // Verde
    if (score >= 60) return '#f59e0b'; // Amarelo
    return '#ef4444'; // Vermelho
  }

  function getPerformanceLevel(score) {
    if (score >= 90) return { level: 'Excelente', emoji: '🏆', color: '#16a34a' };
    if (score >= 80) return { level: 'Muito Bom', emoji: '⭐', color: '#22c55e' };
    if (score >= 70) return { level: 'Bom', emoji: '👍', color: '#84cc16' };
    if (score >= 60) return { level: 'Regular', emoji: '📊', color: '#f59e0b' };
    if (score >= 50) return { level: 'Atenção', emoji: '⚠️', color: '#f97316' };
    return { level: 'Precisa Estudar', emoji: '📚', color: '#ef4444' };
  }

  function calculateTimeEfficiency(totalTime, totalQuestions, correctAnswers) {
    // Tempo ideal: 1 minuto por questão
    const idealTime = totalQuestions * 60 * 1000; // em ms
    const actualTime = totalTime;
    
    // Penaliza se demorou muito, recompensa se foi rápido
    let efficiency = 100;
    
    if (actualTime > idealTime) {
      efficiency = Math.max(20, 100 - ((actualTime - idealTime) / idealTime * 50));
    } else {
      efficiency = Math.min(120, 100 + ((idealTime - actualTime) / idealTime * 30));
    }
    
    // Ajusta pela taxa de acerto
    efficiency = efficiency * (0.3 + (correctAnswers / totalQuestions * 0.7));
    
    return Math.min(100, Math.max(0, efficiency));
  }

  function calculateConsistency(answers) {
    // Calcula quão consistente foi nas respostas
    const correctSequence = [];
    let currentStreak = 0;
    let maxStreak = 0;
    
    Object.values(answers).forEach(ans => {
      if (ans.answered && ans.correct) {
        currentStreak++;
        maxStreak = Math.max(maxStreak, currentStreak);
      } else {
        currentStreak = 0;
      }
      correctSequence.push(ans.correct ? 1 : 0);
    });
    
    // Calcula desvio padrão da sequência de acertos
    const mean = correctSequence.reduce((a, b) => a + b, 0) / correctSequence.length;
    const variance = correctSequence.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / correctSequence.length;
    const stdDev = Math.sqrt(variance);
    
    // Consistência é inversamente proporcional ao desvio padrão
    let consistency = 100 - (stdDev * 100);
    
    // Bônus por streaks longos
    consistency += (maxStreak / correctSequence.length * 20);
    
    return Math.min(100, Math.max(0, consistency));
  }

  function generatePerformanceRings(score, timeEfficiency, consistency) {
    // Corrigir rotação para 100% - deve ser 360 + 135 = 495 graus
    const scoreRotation = score === 100 ? 495 : 135 + (score * 2.7);
    const efficiencyRotation = timeEfficiency === 100 ? 495 : 135 + (timeEfficiency * 2.7);
    const consistencyRotation = consistency === 100 ? 495 : 135 + (consistency * 2.7);
    
    return `
      <div class="ring-container">
        <div class="ring-bg"></div>
        <div class="ring-progress" style="
          border-color: ${getScoreColor(score)};
          transform: rotate(${scoreRotation}deg);
        "></div>
        <div class="ring-value">${score}%</div>
        <div class="ring-label">Nota</div>
      </div>
      <div class="ring-container">
        <div class="ring-bg"></div>
        <div class="ring-progress" style="
          border-color: ${timeEfficiency >= 70 ? '#16a34a' : timeEfficiency >= 50 ? '#f59e0b' : '#ef4444'};
          transform: rotate(${efficiencyRotation}deg);
        "></div>
        <div class="ring-value">${Math.round(timeEfficiency)}%</div>
        <div class="ring-label">Eficiência</div>
      </div>
      <div class="ring-container">
        <div class="ring-bg"></div>
        <div class="ring-progress" style="
          border-color: ${consistency >= 70 ? '#16a34a' : consistency >= 50 ? '#f59e0b' : '#ef4444'};
          transform: rotate(${consistencyRotation}deg);
        "></div>
        <div class="ring-value">${Math.round(consistency)}%</div>
        <div class="ring-label">Consistência</div>
      </div>
    `;
  }

  function generateWeakTopics(themeStats, totalQuestions) {
    const weakTopics = Object.entries(themeStats)
      .filter(([_, stats]) => stats.total >= 3 && (stats.correct / stats.total) < 1) // Adicionado filtro: só se não for 100%
      .map(([theme, stats]) => ({
        theme,
        accuracy: Math.round((stats.correct / stats.total) * 100),
        total: stats.total,
        correct: stats.correct
      }))
      .sort((a, b) => a.accuracy - b.accuracy)
      .slice(0, 5); // Top 5 piores
    
    if (weakTopics.length === 0) return '<div class="hint">✅ Excelente! Você não tem tópicos fracos identificados.</div>';
    
    return weakTopics.map(topic => `
      <div class="progress-track">
        <div class="track-header">
          <span>${safeText(topic.theme)}</span>
          <span>${topic.accuracy}% (${topic.correct}/${topic.total})</span>
        </div>
        <div class="track-bar">
          <div class="track-fill" style="
            width: ${topic.accuracy}%;
            background: ${topic.accuracy >= 70 ? 'linear-gradient(90deg, #16a34a, #22c55e)' : 
                         topic.accuracy >= 50 ? 'linear-gradient(90deg, #f59e0b, #f97316)' : 
                         'linear-gradient(90deg, #ef4444, #dc2626)'};
          "></div>
        </div>
      </div>
    `).join('');
  }

  function generateComparisonMeter(yourScore, avgScore = 65) {
    const position = ((yourScore - 0) / (100 - 0)) * 100;
    
    return `
      <div class="comparison-meter">
        <div class="meter-bar">
          <div class="meter-fill"></div>
          <div class="meter-you" style="width: ${yourScore}%"></div>
        </div>
        <div style="font-size: 12px; font-weight: 850; color: ${yourScore > avgScore ? '#16a34a' : '#ef4444'}">
          ${yourScore > avgScore ? '+' : ''}${yourScore - avgScore} pts
        </div>
      </div>
      <div class="meter-labels">
        <span>0%</span>
        <span>Média: ${avgScore}%</span>
        <span>100%</span>
      </div>
    `;
  }

  function generateRecommendations(score, weakTopics, timeEfficiency) {
    const recommendations = [];
    
    if (score < 70) {
      recommendations.push({
        icon: 'fas fa-book',
        title: 'Reforçar Estudos',
        desc: `Foque nos ${Math.min(3, weakTopics.length)} tópicos mais fracos identificados`,
        priority: 'high'
      });
    }
    
    if (timeEfficiency < 60) {
      recommendations.push({
        icon: 'fas fa-clock',
        title: 'Melhorar Gestão de Tempo',
        desc: 'Tente resolver questões mais rápido mantendo a precisão',
        priority: 'medium'
      });
    }
    
    if (score >= 80 && timeEfficiency >= 70) {
      recommendations.push({
        icon: 'fas fa-bolt',
        title: 'Pronto para Prova Real',
        desc: 'Seu desempenho indica boa preparação para a prova oficial',
        priority: 'low'
      });
    }
    
    recommendations.push({
      icon: 'fas fa-repeat',
      title: 'Simulado Focado',
      desc: 'Faça um simulado apenas com seus tópicos mais fracos',
      priority: 'medium'
    });
    
    recommendations.push({
      icon: 'fas fa-chart-line',
      title: 'Acompanhe Evolução',
      desc: 'Compare com simulações anteriores para ver progresso',
      priority: 'low'
    });
    
    return recommendations.map(rec => `
      <div class="recommendation-card">
        <div class="recommendation-icon">
          <i class="${rec.icon}"></i>
        </div>
        <div class="recommendation-content">
          <div class="recommendation-title">${rec.title}</div>
          <div class="recommendation-desc">${rec.desc}</div>
        </div>
      </div>
    `).join('');
  }

  function generateBadges(score, totalQuestions, maxStreak) {
    const badges = [];
    
    if (score >= 90) badges.push({ name: 'Mestre', type: 'platinum', icon: 'fas fa-crown' });
    if (score >= 80) badges.push({ name: 'Excelente', type: 'gold', icon: 'fas fa-star' });
    if (totalQuestions >= 50) badges.push({ name: 'Maratonista', type: 'silver', icon: 'fas fa-running' });
    if (maxStreak >= 10) badges.push({ name: 'Sequência', type: 'bronze', icon: 'fas fa-fire' });
    if (score >= 70 && totalQuestions >= 30) badges.push({ name: 'Consistente', type: 'silver', icon: 'fas fa-chart-line' });
    
    if (badges.length === 0) {
      return '<div class="hint">Continue estudando para conquistar badges!</div>';
    }
    
    return badges.map(badge => `
      <div class="badge-item badge-${badge.type}">
        <i class="${badge.icon}"></i>
        ${badge.name}
      </div>
    `).join('');
  }

  function saveSimulationHistory(results) {
    const history = JSON.parse(localStorage.getItem('pqo_sim_history') || '[]');
    history.push({
      date: new Date().toISOString(),
      score: results.score,
      total: results.total,
      correct: results.correct,
      duration: results.duration,
      weakTopics: results.weakTopics
    });
    
    // Manter apenas últimos 20 simulados
    if (history.length > 20) history.shift();
    
    localStorage.setItem('pqo_sim_history', JSON.stringify(history));
  }

  function getAverageScore() {
    const history = JSON.parse(localStorage.getItem('pqo_sim_history') || '[]');
    if (history.length === 0) return 65; // Média padrão
    
    const sum = history.reduce((acc, sim) => acc + sim.score, 0);
    return Math.round(sum / history.length);
  }

  function generateHeatmap() {
    const history = JSON.parse(localStorage.getItem('pqo_sim_history') || '[]');
    const heatmap = Array(30).fill(0); // Últimos 30 dias
    
    history.forEach(sim => {
      const date = new Date(sim.date);
      const daysAgo = Math.floor((Date.now() - date.getTime()) / (1000 * 60 * 60 * 24));
      if (daysAgo >= 0 && daysAgo < 30) {
        // Nível baseado no score
        const level = Math.min(5, Math.floor(sim.score / 20));
        heatmap[29 - daysAgo] = Math.max(heatmap[29 - daysAgo], level);
      }
    });
    
    return heatmap.map((level, i) => 
      `<div class="heatmap-day" data-level="${level}" title="${30 - i} dias atrás: ${level > 0 ? 'Simulado realizado' : 'Sem atividade'}"></div>`
    ).join('');
  }

  function exportResults(results) {
    const data = {
      data: new Date().toISOString(),
      simulador: "PQO Riscos Simulador",
      resultados: results
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `resultados_pqo_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification("Resultados exportados com sucesso!", "success");
  }

  function generateThemeChart(themeStats, themes, percentages){
    const canvas=document.getElementById("themeChart");
    if(!canvas) return;
    if(canvas._chart){ try{ canvas._chart.destroy(); }catch{} canvas._chart=null; }

    const chart = new Chart(canvas,{
      type:"bar",
      data:{ labels:themes, datasets:[{ label:"% de Acertos", data:percentages, backgroundColor:"rgba(47,46,125,.65)", borderColor:"rgba(47,46,125,1)", borderWidth:1 }] },
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+"%" } } },
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>{ const t=themes[ctx.dataIndex]; const s=themeStats[t]; return `${t}: ${s.correct}/${s.total} (${ctx.parsed.y}%)`; } } } }
      }
    });
    canvas._chart=chart;
  }

  // =========================
  // NOVA FUNÇÃO: GRÁFICO DE CATEGORIAS
  // =========================
  function generateCategoryChart(category, questionList, userAnswers) {
    const canvas = document.getElementById("categoryChart");
    if (!canvas) return;
    
    // Destruir gráfico anterior se existir
    if (canvas._chart) {
      try { canvas._chart.destroy(); } catch {}
      canvas._chart = null;
    }
    
    // Agrupar por categoria
    const stats = {};
    questionList.forEach(q => {
      const cat = q[category] || "Geral";
      if (!stats[cat]) {
        stats[cat] = { total: 0, correct: 0 };
      }
      stats[cat].total++;
      
      const ua = userAnswers[q.id];
      if (ua?.answered && ua.correct) {
        stats[cat].correct++;
      }
    });
    
    // Ordenar por quantidade de questões (maior para menor)
    const sortedCats = Object.keys(stats).sort((a, b) => stats[b].total - stats[a].total);
    
    const labels = sortedCats;
    const data = sortedCats.map(cat => {
      return stats[cat].total > 0 ? Math.round((stats[cat].correct / stats[cat].total) * 100) : 0;
    });
    
    // Definir cores baseadas na porcentagem
    const backgroundColors = data.map(percentage => {
      if (percentage >= 70) return 'rgba(34, 197, 94, 0.65)'; // Verde
      if (percentage >= 40) return 'rgba(245, 158, 11, 0.65)'; // Amarelo
      return 'rgba(239, 68, 68, 0.65)'; // Vermelho
    });
    
    const borderColors = data.map(percentage => {
      if (percentage >= 70) return 'rgba(34, 197, 94, 1)';
      if (percentage >= 40) return 'rgba(245, 158, 11, 1)';
      return 'rgba(239, 68, 68, 1)';
    });
    
    // Determinar label baseado na categoria
    let labelText = "Tema";
    if (category === "module") labelText = "Módulo";
    if (category === "chapter") labelText = "Capítulo";
    
    const chart = new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: `% de Acertos por ${labelText}`,
          data: data,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            },
            title: {
              display: true,
              text: 'Porcentagem de Acertos'
            }
          },
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 45
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const cat = labels[context.dataIndex];
                const stat = stats[cat];
                return `${cat}: ${stat.correct}/${stat.total} (${context.parsed.y}%)`;
              }
            }
          }
        }
      }
    });
    
    canvas._chart = chart;
  }

  // =========================
  // RESULTS - DASHBOARD APERFEIÇOADO
  // =========================
  function finishSimulation(byTimeout) {
    if(!appState.started){ showNotification("Nenhum simulado em andamento.", "error"); return; }

    stopTimer();
    showProgressBar(false);

    appState.endTime=Date.now();
    appState.started=false;
    appState.mode="results";
    updateHeaderStatus();

    // autocorrige as que foram marcadas mas não corrigidas
    appState.questionList.forEach(q=>{
      const ua=appState.userAnswers[q.id];
      if(ua && !ua.answered){
        const isCorrect = ua.answer === q.answer;
        appState.userAnswers[q.id] = { ...ua, answered:true, correct:isCorrect, timestamp:Date.now() };
        markHistory(q.id, isCorrect);
      }
    });

    const total=appState.questionList.length;
    const answeredKeys=Object.keys(appState.userAnswers);
    const corrected=answeredKeys.filter(k=>appState.userAnswers[k]?.answered).length;
    const correct=answeredKeys.filter(k=>appState.userAnswers[k]?.answered && appState.userAnswers[k]?.correct).length;
    const score = total>0 ? Math.round((correct/total)*100) : 0;
    const duration = calculateDuration();
    const totalTime = appState.endTime - appState.startTime;

    // Calcula métricas avançadas
    const timeEfficiency = calculateTimeEfficiency(totalTime, total, correct);
    const consistency = calculateConsistency(appState.userAnswers);
    const performance = getPerformanceLevel(score);
    
    // Calcula streak máximo
    let maxStreak = 0;
    let currentStreak = 0;
    Object.values(appState.userAnswers).forEach(ans => {
      if (ans.answered && ans.correct) {
        currentStreak++;
        maxStreak = Math.max(maxStreak, currentStreak);
      } else {
        currentStreak = 0;
      }
    });

    // Stats por tema para tópicos fracos
    const themeStats={};
    appState.questionList.forEach(q=>{
      const t=q.theme || "Geral";
      if(!themeStats[t]) themeStats[t]={total:0, correct:0};
      themeStats[t].total++;
      const ua=appState.userAnswers[q.id];
      if(ua?.answered && ua.correct) themeStats[t].correct++;
    });

    // Stats por nível
    const levelStats={};
    appState.questionList.forEach(q=>{
      const lv=q.level || "—";
      if(!levelStats[lv]) levelStats[lv]={total:0, correct:0};
      levelStats[lv].total++;
      const ua=appState.userAnswers[q.id];
      if(ua?.answered && ua.correct) levelStats[lv].correct++;
    });

    // Salva histórico
    saveSimulationHistory({
      score,
      total,
      correct,
      duration,
      weakTopics: Object.entries(themeStats)
        .filter(([_, stats]) => stats.total >= 3)
        .map(([theme, stats]) => ({
          theme,
          accuracy: Math.round((stats.correct / stats.total) * 100)
        }))
        .sort((a, b) => a.accuracy - b.accuracy)
        .slice(0, 3)
    });

    const avgScore = getAverageScore();

    el.options.innerHTML="";
    el.feedback.classList.remove("show");

    el.qText.textContent = `🎯 Simulado Finalizado — ${performance.emoji} ${performance.level}`;
    el.qSub.textContent = byTimeout
      ? `Tempo esgotado • ${total} questões • ${duration} • Score: ${score}%`
      : `${total} questões • ${duration} • Score: ${score}%`;

    // NOVO DASHBOARD APERFEIÇOADO COM GRÁFICO DE CATEGORIAS
    const dashHTML = `
      <div class="dashboard-grid">
        <!-- CARD 1: VISÃO GERAL -->
        <div class="dashboard-card card-lg">
          <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">
            <i class="fas fa-chart-bar"></i> Desempenho Geral
          </h3>
          
          <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:20px;">
            <div class="score-card" style="border-left: 4px solid ${performance.color};">
              <div class="score-value" style="color:${performance.color};">${score}%</div>
              <div class="score-label">Nota Final</div>
              <div class="score-desc">${performance.level}</div>
            </div>
            
            <div class="score-card">
              <div class="score-value">${correct}/${total}</div>
              <div class="score-label">Acertos</div>
              <div class="score-desc">${corrected}/${total} respondidas</div>
            </div>
            
            <div class="score-card">
              <div class="score-value">${Math.round(totalTime / total / 1000)}s</div>
              <div class="score-label">Tempo médio</div>
              <div class="score-desc">por questão</div>
            </div>
          </div>
          
          <div style="display:flex; justify-content:center; gap:32px; margin:24px 0;">
            ${generatePerformanceRings(score, timeEfficiency, consistency)}
          </div>
          
          <div style="text-align:center; margin-top:20px;">
            <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Comparação com sua média</div>
            ${generateComparisonMeter(score, avgScore)}
          </div>
        </div>

        <!-- CARD 2: BADGES E HEATMAP -->
        <div class="dashboard-card card-md">
          <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">
            <i class="fas fa-trophy"></i> Conquistas
          </h3>
          
          <div class="badge-list">
            ${generateBadges(score, total, maxStreak)}
          </div>
          
          <div style="margin-top:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <span style="font-size:13px; font-weight:850;">Frequência de Estudos</span>
              <span style="font-size:11px; color:var(--muted);">Últimos 30 dias</span>
            </div>
            <div class="heatmap">
              ${generateHeatmap()}
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:11px; color:var(--muted);">
              <span>● Pouca atividade</span>
              <span>●●●●● Muita atividade</span>
            </div>
          </div>
        </div>

        <!-- NOVO CARD: GRÁFICO DE CATEGORIAS -->
        <div class="dashboard-card card-full">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
              <i class="fas fa-chart-bar"></i> Desempenho por Categoria
            </h3>
            <div style="display:flex; gap:8px;">
              <select id="chartCategory" style="padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:12px;">
                <option value="theme">Tema</option>
                <option value="module">Módulo</option>
                <option value="chapter">Capítulo</option>
              </select>
              <button id="refreshChartBtn" class="btn-primary" style="padding:6px 12px; font-size:12px;">
                <i class="fas fa-sync-alt"></i> Atualizar
              </button>
            </div>
          </div>
          
          <div style="height:300px; position:relative;">
            <canvas id="categoryChart"></canvas>
          </div>
          
          <div style="display:flex; justify-content:center; gap:16px; margin-top:16px;">
            <div style="display:flex; align-items:center; gap:6px;">
              <div style="width:12px; height:12px; background:rgba(34, 197, 94, 0.65); border-radius:2px;"></div>
              <span style="font-size:11px; color:var(--muted);">> 70%</span>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              <div style="width:12px; height:12px; background:rgba(245, 158, 11, 0.65); border-radius:2px;"></div>
              <span style="font-size:11px; color:var(--muted);">40-70%</span>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              <div style="width:12px; height:12px; background:rgba(239, 68, 68, 0.65); border-radius:2px;"></div>
              <span style="font-size:11px; color:var(--muted);">< 40%</span>
            </div>
          </div>
        </div>

        <!-- CARD 4: TÓPICOS FRACOS -->
        <div class="dashboard-card card-full">
          <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">
            <i class="fas fa-exclamation-triangle"></i> Tópicos que Precisam de Atenção
          </h3>
          
          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:20px;">
            <div>
              <h4 style="margin:0 0 12px 0; font-size:13px; color:var(--muted);">Menor Desempenho</h4>
              ${generateWeakTopics(themeStats, total)}
            </div>
            
            <div>
              <h4 style="margin:0 0 12px 0; font-size:13px; color:var(--muted);">Por Nível de Dificuldade</h4>
              ${Object.entries(levelStats).map(([level, stats]) => {
                const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                return `
                  <div class="progress-track">
                    <div class="track-header">
                      <span>${safeText(level)}</span>
                      <span>${accuracy}% (${stats.correct}/${stats.total})</span>
                    </div>
                    <div class="track-bar">
                      <div class="track-fill" style="
                        width: ${accuracy}%;
                        background: ${accuracy >= 70 ? 'linear-gradient(90deg, #16a34a, #22c55e)' : 
                                     accuracy >= 50 ? 'linear-gradient(90deg, #f59e0b, #f97316)' : 
                                     'linear-gradient(90deg, #ef4444, #dc2626)'};
                      "></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>

        <!-- CARD 5: RECOMENDAÇÕES -->
        <div class="dashboard-card card-lg">
          <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">
            <i class="fas fa-lightbulb"></i> Plano de Ação Recomendado
          </h3>
          
          ${generateRecommendations(score, 
            Object.entries(themeStats)
              .filter(([_, stats]) => stats.total >= 3)
              .map(([theme, stats]) => ({
                theme,
                accuracy: Math.round((stats.correct / stats.total) * 100)
              }))
              .sort((a, b) => a.accuracy - b.accuracy)
              .slice(0, 3),
            timeEfficiency
          )}
          
          <div style="margin-top:20px; padding:12px; border-radius:12px; background:rgba(47,46,125,.05); border:1px solid rgba(47,46,125,.1);">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <i class="fas fa-clock" style="color:var(--b3-blue);"></i>
              <span style="font-size:13px; font-weight:850;">Próximos Passos</span>
            </div>
            <div style="font-size:12px; color:var(--muted);">
              1. Revise as questões erradas abaixo<br>
              2. Faça um simulado focado nos tópicos fracos<br>
              3. Acompanhe sua evolução no gráfico de histórico
            </div>
          </div>
        </div>

        <!-- CARD 6: ESTATÍSTICAS RÁPIDAS -->
        <div class="dashboard-card card-md">
          <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px;">
            <i class="fas fa-chart-pie"></i> Estatísticas
          </h3>
          
          <div style="display:grid; gap:12px;">
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Eficiência de Tempo</div>
              <div class="track-bar">
                <div class="track-fill" style="
                  width: ${timeEfficiency}%;
                  background: ${timeEfficiency >= 70 ? 'linear-gradient(90deg, #16a34a, #22c55e)' : 
                               timeEfficiency >= 50 ? 'linear-gradient(90deg, #f59e0b, #f97316)' : 
                               'linear-gradient(90deg, #ef4444, #dc2626)'};
                "></div>
              </div>
              <div style="font-size:12px; text-align:right; margin-top:4px;">${Math.round(timeEfficiency)}%</div>
            </div>
            
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Consistência</div>
              <div class="track-bar">
                <div class="track-fill" style="
                  width: ${consistency}%;
                  background: ${consistency >= 70 ? 'linear-gradient(90deg, #16a34a, #22c55e)' : 
                               consistency >= 50 ? 'linear-gradient(90deg, #f59e0b, #f97316)' : 
                               'linear-gradient(90deg, #ef4444, #dc2626)'};
                "></div>
              </div>
              <div style="font-size:12px; text-align:right; margin-top:4px;">${Math.round(consistency)}%</div>
            </div>
            
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Maior Sequência de Acertos</div>
              <div style="font-size:20px; font-weight:950; text-align:center; color:${maxStreak >= 10 ? '#16a34a' : '#f59e0b'}">
                ${maxStreak}
              </div>
            </div>
            
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Tempo Total</div>
              <div style="font-size:20px; font-weight:950; text-align:center; color:var(--text)">
                ${duration}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">📋 Revisão das Questões</h3>
        <div style="display:flex; gap:8px;">
          <button class="btn-primary" id="backHomeBtn"><i class="fas fa-house"></i> Voltar ao início</button>
          <button class="btn-success" id="exportResultsBtn"><i class="fas fa-download"></i> Exportar Resultados</button>
        </div>
      </div>

      <div id="reviewList" style="margin-top:10px;"></div>
    `;

    el.feedback.className="feedback show";
    el.feedback.innerHTML = dashHTML;

    // Gerar gráfico inicial por tema
    generateCategoryChart('theme', appState.questionList, appState.userAnswers);

    // Adicionar evento para mudar categoria do gráfico
    const chartCategorySelect = document.getElementById("chartCategory");
    const refreshChartBtn = document.getElementById("refreshChartBtn");

    if (chartCategorySelect && refreshChartBtn) {
      chartCategorySelect.addEventListener("change", function() {
        generateCategoryChart(this.value, appState.questionList, appState.userAnswers);
      });
      
      refreshChartBtn.addEventListener("click", function() {
        generateCategoryChart(chartCategorySelect.value, appState.questionList, appState.userAnswers);
      });
    }

    // Gerar gráfico de temas (mantido do original)
    const themes=Object.keys(themeStats);
    const percentages=themes.map(t=>Math.round((themeStats[t].correct/themeStats[t].total)*100));
    generateThemeChart(themeStats, themes, percentages);

    // Adicionar evento para exportar resultados
    const exportResultsBtn = document.getElementById("exportResultsBtn");
    if (exportResultsBtn) {
      exportResultsBtn.addEventListener("click", () => exportResults({
        score, total, correct, duration, performance,
        timeEfficiency, consistency, maxStreak, themeStats, levelStats
      }));
    }

    const reviewList=document.getElementById("reviewList");
    if(reviewList){
      reviewList.innerHTML="";
      appState.questionList.forEach((q,idx)=>{
        const ua=appState.userAnswers[q.id];
        const correctedNow=!!ua?.answered;
        const isCorrect=correctedNow ? ua.correct : false;
        const answeredLetter=ua?.answer || "—";

        const item=document.createElement("div");
        item.className="review-item";
        item.innerHTML = `
          <div class="review-header">
            <div><strong>${idx+1}.</strong> ${safeText(q.module||"Geral")} • ${safeText(q.chapter||"Geral")} • ${safeText(q.theme||"Geral")} • <span class="kbd">${safeText(q.id)}</span></div>
            <div>${!correctedNow ? `<span class="tag">—</span>` : isCorrect ? `<span class="tag tag-success"><i class="fas fa-check"></i> OK</span>` : `<span class="tag tag-danger"><i class="fas fa-xmark"></i> ERRO</span>`}</div>
          </div>
          <div class="review-question">${safeText(q.q)}</div>
          <div class="review-answer">Sua: <strong>${safeText(answeredLetter)}</strong> • Gabarito: <strong>${safeText(q.answer)}</strong></div>
        `;

        item.addEventListener("click", ()=>{
          appState.mode="sim";
          appState.started=true;
          setView("exam");
          showProgressBar(appState.simMinutes>0);
          appState.currentIndex=idx;
          renderQuestion();
          updateHeaderStatus();
        });

        reviewList.appendChild(item);
      });
    }

    const backHomeBtn=document.getElementById("backHomeBtn");
    if(backHomeBtn){
      backHomeBtn.addEventListener("click", ()=> goHome(true));
    }

    showNotification(byTimeout ? "Tempo esgotado! Dashboard gerado com insights." : "Finalizado! Dashboard com análise completa.", "success");
  }

  // =========================
  // LIMPEZA / HOME FLOW
  // =========================
  function clearExamUI(){
    el.feedback.className="feedback";
    el.feedback.innerHTML = `
      <div class="feedback-header" id="feedbackHeader"><i class="fas fa-check-circle"></i><span>Resposta Correta!</span></div>
      <div class="feedback-body">
        <div class="feedback-tags">
          <span class="tag" id="userAnswerTag">Sua: —</span>
          <span class="tag tag-success" id="correctAnswerTag">Gabarito: —</span>
        </div>
        <div id="feedbackText"></div>
        <div class="explanation" id="explanation"></div>
      </div>
    `;

    // rebind
    el.feedbackHeader = document.getElementById("feedbackHeader");
    el.userAnswerTag = document.getElementById("userAnswerTag");
    el.correctAnswerTag = document.getElementById("correctAnswerTag");
    el.feedbackText = document.getElementById("feedbackText");
    el.explanation = document.getElementById("explanation");

    el.options.innerHTML="";
    el.progressBar.style.width="0%";
    el.timer.textContent="00:00";
    const timerBadge = document.getElementById('timerBadge');
    if(timerBadge) timerBadge.style.color = "#3b82f6";
  }

  function resetSession(){
    if(appState.started && !confirm("Resetar a sessão? O progresso do simulado atual será perdido.")) return;
    stopTimer(); showProgressBar(false);

    appState.started=false;
    appState.mode="home";
    appState.questionList=[];
    appState.currentIndex=0;
    appState.userAnswers={};
    appState.startTime=null;
    appState.endTime=null;
    appState.deadline=null;
    
    // Limpar também o estado de desconsideração
    appState.dismissedAlternatives = {};
    appState.dismissedQuestions = [];

    clearExamUI();
    setView("home");
    updateHeaderStatus();
    showNotification("Sessão resetada.", "success");
  }

  function goHome(forceReset){
    stopTimer(); showProgressBar(false);
    if(forceReset){
      appState.started=false;
      appState.questionList=[];
      appState.currentIndex=0;
      appState.userAnswers={};
      appState.startTime=null;
      appState.endTime=null;
      appState.deadline=null;
      appState.dismissedAlternatives = {};
      appState.dismissedQuestions = [];
      clearExamUI();
    }
    appState.mode="home";
    setView("home");
    updateHeaderStatus();
  }

  // =========================
  // MONTAGEM DE PROVA (TREINO / PROVA / CUSTOM_PCT)
  // =========================
  function allocateByModule(modules, totalQuestions, pctMap){
    // devolve counts por módulo somando totalQuestions
    // arredonda e ajusta resto pelo maior decimal
    const entries = modules.map(m=>{
      const pct = pctMap[m] ?? (100/modules.length);
      const raw = (pct/100) * totalQuestions;
      const flo = Math.floor(raw);
      const frac = raw - flo;
      return { m, pct, raw, flo, frac };
    });

    let assigned = entries.reduce((s,e)=>s+e.flo,0);
    let remaining = totalQuestions - assigned;

    entries.sort((a,b)=>b.frac - a.frac);
    for(let i=0; i<entries.length && remaining>0; i++){
      entries[i].flo += 1;
      remaining--;
    }

    // se sobrar negativo (ex: pct maluco), corrige
    if(remaining < 0){
      entries.sort((a,b)=>b.flo - a.flo);
      let extra = -remaining;
      for(let i=0; i<entries.length && extra>0; i++){
        if(entries[i].flo>0){ entries[i].flo -= 1; extra--; }
      }
    }

    const out={};
    entries.forEach(e=> out[e.m]=e.flo);
    return out;
  }

  function buildQuestionList(){
    if(!questionBank.length){
      showNotification("Carregue um banco de questões em Banco (JSON).", "error");
      openBank();
      return null;
    }

    const filtered = filterQuestions();
    if(!filtered.length){
      showNotification("Nenhuma questão encontrada com os filtros atuais.", "error");
      return null;
    }

    const shuffled = shuffleArray(filtered);

    // TREINO
    if(appState.configMode==="TREINO"){
      const n = Math.min(appState.simN, shuffled.length);
      return shuffled.slice(0, n);
    }

    // PROVA (60) - distribuição automática por módulo
    if(appState.configMode==="PROVA"){
      const total=60;
      const modules = uniqSorted(shuffled.map(q=>q.module || "Geral"));
      const pctAuto = {};
      modules.forEach(m=> pctAuto[m] = 100/modules.length); // distribuição automática (igualitária)
      const counts = allocateByModule(modules, total, pctAuto);

      const picked=[];
      modules.forEach(m=>{
        const pool = shuffled.filter(q=>q.module===m);
        const take = Math.min(counts[m]||0, pool.length);
        picked.push(...pool.slice(0, take));
      });

      // se faltou por falta de pool em algum módulo, completa do restante geral
      if(picked.length < total){
        const rest = shuffled.filter(q=>!picked.includes(q));
        picked.push(...rest.slice(0, total-picked.length));
      }

      return picked.slice(0, total);
    }

    // CUSTOM_PCT (60) - por módulo
    if(appState.configMode==="CUSTOM_PCT"){
      const total=60;
      const modules = uniqSorted(shuffled.map(q=>q.module || "Geral"));
      const counts = allocateByModule(modules, total, appState.customPct);

      const picked=[];
      modules.forEach(m=>{
        const pool = shuffled.filter(q=>q.module===m);
        const take = Math.min(counts[m]||0, pool.length);
        picked.push(...pool.slice(0, take));
      });

      if(picked.length < total){
        const rest = shuffled.filter(q=>!picked.includes(q));
        picked.push(...rest.slice(0, total-picked.length));
      }

      return picked.slice(0, total);
    }

    return null;
  }

  function startSimulation(){
    const list = buildQuestionList();
    if(!list || !list.length) return;

    // reset session UI (remove dash antigo)
    stopTimer();
    clearExamUI();

    appState.mode="sim";
    appState.started=true;
    appState.questionList=list;
    appState.currentIndex=0;
    appState.userAnswers={};
    appState.startTime=Date.now();
    appState.endTime=null;
    appState.deadline=null;
    
    // Limpar estado de desconsideração para novo simulado
    appState.dismissedAlternatives = {};
    appState.dismissedQuestions = [];

    setView("exam");
    closeConfig();
    showProgressBar(true);
    if(appState.simMinutes>0) startTimer();
    else el.timer.textContent="Sem tempo";

    renderQuestion();
    updateHeaderStatus();
    showNotification("Modo prova iniciado!", "success");
  }

  // =========================
  // MODALS OPEN/CLOSE
  // =========================
  function openModal(backdrop){ backdrop.classList.add("show"); backdrop.setAttribute("aria-hidden","false"); }
  function closeModal(backdrop){ backdrop.classList.remove("show"); backdrop.setAttribute("aria-hidden","true"); }

  function openBank(){ openModal(el.bankBackdrop); }
  function closeBank(){ closeModal(el.bankBackdrop); }

  function openConfig(){
    if(!questionBank.length) showNotification("Dica: carregue o banco antes para ter filtros completos.", "error");
    updateConfigDropdowns();
    syncConfigUI();
    openModal(el.configBackdrop);
  }
  function closeConfig(){ closeModal(el.configBackdrop); }

  function openManager(){ renderManagerList(); el.managerCount.textContent=String(questionBank.length||0); openModal(el.managerBackdrop); }
  function closeManager(){ closeModal(el.managerBackdrop); }

  function openFiles(){ 
    renderFilesList(); 
    updateAdminSection();
    openModal(el.filesBackdrop); 
  }
  function closeFiles(){ closeModal(el.filesBackdrop); }

  function openLogin(){ 
    el.loginError.style.display = "none";
    openModal(el.loginBackdrop); 
  }
  function closeLogin(){ closeModal(el.loginBackdrop); }

  // click outside to close
  [el.bankBackdrop, el.configBackdrop, el.managerBackdrop, el.filesBackdrop, el.loginBackdrop].forEach(b=>{
    b.addEventListener("click",(e)=>{ if(e.target===b) closeModal(b); });
  });

  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      if(el.bankBackdrop.classList.contains("show")) closeBank();
      if(el.configBackdrop.classList.contains("show")) closeConfig();
      if(el.managerBackdrop.classList.contains("show")) closeManager();
      if(el.filesBackdrop.classList.contains("show")) closeFiles();
      if(el.loginBackdrop.classList.contains("show")) closeLogin();
    }
  });

  // =========================
  // CONFIG UI (mode/pct)
  // =========================
  function syncConfigUI(){
    el.modeSelect.value = appState.configMode;
    el.simN.value = appState.simN;
    el.simMinutes.value = appState.simMinutes;
    el.repeatRule.value = appState.repeatRule;

    el.themeFilter.value = appState.theme;
    el.moduleFilter.value = appState.module;
    el.chapterFilter.value = appState.chapter;
    el.levelFilter.value = appState.level;

    if(appState.configMode==="CUSTOM_PCT"){
      el.pctBox.style.display="block";
      el.provaHint.style.display="none";
      renderPctList();
    }else if(appState.configMode==="PROVA"){
      el.pctBox.style.display="none";
      el.provaHint.style.display="block";
    }else{
      el.pctBox.style.display="none";
      el.provaHint.style.display="none";
    }

    // quantidade editável só no treino
    el.simN.disabled = appState.configMode !== "TREINO";
    if(appState.configMode!=="TREINO") el.simN.value = 60;
  }

  function renderPctList(){
    const modules = uniqSorted(questionBank.map(q=>q.module || "Geral"));
    if(!modules.length){
      el.pctList.innerHTML = `<div class="hint">Carregue um banco para listar módulos.</div>`;
      updatePctTotal();
      return;
    }

    // se vazio, cria padrão igualitário
    if(Object.keys(appState.customPct).length===0){
      const equal = Math.round(100/modules.length);
      modules.forEach((m,i)=>{
        appState.customPct[m] = (i===modules.length-1) ? (100 - equal*(modules.length-1)) : equal;
      });
    } else {
      // garante módulos novos
      modules.forEach(m=>{ if(appState.customPct[m]===undefined) appState.customPct[m]=0; });
    }

    el.pctList.innerHTML = "";
    modules.forEach(m=>{
      const row=document.createElement("div");
      row.className="pct-row";
      row.innerHTML = `
        <div class="tag" style="justify-content:space-between; width:100%;">
          <span><i class="fas fa-layer-group"></i> ${safeText(m)}</span>
          <span class="kbd">%</span>
        </div>
        <input type="number" min="0" max="100" value="${Number(appState.customPct[m]||0)}" data-mod="${safeText(m)}">
      `;
      const inp=row.querySelector("input");
      inp.addEventListener("input",(e)=>{
        const mod = e.target.getAttribute("data-mod");
        appState.customPct[mod] = Number(e.target.value || 0);
        updatePctTotal();
      });
      el.pctList.appendChild(row);
    });

    updatePctTotal();
  }

  function updatePctTotal(){
    const total = Object.values(appState.customPct||{}).reduce((s,v)=>s+Number(v||0),0);
    el.pctTotal.textContent = `${total}%`;
    if(total!==100){
      el.pctWarn.textContent = " (precisa ser 100%)";
      el.pctWarn.className = "warn";
    } else {
      el.pctWarn.textContent = "";
      el.pctWarn.className = "";
    }
  }

  // =========================
  // GERENCIADOR (CRUD) - mais fácil
  // =========================
  function renderManagerList(){
    const q=(el.searchQuestions.value||"").trim().toLowerCase();
    const list = questionBank.filter(item=>{
      const hay = [
        item.id, item.module, item.chapter, item.theme, item.level, item.q,
        item.options?.A, item.options?.B, item.options?.C, item.options?.D,
        item.answer, item.explain
      ].map(v=>String(v||"").toLowerCase()).join(" ");
      return hay.includes(q);
    });

    el.managerCount.textContent = String(questionBank.length || 0);
    el.questionList.innerHTML="";

    if(!list.length){
      el.questionList.innerHTML = `<div class="hint">Nenhuma questão encontrada.</div>`;
      return;
    }

    list.slice(0,500).forEach(item=>{
      const row=document.createElement("div");
      row.className="qrow";
      row.innerHTML = `
        <div class="mini">
          <span class="tag tag-primary"><i class="fas fa-hashtag"></i> ${safeText(item.id)}</span>
          <span class="tag"><i class="fas fa-layer-group"></i> ${safeText(item.module||"Geral")}</span>
          <span class="tag"><i class="fas fa-book"></i> ${safeText(item.chapter||"Geral")}</span>
          <span class="tag"><i class="fas fa-tag"></i> ${safeText(item.theme||"Geral")}</span>
          <span class="tag"><i class="fas fa-signal"></i> ${safeText(item.level||"Médio")}</span>
          <span class="tag"><i class="fas fa-check"></i> ${safeText(item.answer||"—")}</span>
        </div>
        <div class="title">${safeText(item.q||"")}</div>
        <div class="actions">
          <button class="btn-primary" data-act="edit"><i class="fas fa-pen"></i> Editar</button>
          <button class="btn-danger" data-act="del"><i class="fas fa-trash"></i> Excluir</button>
        </div>
      `;

      row.querySelector('[data-act="edit"]').addEventListener("click",()=>loadQuestionIntoForm(item.id));
      row.querySelector('[data-act="del"]').addEventListener("click",()=>deleteQuestion(item.id));

      el.questionList.appendChild(row);
    });

    if(list.length>500){
      const note=document.createElement("div");
      note.className="hint";
      note.textContent="Mostrando as primeiras 500 questões (use a busca para refinar).";
      el.questionList.appendChild(note);
    }
  }

  function loadQuestionIntoForm(id){
    const item=questionBank.find(q=>q.id===id);
    if(!item) return;

    el.qIdInput.value=item.id||"";
    el.qLevelInput.value=item.level||"Médio";
    el.qModuleInput.value=item.module||"Geral";
    el.qChapterInput.value=item.chapter||"Geral";
    el.qThemeInput.value=item.theme||"Geral";
    el.qTextInput.value=item.q||"";

    el.optA.value=item.options?.A||"";
    el.optB.value=item.options?.B||"";
    el.optC.value=item.options?.C||"";
    el.optD.value=item.options?.D||"";

    el.answerInput.value=item.answer||"A";
    el.explainInput.value=item.explain||"";
    showNotification("Questão carregada para edição.", "success");
  }

  function clearForm(){
    el.qIdInput.value="";
    el.qLevelInput.value="Médio";
    el.qModuleInput.value="";
    el.qChapterInput.value="";
    el.qThemeInput.value="";
    el.qTextInput.value="";
    el.optA.value=""; el.optB.value=""; el.optC.value=""; el.optD.value="";
    el.answerInput.value="A";
    el.explainInput.value="";
  }

  function upsertQuestion(){
    const id=(el.qIdInput.value||"").trim();
    const level=el.qLevelInput.value||"Médio";
    const module=(el.qModuleInput.value||"").trim() || "Geral";
    const chapter=(el.qChapterInput.value||"").trim() || "Geral";
    const theme=(el.qThemeInput.value||"").trim() || "Geral";
    const qtext=(el.qTextInput.value||"").trim();

    const A=(el.optA.value||"").trim();
    const B=(el.optB.value||"").trim();
    const C=(el.optC.value||"").trim();
    const D=(el.optD.value||"").trim();
    const ans=el.answerInput.value||"A";
    const explain=(el.explainInput.value||"").trim();

    if(!id || !qtext || !A || !B || !C || !D){
      showNotification("Preencha: ID, Enunciado e alternativas A–D.", "error"); return;
    }
    if(!["A","B","C","D"].includes(ans)){ showNotification("Gabarito inválido.", "error"); return; }

    const newItem = normalizeQuestion({
      id, module, chapter, theme, level,
      q: qtext,
      options:{A,B,C,D},
      answer: ans,
      explain
    });

    const idx=questionBank.findIndex(q=>q.id===id);
    if(idx>=0) questionBank[idx]=newItem;
    else questionBank.push(newItem);

    updateHeaderStatus();
    updateConfigDropdowns();
    renderManagerList();
    showNotification(idx>=0 ? "Questão atualizada." : "Questão adicionada.", "success");
  }

  function deleteQuestion(id){
    if(!confirm(`Excluir a questão ${id}?`)) return;
    questionBank = questionBank.filter(q=>q.id!==id);
    updateHeaderStatus();
    updateConfigDropdowns();
    renderManagerList();
    showNotification("Questão excluída.", "success");
  }

  // =========================
  // BANCO: IMPORT / EXPORT
  // =========================
  function computeBankSummary(parsed, fileName){
    const themes=uniqSorted(parsed.map(q=>q.theme));
    const modules=uniqSorted(parsed.map(q=>q.module));
    const chapters=uniqSorted(parsed.map(q=>q.chapter));
    el.sumCount.textContent = String(parsed.length);
    el.sumThemes.textContent = String(themes.length);
    el.sumModules.textContent = String(modules.length);
    el.sumChapters.textContent = String(chapters.length);
    el.sumFileName.textContent = fileName || "—";
  }

  function setBankPreviewState(hasPreview){
    el.bankSummary.style.display = hasPreview ? "block" : "none";
    el.bankHint.style.display = hasPreview ? "none" : "block";
  }

  function loadBankFromText(text, fileName){
    const parsed = validateParsedBank(JSON.parse(text));
    appState.pendingParsedBank = parsed;
    appState.pendingBankName = fileName || null;

    computeBankSummary(parsed, fileName);
    setBankPreviewState(true);
  }

  function applyPendingBank(){
    if(!appState.pendingParsedBank){
      showNotification("Selecione um arquivo para carregar.", "error");
      return;
    }
    questionBank = appState.pendingParsedBank;
    appState.pendingParsedBank = null;

    // reset filtros e customPct (para não ficar "sujeira")
    appState.theme="ALL"; appState.module="ALL"; appState.chapter="ALL"; appState.level="ALL";
    appState.customPct = {};
    appState.dismissedAlternatives = {};
    appState.dismissedQuestions = [];

    updateHeaderStatus();
    updateConfigDropdowns();
    renderManagerList();

    showNotification(`Banco carregado! ${questionBank.length} questões.`, "success");
  }

  function exportBank(){
    const jsonString = JSON.stringify(questionBank, null, 2);
    const blob = new Blob([jsonString], { type:"application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`banco_questoes_pqo_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showNotification("Banco exportado em JSON.", "success");
  }

  // =========================
  // AUTENTICAÇÃO
  // =========================
  function checkAuth(){
    const token = localStorage.getItem("pqo_auth_token");
    if(token){
      // Verificar se o token é válido (simples validação)
      try{
        const payload = JSON.parse(atob(token.split('.')[1]));
        if(payload.exp > Date.now()/1000){
          appState.isAuthenticated = true;
          appState.authToken = token;
          updateAuthUI();
          return true;
        }
      }catch(e){
        // Token inválido
      }
    }
    appState.isAuthenticated = false;
    appState.authToken = null;
    updateAuthUI();
    return false;
  }

  function login(username, password){
    // Credenciais padrão
    if(username === "admin" && password === "admin"){
      // Criar token simples (não seguro para produção, mas ok para demo)
      const payload = {
        username: username,
        exp: Math.floor(Date.now()/1000) + (24 * 60 * 60) // 24 horas
      };
      const token = btoa(JSON.stringify(payload)) + "." + btoa(Date.now().toString());
      localStorage.setItem("pqo_auth_token", token);
      
      appState.isAuthenticated = true;
      appState.authToken = token;
      updateAuthUI();
      closeLogin();
      showNotification("Login realizado com sucesso!", "success");
      return true;
    }
    return false;
  }

  function logout(){
    localStorage.removeItem("pqo_auth_token");
    appState.isAuthenticated = false;
    appState.authToken = null;
    updateAuthUI();
    showNotification("Logout realizado.", "success");
  }

  function updateAuthUI(){
    if(appState.isAuthenticated){
      el.authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
      el.authBtn.title = "Logout";
    }else{
      el.authBtn.innerHTML = '<i class="fas fa-user-circle"></i>';
      el.authBtn.title = "Login";
    }
  }

  // =========================
  // GERENCIADOR DE ARQUIVOS PDF
  // =========================
  function updateAdminSection(){
    if(appState.isAuthenticated){
      el.adminSection.style.display = "block";
      el.loginPrompt.style.display = "none";
    }else{
      el.adminSection.style.display = "none";
      el.loginPrompt.style.display = "block";
    }
  }

  // Carregar arquivos do localStorage
  function loadFiles() {
    try {
      const saved = localStorage.getItem("pqo_files");
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  }

  // Salvar arquivos no localStorage
  function saveFiles(filesArray) {
    localStorage.setItem("pqo_files", JSON.stringify(filesArray));
  }

  // Converter arquivo para base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  // Adicionar novo arquivo
  async function addNewFile() {
    if(!appState.isAuthenticated){
      showNotification("Faça login como administrador para adicionar arquivos.", "error");
      openLogin();
      return;
    }
    
    const name = el.fileNameInput.value.trim();
    const file = el.fileUploadInput.files?.[0];
    
    if (!name || !file) {
      showNotification("Preencha o nome e selecione um arquivo PDF.", "error");
      return;
    }
    
    if (file.type !== "application/pdf" && !file.name.toLowerCase().endsWith(".pdf")) {
      showNotification("Somente arquivos PDF são permitidos.", "error");
      return;
    }
    
    if (file.size > 10 * 1024 * 1024) { // 10MB limite
      showNotification("O arquivo é muito grande (máx. 10MB).", "error");
      return;
    }
    
    try {
      const base64 = await fileToBase64(file);
      const files = loadFiles();
      
      // Verificar se já existe arquivo com mesmo nome
      if (files.some(f => f.name.toLowerCase() === name.toLowerCase())) {
        showNotification("Já existe um arquivo com este nome.", "error");
        return;
      }
      
      const newFile = {
        id: Date.now().toString(),
        name: name,
        filename: file.name,
        size: file.size,
        type: file.type,
        data: base64,
        date: new Date().toISOString()
      };
      
      files.push(newFile);
      saveFiles(files);
      
      // Limpar formulário
      el.fileNameInput.value = "";
      el.fileUploadInput.value = "";
      
      // Atualizar lista
      renderFilesList();
      showNotification("Arquivo adicionado com sucesso!", "success");
      
    } catch (error) {
      console.error("Erro ao adicionar arquivo:", error);
      showNotification("Erro ao processar arquivo.", "error");
    }
  }

  // Renderizar lista de arquivos
  function renderFilesList() {
    const files = loadFiles();
    el.filesList.innerHTML = "";
    
    if (files.length === 0) {
      el.filesList.innerHTML = `
        <div class="hint" style="text-align:center; padding:30px;">
          <i class="fas fa-file-circle-question" style="font-size:32px; margin-bottom:10px; opacity:.5;"></i>
          <div>Nenhum arquivo adicionado ainda.</div>
          <div style="font-size:11px; margin-top:6px;">Faça login como administrador para adicionar seus PDFs.</div>
        </div>
      `;
      return;
    }
    
    files.forEach(file => {
      const fileCard = document.createElement("div");
      fileCard.className = "file-card";
      
      // Formatar tamanho
      const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      };
      
      // Formatar data
      const formatDate = (isoString) => {
        const date = new Date(isoString);
        return date.toLocaleDateString('pt-BR');
      };
      
      fileCard.innerHTML = `
        <div class="file-icon">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="file-info">
          <div class="file-name">${safeText(file.name)}</div>
          <div class="file-meta">
            <span><i class="fas fa-hashtag"></i> ${safeText(file.filename)}</span>
            <span><i class="fas fa-weight-hanging"></i> ${formatSize(file.size)}</span>
            <span><i class="fas fa-calendar"></i> ${formatDate(file.date)}</span>
          </div>
        </div>
        <div class="file-actions">
          <div class="file-btn view" title="Visualizar">
            <i class="fas fa-eye"></i>
          </div>
          <div class="file-btn download" title="Baixar">
            <i class="fas fa-download"></i>
          </div>
          ${appState.isAuthenticated ? `<div class="file-btn delete" title="Excluir">
            <i class="fas fa-trash"></i>
          </div>` : ''}
        </div>
      `;
      
      // Eventos dos botões
      const viewBtn = fileCard.querySelector(".view");
      const downloadBtn = fileCard.querySelector(".download");
      const deleteBtn = fileCard.querySelector(".delete");
      
      // Visualizar
      viewBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        viewPDF(file);
      });
      
      // Download
      downloadBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        downloadPDF(file);
      });
      
      // Excluir (apenas se autenticado)
      if(deleteBtn){
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteFile(file.id);
        });
      }
      
      // Clicar no card também visualiza
      fileCard.addEventListener("click", () => viewPDF(file));
      
      el.filesList.appendChild(fileCard);
    });
  }

  // Visualizar PDF em modal
  function viewPDF(file) {
    closeFiles(); // Fecha o modal de arquivos
    
    // Criar modal de visualização
    const viewerModal = document.createElement("div");
    viewerModal.className = "modal-backdrop show";
    viewerModal.innerHTML = `
      <div class="modal" style="width:min(90vw,1200px); height:min(90vh,800px);">
        <div class="modal-header">
          <h3><i class="fas fa-file-pdf"></i> ${safeText(file.name)}</h3>
          <button class="modal-close" id="closeViewerBtn" title="Fechar">
            <i class="fas fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body" style="padding:0; display:flex; flex-direction:column;">
          <div style="padding:12px 16px; border-bottom:1px solid var(--border); background:var(--surface-2); 
            display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:12px; color:var(--muted);">
              <i class="fas fa-info-circle"></i> Visualizando: ${safeText(file.filename)}
            </div>
            <div style="display:flex; gap:8px;">
              <button id="downloadFromViewerBtn" class="btn-primary" style="padding:8px 12px; min-width:unset;">
                <i class="fas fa-download"></i> Baixar
              </button>
            </div>
          </div>
          <div class="pdf-viewer">
            <iframe class="pdf-iframe" src="${file.data}" title="${safeText(file.name)}"></iframe>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(viewerModal);
    
    // Fechar visualizador
    viewerModal.querySelector("#closeViewerBtn").addEventListener("click", () => {
      viewerModal.remove();
    });
    
    // Baixar da visualização
    viewerModal.querySelector("#downloadFromViewerBtn").addEventListener("click", () => {
      downloadPDF(file);
    });
    
    // Fechar ao clicar fora
    viewerModal.addEventListener("click", (e) => {
      if (e.target === viewerModal) {
        viewerModal.remove();
      }
    });
  }

  // Baixar PDF
  function downloadPDF(file) {
    const link = document.createElement("a");
    link.href = file.data;
    link.download = file.filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification(`Download iniciado: ${file.name}`, "success");
  }

  // Excluir arquivo
  function deleteFile(fileId) {
    if(!appState.isAuthenticated){
      showNotification("Faça login como administrador para excluir arquivos.", "error");
      return;
    }
    
    if (!confirm("Tem certeza que deseja excluir este arquivo?")) return;
    
    const files = loadFiles();
    const filtered = files.filter(f => f.id !== fileId);
    saveFiles(filtered);
    renderFilesList();
    showNotification("Arquivo excluído.", "success");
  }

  // Carregar arquivos padrão (opcional - seus 3 PDFs iniciais)
  function loadDefaultFiles() {
    const files = loadFiles();
    if (files.length === 0) {
      // Aqui você pode adicionar seus 3 arquivos iniciais
      // Você precisará converter seus PDFs para base64 primeiro
      // ou carregá-los via fetch se estiverem no mesmo domínio
      // showNotification("Faça login para adicionar seus PDFs.", "info");
    }
  }

  // =========================
  // TEMA (dark)
  // =========================
  function applyThemeFromStorage(){
    const saved = localStorage.getItem("pqo_theme") || "light";
    const isDark = saved==="dark";
    document.body.classList.toggle("dark", isDark);
  }
  
  function setTheme(isDark){
    document.body.classList.toggle("dark", isDark);
    localStorage.setItem("pqo_theme", isDark ? "dark" : "light");
    
    // Atualizar ícone do botão de tema
    const themeToggleBtn = el.themeToggleBtn;
    if (themeToggleBtn) {
      themeToggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      themeToggleBtn.title = isDark ? "Alternar para tema claro" : "Alternar para tema escuro";
    }
  }

  // =========================
  // EVENTS
  // =========================
  // Botão de tema
  el.themeToggleBtn.addEventListener("click",()=>{
    const isDark = document.body.classList.contains('dark');
    setTheme(!isDark);
  });

  // Header buttons
  el.openBankBtn.addEventListener("click", openBank);
  el.openConfigBtn.addEventListener("click", openConfig);
  el.openManagerBtn.addEventListener("click", openManager);
  el.openFilesBtn.addEventListener("click", openFiles);
  el.authBtn.addEventListener("click",()=>{
    if(appState.isAuthenticated){
      if(confirm("Deseja fazer logout?")) logout();
    }else{
      openLogin();
    }
  });

  el.closeBankBtn.addEventListener("click", closeBank);
  el.closeConfigBtn.addEventListener("click", closeConfig);
  el.closeManagerBtn.addEventListener("click", closeManager);
  el.closeFilesBtn.addEventListener("click", closeFiles);
  el.closeLoginBtn.addEventListener("click", closeLogin);

  el.goHomeBtn.addEventListener("click",()=>{
    if(appState.started){
      if(!confirm("Voltar ao início? O simulado atual será perdido.")) return;
      goHome(true);
    } else goHome(true);
  });

  // Home CTA
  el.homeStartBtn.addEventListener("click",()=> openConfig());
  el.homeFilesBtn.addEventListener("click", openFiles);
  el.coursePQO.addEventListener("click",(e)=>{ if(e.target && e.target.closest("button")) return; openConfig(); });
  el.courseFiles.addEventListener("click",(e)=>{ if(e.target && e.target.closest("button")) return; openFiles(); });

  // Exam buttons
  el.prevBtn.addEventListener("click", previousQuestion);
  el.nextBtn.addEventListener("click", nextQuestion);
  el.confirmBtn.addEventListener("click", confirmAnswer);
  el.finishBtn.addEventListener("click", ()=>finishSimulation(false));

  // Config inputs
  el.modeSelect.addEventListener("change",()=>{
    appState.configMode = el.modeSelect.value;
    if(appState.configMode!=="TREINO"){ appState.simN = 60; el.simN.value=60; }
    syncConfigUI();
  });
  el.simN.addEventListener("change",()=> appState.simN = parseInt(el.simN.value,10)||10);
  el.simMinutes.addEventListener("change",()=> appState.simMinutes = parseInt(el.simMinutes.value,10)||0);
  el.repeatRule.addEventListener("change",()=> appState.repeatRule = el.repeatRule.value);

  el.themeFilter.addEventListener("change",()=> appState.theme = el.themeFilter.value);
  el.moduleFilter.addEventListener("change",()=>{
    appState.module = el.moduleFilter.value;
    // quando muda módulo, ajuda UX: reset capítulo se capítulo não existir
    appState.chapter = "ALL";
    el.chapterFilter.value="ALL";
  });
  el.chapterFilter.addEventListener("change",()=> appState.chapter = el.chapterFilter.value);
  el.levelFilter.addEventListener("change",()=> appState.level = el.levelFilter.value);

  el.startBtn.addEventListener("click",()=>{
    if(appState.configMode==="CUSTOM_PCT"){
      const total = Object.values(appState.customPct||{}).reduce((s,v)=>s+Number(v||0),0);
      if(total!==100){
        showNotification("A distribuição por módulo precisa somar 100%.", "error");
        return;
      }
    }
    startSimulation();
  });

  el.resetBtn.addEventListener("click", resetSession);

  // Manager events
  el.saveQuestionBtn.addEventListener("click", upsertQuestion);
  el.clearFormBtn.addEventListener("click",()=>{ clearForm(); showNotification("Formulário limpo.", "success"); });
  el.searchQuestions.addEventListener("input", renderManagerList);

  // Bank events
  el.pickFileBtn.addEventListener("click",()=> el.jsonFileInput.click());
  el.jsonFileInput.addEventListener("change",(e)=>{
    const file=e.target.files?.[0];
    if(!file) return;

    const isJson = file.type==="application/json" || file.name.toLowerCase().endsWith(".json");
    if(!isJson){
      showNotification("Selecione um arquivo .json válido.", "error");
      e.target.value="";
      return;
    }

    const reader=new FileReader();
    reader.onload = ()=>{
      try{
        loadBankFromText(String(reader.result||""), file.name);
        showNotification("Arquivo lido. Confira o resumo e clique em Carregar banco.", "success");
      }catch(err){
        console.error(err);
        setBankPreviewState(false);
        showNotification(`Erro no JSON: ${err.message}`, "error");
      }
    };
    reader.onerror = ()=> showNotification("Não foi possível ler o arquivo.", "error");
    reader.readAsText(file, "utf-8");
    e.target.value="";
  });

  el.loadBankBtn.addEventListener("click",()=>{
    applyPendingBank();
    // atualizar UI de config/pct
    updateConfigDropdowns();
    syncConfigUI();
  });

  el.exportBtn.addEventListener("click", exportBank);

  // Files events
  el.addFileBtn.addEventListener("click", addNewFile);

  // Login events
  el.loginSubmitBtn.addEventListener("click",()=>{
    const username = el.loginUsername.value.trim();
    const password = el.loginPassword.value.trim();
    
    if(!username || !password){
      el.errorText.textContent = "Preencha login e senha";
      el.loginError.style.display = "block";
      return;
    }
    
    if(login(username, password)){
      // Sucesso - já tratado na função login
    }else{
      el.errorText.textContent = "Login ou senha incorretos";
      el.loginError.style.display = "block";
    }
  });

  // Enter para login
  el.loginPassword.addEventListener("keypress",(e)=>{
    if(e.key === "Enter"){
      el.loginSubmitBtn.click();
    }
  });

  // =========================
  // INIT
  // =========================
  function initialize(){
    applyThemeFromStorage();
    checkAuth(); // Verificar autenticação
    updateHeaderStatus();
    setView("home");
    setBankPreviewState(false);
    syncConfigUI();
    loadDefaultFiles();
    
    // Inicializar ícone do tema
    const isDark = document.body.classList.contains('dark');
    el.themeToggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    
    showNotification("Sistema inicializado.", "success");
  }

  window.addEventListener("DOMContentLoaded", initialize);
</script>
</body>
</html>