<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador de Certifica√ß√µes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* =========================================================
  VARI√ÅVEIS CSS ATUALIZADAS (Tela mais clara)
========================================================= */
:root{
  --bg:#F9FAFC;
  --panel:#FFFFFF;
  --panel-2:#F5F7FB;
  --text:#0F172A;
  --muted:#64748B;
  --border:#E2E8F0;
  --shadow:0 4px 20px rgba(15, 23, 42, 0.06);
  --shadow-light:0 2px 12px rgba(15, 23, 42, 0.04);
  --shadow-heavy:0 10px 40px rgba(15, 23, 42, 0.10);
  --brand:#1E40AF;
  --brand-2:#3B82F6;
  --brand-3:#10B981;
  --brand-light:rgba(59, 130, 246, 0.08);
  --ok:#10B981;
  --ok-light:rgba(16, 185, 129, 0.08);
  --warn:#F59E0B;
  --warn-light:rgba(245, 158, 11, 0.08);
  --bad:#EF4444;
  --bad-light:rgba(239, 68, 68, 0.08);
  --r-lg:16px;
  --r-md:12px;
  --r-sm:8px;
  --maxw: 1180px;
}

/* =========================================================
  RESET E BASE
========================================================= */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}

html,body{
  height:100%;
  font-size:14px;
}

body{
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height:1.5;
  overflow-x:hidden;
}

/* =========================================================
  TOPBAR CLAREADA (Melhoria 1)
========================================================= */
.topbar{
  height:64px;
  background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
  color: var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
  position: sticky;
  top:0;
  z-index: 100;
  border-bottom: 1px solid var(--border);
}

.topbar-inner{
  width: min(var(--maxw), calc(100% - 32px));
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  font-weight: 800;
  font-size: 18px;
  color: var(--brand);
  letter-spacing:-0.2px;
}

.brand .logo{
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--brand-2), var(--brand));
  display:grid;
  place-items:center;
  font-weight: 800;
  color: white;
  font-size: 16px;
}

.nav{
  display:flex;
  align-items:center;
  gap:24px;
  color: var(--muted);
  font-weight: 600;
  font-size: 14px;
}

.nav a{
  color: inherit;
  text-decoration:none;
  padding: 6px 0;
  position: relative;
  transition: color 0.2s;
  white-space: nowrap;
}

.nav a:hover{
  color: var(--brand-2);
}

.nav a.active{
  color: var(--brand);
  font-weight: 700;
}

.nav a.active::after{
  content:"";
  position:absolute;
  bottom:-2px;
  left:0;
  right:0;
  height:2px;
  background: var(--brand);
  border-radius:2px;
}

.top-actions{
  display:flex;
  align-items:center;
  gap:12px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 16px;
  border-radius: 20px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  font-weight: 600;
  font-size: 13px;
  white-space: nowrap;
  color: var(--text);
}

/* =========================================================
  LAYOUT GERAL
========================================================= */
.wrap{
  width: min(var(--maxw), calc(100% - 32px));
  margin: 24px auto 48px auto;
  min-height: calc(100vh - 120px);
}

/* =========================================================
  HERO CLAREADO (Melhoria 1)
========================================================= */
.hero-banner{
  background: linear-gradient(135deg, #FFFFFF 0%, #F0F4FF 100%);
  border-radius: var(--r-lg);
  padding: 40px 48px;
  position: relative;
  overflow:hidden;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 32px;
}

.hero-banner::before{
  content:"";
  position:absolute;
  top:0;
  right:0;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
  border-radius:50%;
  transform:translate(30%, -30%);
}

.hero-title{
  color: var(--text);
  font-weight: 800;
  font-size: 32px;
  letter-spacing:-0.4px;
  margin:0 0 12px 0;
  line-height:1.2;
}

.hero-sub{
  color: var(--muted);
  font-size: 16px;
  font-weight: 500;
  max-width: 700px;
  line-height:1.6;
}

/* =========================================================
  CARDS / SECTIONS
========================================================= */
.section-title{
  margin: 0 0 20px 0;
  font-size: 24px;
  font-weight: 800;
  letter-spacing:-0.3px;
  color: var(--text);
}

.toolbar{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 20px 24px;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  box-shadow: var(--shadow-light);
  margin: 24px 0;
}

.search{
  flex: 1 1 300px;
  display:flex;
  gap: 12px;
  align-items:center;
  position: relative;
}

.search input{
  width:100%;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  outline:none;
  font-weight: 500;
  font-size: 14px;
  background: var(--panel);
  transition: all .2s ease;
  color: var(--text);
}

.search input:focus{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-icon{
  position:absolute;
  right:16px;
  color: var(--muted);
  pointer-events:none;
}

/* =========================================================
  BOT√ïES
========================================================= */
.btn{
  appearance:none;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  border-radius: 12px;
  padding: 12px 20px;
  font-weight: 600;
  font-size: 14px;
  cursor:pointer;
  transition: all .2s ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  white-space: nowrap;
  outline: none;
  font-family: inherit;
}

.btn:focus-visible{
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  border-color: var(--brand-2);
}

.btn:hover{
  transform: translateY(-1px);
  box-shadow: var(--shadow);
  border-color: var(--brand-2);
}

.btn.primary{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  border-color: transparent;
  color:#fff;
  font-weight: 600;
}

.btn.primary:hover{
  transform: translateY(-1px);
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
}

.btn.ghost{
  background: transparent;
  border-color: rgba(59, 130, 246, 0.2);
  color: var(--brand-2);
}

.btn.small{
  padding: 8px 16px;
  font-size: 13px;
}

.btn.danger{
  background: linear-gradient(135deg, #EF4444, #DC2626);
  border-color: transparent;
  color: #fff;
}

.btn.danger:hover{
  box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
}

.btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none !important;
  box-shadow:none !important;
}

/* =========================================================
  GRID DE CURSOS
========================================================= */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 24px;
  margin: 24px 0;
}

.course-card{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  overflow:hidden;
  box-shadow: var(--shadow-light);
  cursor:pointer;
  transition:all .3s ease;
  display:flex;
  flex-direction: column;
  position: relative;
  height: 100%;
}

.course-card:hover{
  transform: translateY(-4px);
  box-shadow: var(--shadow);
  border-color: var(--brand-2);
}

.course-card.selected{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), var(--shadow);
}

.course-card .progress-ring{
  position:absolute;
  top: 16px;
  right: 16px;
  width: 48px;
  height: 48px;
  background: var(--panel);
  border-radius: 50%;
  display:grid;
  place-items:center;
  font-weight: 700;
  font-size: 12px;
  color: var(--brand);
  border: 2px solid var(--border);
  box-shadow: var(--shadow-light);
}

.thumb{
  height: 140px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.thumb .label{
  position:absolute;
  left:16px;
  top:16px;
  background: rgba(255,255,255,0.9);
  border: 1px solid var(--border);
  color: var(--brand);
  font-weight: 700;
  font-size: 11px;
  padding: 6px 12px;
  border-radius: 20px;
  text-transform: uppercase;
  letter-spacing: .5px;
  backdrop-filter: blur(10px);
}

.course-body{
  padding: 24px;
  display:flex;
  flex-direction: column;
  gap: 12px;
  flex: 1;
}

.course-name{
  font-weight: 700;
  font-size: 18px;
  margin:0;
  color: var(--text);
  line-height:1.3;
}

.course-desc{
  margin:0;
  color: var(--muted);
  font-weight: 500;
  font-size: 14px;
  line-height: 1.5;
  flex: 1;
}

.course-meta{
  display:flex;
  gap: 16px;
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
}

.course-meta span{
  display:flex;
  align-items:center;
  gap: 6px;
}

.course-foot{
  margin-top:auto;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.chip{
  font-size: 12px;
  font-weight: 700;
  padding: 6px 12px;
  border-radius: 20px;
  background: var(--brand-light);
  border: 1px solid rgba(59, 130, 246, 0.2);
  color: var(--brand);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: .3px;
}

/* =========================================================
  MODAIS COM SCROLL CORRETO (Melhoria 2)
========================================================= */
.backdrop{
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.7);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 20px;
  z-index: 1000;
  animation: fadeIn .2s ease;
  backdrop-filter: blur(4px);
}

.backdrop.show{
  display:flex;
}

.modal{
  width: min(900px, 100%);
  background: var(--panel);
  border-radius: 24px;
  box-shadow: var(--shadow-heavy);
  overflow:hidden;
  border: 1px solid var(--border);
  animation: slideUp .3s ease;
  display: flex;
  flex-direction: column;
  max-height: 90vh;
}

.modal-head{
  padding: 24px 32px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  background: var(--panel);
  flex-shrink: 0;
}

.modal-head h2{
  margin:0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.modal-body{
  padding: 32px;
  overflow-y: auto;
  flex: 1;
  max-height: calc(90vh - 160px);
}

.modal-foot{
  padding: 24px 32px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* =========================================================
  CAMPOS DE FORMUL√ÅRIO
========================================================= */
.fields{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

.field{
  display:flex;
  flex-direction: column;
  gap: 8px;
}

.field.full{
  grid-column: 1 / -1;
}

.field label{
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  text-transform: none;
  letter-spacing: 0;
}

.field input,.field select,.field textarea{
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  outline:none;
  font-weight: 500;
  font-size: 14px;
  background: var(--panel);
  transition: all .2s ease;
  color: var(--text);
  font-family: inherit;
}

.field input:focus,.field select:focus,.field textarea:focus{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.field .hint{
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
  line-height:1.4;
}

/* =========================================================
  WIZARD STEPS
========================================================= */
.steps{
  display:flex;
  align-items:center;
  gap: 8px;
  margin-bottom: 32px;
  overflow-x: auto;
  padding-bottom: 8px;
}

.step{
  flex: 1;
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 16px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--panel);
  transition: all .2s ease;
  min-width: 180px;
}

.step.active{
  border-color: var(--brand-2);
  background: var(--brand-light);
}

.step .dot{
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display:grid;
  place-items:center;
  font-weight: 700;
  color: var(--muted);
  background: var(--panel-2);
  transition: all .2s ease;
  flex-shrink: 0;
}

.step.active .dot{
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  transform: scale(1.1);
}

.step .meta{
  line-height: 1.2;
  overflow: hidden;
}

.step .meta b{
  font-size: 14px;
  font-weight: 600;
  display:block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.step .meta span{
  display:block;
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
  margin-top:2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* =========================================================
  CARDS DE MODALIDADE
========================================================= */
.mode-cards{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

.mode{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  background: var(--panel);
  cursor:pointer;
  transition:all .2s ease;
  display:flex;
  gap: 16px;
  align-items:flex-start;
}

.mode:hover{
  transform: translateY(-2px);
  border-color: var(--brand-2);
  box-shadow: var(--shadow);
}

.mode.selected{
  border-color: var(--brand-2);
  background: var(--brand-light);
  box-shadow: var(--shadow-light);
}

.mode .radio{
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid var(--muted);
  margin-top: 2px;
  position: relative;
  flex-shrink: 0;
  transition: all .2s ease;
}

.mode.selected .radio{
  border-color: var(--brand-2);
  background: var(--brand-2);
}

.mode.selected .radio::after{
  content:"";
  position:absolute;
  inset: 4px;
  border-radius: 50%;
  background: white;
  animation: fadeIn .2s ease;
}

.mode h3{
  margin:0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
}

.mode p{
  margin:8px 0 0 0;
  font-size: 14px;
  color: var(--muted);
  font-weight: 500;
  line-height: 1.5;
}

/* =========================================================
  DISTRIBUI√á√ÉO POR M√ìDULO
========================================================= */
.dist-box{
  margin-top: 16px;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  background: var(--panel-2);
  padding: 20px;
}

.dist-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.dist-title{
  font-weight: 600;
  color: var(--text);
  display:flex;
  align-items:center;
  gap: 8px;
  font-size: 15px;
}

.dist-controls{
  display:flex;
  align-items:center;
  gap: 12px;
  flex-wrap: wrap;
}

.pill-mini{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 12px;
  border-radius: 20px;
  background: var(--panel);
  border: 1px solid var(--border);
  font-weight: 600;
  font-size: 13px;
}

.dist-table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  overflow: hidden;
  border-radius: 12px;
  border: 1px solid var(--border);
  background:var(--panel);
}

.dist-table th{
  text-align:left;
  padding: 12px 16px;
  background: var(--panel-2);
  color: var(--text);
  font-weight: 600;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

.dist-table td{
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  font-weight: 500;
}

.dist-table tr:last-child td{
  border-bottom: 0;
}

.dist-input{
  width: 120px;
  max-width: 100%;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  outline: none;
  font-weight: 500;
  text-align: right;
  background: var(--panel);
  color: var(--text);
}

.dist-input:focus{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.dist-note{
  margin-top: 12px;
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
  line-height:1.5;
}

.kpi-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background:var(--panel);
  font-size: 13px;
  font-weight: 600;
}

.kpi-badge.ok{
  border-color: rgba(16, 185, 129, 0.3);
  background: var(--ok-light);
  color: var(--ok);
}

.kpi-badge.bad{
  border-color: rgba(239, 68, 68, 0.3);
  background: var(--bad-light);
  color: var(--bad);
}

/* =========================================================
  QUIZ LAYOUT (Melhoria 2 e 3)
========================================================= */
.quiz-shell{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow);
  overflow:hidden;
  margin: 24px 0;
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 160px);
}

.quiz-top{
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
}

.quiz-top .left{
  display:flex;
  align-items:center;
  gap: 20px;
  flex-wrap: wrap;
}

.q-counter{
  font-weight: 700;
  font-size: 20px;
  color: var(--brand);
  background: var(--brand-light);
  padding: 8px 16px;
  border-radius: 12px;
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.q-mini{
  display:flex;
  gap: 12px;
  align-items:center;
  flex-wrap: wrap;
  color: var(--muted);
  font-weight: 500;
  font-size: 14px;
}

.q-mini .sep{
  opacity:0.3;
}

.progress{
  width: 100%;
  height: 8px;
  background: var(--panel-2);
  border-radius: 4px;
  overflow:hidden;
  margin-top: 12px;
  flex-shrink: 0;
}

.progress > div{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--brand-2), var(--brand-3));
  border-radius: 4px;
  transition: width .3s ease;
}

.quiz-body{
  padding: 32px 32px 24px 32px;
  background: var(--panel);
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

.quiz-header{
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.quiz-header-left{
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
}

.star-btn{
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 20px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  flex-shrink: 0;
}

.star-btn:hover{
  background: rgba(245, 158, 11, 0.1);
  color: var(--warn);
}

.star-btn.active{
  color: var(--warn);
  background: rgba(245, 158, 11, 0.15);
}

.q-id{
  color: var(--brand-2);
  font-weight: 700;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.q-id .difficulty{
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 20px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  font-weight: 600;
}

.quiz-header-right{
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.timer-fixed {
  font-family: 'Roboto Mono', monospace;
  font-variant-numeric: tabular-nums;
  min-width: 90px;
  text-align: right;
  font-weight: 600;
  font-size: 14px;
  color: var(--brand);
  background: var(--brand-light);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.q-text{
  margin: 0 0 32px 0;
  font-size: 16px;
  font-weight: 500;
  line-height: 1.6;
  color: var(--text);
  white-space: pre-wrap;
}

/* =========================================================
  EXPLICA√á√ÉO
========================================================= */
.explanation-box{
  margin-top: 32px;
  padding: 24px;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--panel-2);
  display: none;
  animation: fadeIn 0.3s ease;
}

.explanation-box.show{
  display: block;
}

.explanation-title{
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.explanation-content{
  font-size: 15px;
  line-height: 1.6;
  color: var(--text);
  margin: 0;
}

.result-indicator{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  margin-left: 12px;
}

.result-indicator.correct{
  background: var(--ok-light);
  color: var(--ok);
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.result-indicator.incorrect{
  background: var(--bad-light);
  color: var(--bad);
  border: 1px solid rgba(239, 68, 68, 0.3);
}

/* =========================================================
  ALTERNATIVAS COM CAIXINHA (Melhoria 4)
========================================================= */
.opts{
  margin-top: 24px;
  display:flex;
  flex-direction: column;
  gap: 12px;
}

.opt{
  display:flex;
  gap: 16px;
  align-items:flex-start;
  padding: 20px 24px;
  border-radius: 16px;
  border: 2px solid var(--border);
  background: var(--panel);
  cursor:pointer;
  transition:all .2s ease;
  position: relative;
  overflow: hidden;
}

.opt:hover{
  border-color: var(--brand-2);
  box-shadow: var(--shadow-light);
}

.opt.selected{
  border-color: var(--brand-2);
  background: var(--brand-light);
}

.opt.correct{
  border-color: var(--ok);
  background: var(--ok-light);
}

.opt.wrong{
  border-color: var(--bad);
  background: var(--bad-light);
}

.opt.excluded{
  opacity: 0.4;
  text-decoration: line-through;
  border-color: var(--border);
  background: var(--panel-2);
}

.opt.excluded:hover{
  transform:none;
  box-shadow:none;
  cursor:not-allowed;
}

/* Caixinha estilo radio/checkbox */
.opt .choice-indicator {
  width: 24px;
  height: 24px;
  border: 2px solid var(--muted);
  background: var(--panel);
  border-radius: 6px;
  margin-top: 2px;
  position: relative;
  flex: 0 0 auto;
  transition: all .2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.opt.selected .choice-indicator {
  border-color: var(--brand-2);
  background: var(--brand-2);
}

.opt.selected .choice-indicator::after {
  content: "";
  width: 12px;
  height: 12px;
  background: white;
  border-radius: 2px;
  transition: all .2s ease;
}

/* Para checkbox (m√∫ltipla escolha) - ainda n√£o implementado mas pronto */
.opt.multiple .choice-indicator {
  border-radius: 6px;
}

.opt.multiple.selected .choice-indicator::after {
  content: "‚úì";
  color: white;
  font-weight: bold;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.opt.correct .choice-indicator,
.opt.wrong .choice-indicator {
  border-color: transparent;
}

.opt.correct .choice-indicator {
  background: var(--ok);
}

.opt.wrong .choice-indicator {
  background: var(--bad);
}

.opt.correct .choice-indicator::after,
.opt.wrong .choice-indicator::after {
  content: "";
  display: none;
}

.opt .txt{
  font-size: 15px;
  font-weight: 500;
  color: var(--text);
  line-height: 1.5;
  white-space: pre-wrap;
  flex: 1;
}

.opt .letter{
  font-weight: 600;
  color: var(--brand);
  margin-right: 8px;
}

.opt .exclude-btn{
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  color: var(--muted);
  font-size: 18px;
  transition: all 0.2s ease;
  flex-shrink: 0;
  margin-left: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.opt .exclude-btn:hover{
  color: var(--bad);
  background: rgba(239,68,68,.1);
}

.opt.excluded .exclude-btn{
  color: var(--bad);
}

.opt.excluded .exclude-btn:hover{
  color: var(--ok);
  background: rgba(16,185,129,.1);
}

/* =========================================================
  QUIZ FOOTER (Melhoria 2)
========================================================= */
.quiz-foot{
  padding: 24px 32px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 20px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

.navigation-buttons{
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
}

.finish-button{
  display: flex;
  align-items: center;
  gap: 12px;
}

/* =========================================================
  PAINEL ESQUERDO - QUESTOES (Melhoria 3 e 5)
========================================================= */
.quiz-layout{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap: 24px;
  align-items:start;
  min-height: calc(100vh - 160px);
}

.qnav{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-light);
  overflow:hidden;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 200px);
  position: sticky;
  top: 100px;
}

.qnav-head{
  padding: 20px 20px 16px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
  flex-shrink: 0;
}

.qnav-title{
  font-weight: 600;
  color: var(--text);
  font-size: 16px;
  margin-bottom: 8px;
}

.qnav-stats{
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 8px;
}

.qnav-stat{
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.qnav-stat .count{
  font-weight: 600;
  color: var(--text);
}

.qnav-grid{
  padding: 16px;
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  overflow-y: auto;
  flex: 1;
  min-height: 0;
  align-content: start;
}

.qnav-btn{
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: 12px;
  padding: 12px 0;
  font-weight: 600;
  font-size: 14px;
  cursor:pointer;
  transition: all .15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 48px;
  aspect-ratio: 1;
}

.qnav-btn:hover{
  transform: translateY(-1px);
  box-shadow: var(--shadow-light);
}

.qnav-btn.current{
  border-color: var(--brand-2);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  font-weight: 700;
}

/* Cores do Progresso estilo T2 (Melhoria 5) */
.qnav-btn.unanswered{
  background: var(--panel);
  border-color: var(--border);
}

.qnav-btn.answered{
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.3);
  color: var(--brand);
}

.qnav-btn.correct{
  background: var(--ok-light);
  border-color: rgba(16, 185, 129, 0.3);
  color: var(--ok);
}

.qnav-btn.wrong{
  background: var(--bad-light);
  border-color: rgba(239, 68, 68, 0.3);
  color: var(--bad);
}

.qnav-btn.blank{
  background: var(--panel-2);
  border-color: var(--border);
  color: var(--muted);
}

.qnav-legend{
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
}

.qnav-legend .leg{
  font-size: 12px;
  font-weight: 500;
  padding: 6px 10px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background:var(--panel);
  display: flex;
  align-items: center;
  gap: 4px;
}

.qnav-legend .leg::before{
  content:"";
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display:block;
}

.qnav-legend .unanswered::before{
  background: var(--panel-2);
  border: 1px solid var(--border);
}

.qnav-legend .answered::before{
  background: rgba(59, 130, 246, 0.3);
}

.qnav-legend .correct::before{
  background: var(--ok);
}

.qnav-legend .wrong::before{
  background: var(--bad);
}

/* =========================================================
  VIEWS
========================================================= */
.view{
  display:none;
  animation: fadeIn 0.3s ease;
}

.view.show{
  display:block;
}

/* =========================================================
  LOADING
========================================================= */
.loading{
  display:grid;
  place-items:center;
  padding: 60px;
  color: var(--muted);
  min-height: 200px;
}

.loading::after{
  content:"";
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--brand-2);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* =========================================================
  ERROR
========================================================= */
.error-card{
  background: var(--bad-light);
  border: 1px solid var(--bad);
  border-radius: var(--r-lg);
  padding: 32px;
  text-align:center;
  margin: 24px 0;
}

.error-title{
  color: var(--bad);
  font-weight: 700;
  font-size: 18px;
  margin: 0 0 12px 0;
}

/* =========================================================
  TABS
========================================================= */
.tabs{
  display:flex;
  gap: 4px;
  background: var(--panel-2);
  border-radius: 12px;
  padding: 4px;
  margin: 24px 0;
  flex-wrap: wrap;
}

.tab{
  flex: 1;
  padding: 12px 20px;
  text-align:center;
  font-weight: 600;
  font-size: 14px;
  color: var(--muted);
  cursor:pointer;
  border-radius: 8px;
  transition: all .2s ease;
  min-width: 120px;
}

.tab:hover{
  background: rgba(59, 130, 246, 0.05);
}

.tab.active{
  background: var(--panel);
  color: var(--brand);
  box-shadow: var(--shadow-light);
}

/* =========================================================
  TABLE
========================================================= */
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin: 24px 0;
  background: var(--panel);
  border-radius: var(--r-lg);
  overflow: hidden;
  border: 1px solid var(--border);
}

.table th{
  text-align:left;
  padding: 16px 20px;
  background: var(--panel-2);
  color: var(--text);
  font-weight: 600;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

.table td{
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  font-weight: 500;
}

.table tr:hover{
  background: rgba(59, 130, 246, 0.02);
}

.table tr:last-child td{
  border-bottom: 0;
}

.badge{
  display:inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .5px;
}

.badge.correct{
  background: var(--ok-light);
  color: var(--ok);
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge.incorrect{
  background: var(--bad-light);
  color: var(--bad);
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.badge.pending{
  background: var(--warn-light);
  color: var(--warn);
  border: 1px solid rgba(245, 158, 11, 0.3);
}

/* =========================================================
  EXPORT PANEL
========================================================= */
.export-panel{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 32px;
  margin: 24px 0;
  box-shadow: var(--shadow-light);
}

.export-options{
  display:flex;
  gap: 16px;
  flex-wrap:wrap;
  margin-top: 20px;
}

/* =========================================================
  MANUAIS
========================================================= */
.manual-wrap{
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-light);
  overflow:hidden;
  margin: 24px 0;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 200px);
}

.manual-head{
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
}

.manual-title{
  font-weight: 600;
  color: var(--text);
  font-size: 16px;
}

.manual-iframe{
  width: 100%;
  height: 100%;
  border: 0;
  background: var(--panel);
  flex: 1;
  min-height: 0;
}

/* =========================================================
  LOGIN
========================================================= */
.login-shell{
  width: min(900px, calc(100% - 32px));
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  align-items: stretch;
}

.login-left{
  border-radius: 20px;
  padding: 48px 40px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
  color:#fff;
  box-shadow: var(--shadow-heavy);
  display:flex;
  flex-direction: column;
  justify-content: center;
}

.login-left h1{
  margin: 0;
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -0.4px;
  line-height:1.2;
}

.login-left p{
  margin: 16px 0 0 0;
  color: rgba(255,255,255,0.9);
  font-weight: 500;
  line-height: 1.6;
  font-size: 15px;
}

.login-right{
  border-radius: 20px;
  background: var(--panel);
  box-shadow: var(--shadow-heavy);
  overflow:hidden;
  display: flex;
  flex-direction: column;
}

.login-right .head{
  padding: 32px 32px 20px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
  flex-shrink: 0;
}

.login-right .head b{
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  display: block;
  margin-bottom: 8px;
}

.login-right .body{
  padding: 32px;
  flex: 1;
}

.login-right .foot{
  padding: 24px 32px;
  border-top: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
  background: var(--panel);
  flex-shrink: 0;
}

/* =========================================================
  TOAST
========================================================= */
.toast{
  margin-top: 16px;
  padding: 16px 20px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text);
  font-weight: 500;
  font-size: 14px;
  display:none;
  white-space: pre-wrap;
  line-height: 1.5;
  animation: fadeIn .3s ease;
  box-shadow: var(--shadow);
}

.toast.show{
  display:block;
}

.toast.ok{
  border-color: rgba(16, 185, 129, 0.3);
  background: var(--ok-light);
  color: var(--ok);
}

.toast.bad{
  border-color: rgba(239, 68, 68, 0.3);
  background: var(--bad-light);
  color: var(--bad);
}

.toast.info{
  border-color: rgba(59, 130, 246, 0.3);
  background: var(--brand-light);
  color: var(--brand-2);
}

/* =========================================================
  RESPONSIVIDADE (Melhoria 6)
========================================================= */
@media (max-width: 1024px){
  .quiz-layout{
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .qnav{
    height: auto;
    max-height: 400px;
    order: 2;
    position: static;
  }
  
  .qnav-grid{
    max-height: 300px;
  }
  
  .manual-wrap{
    height: auto;
    min-height: 500px;
  }
}

@media (max-width: 768px){
  .topbar-inner{
    flex-direction: column;
    gap: 12px;
    padding: 12px 0;
    height: auto;
  }
  
  .nav{
    width: 100%;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .hero-banner{
    padding: 32px 24px;
  }
  
  .hero-title{
    font-size: 24px;
  }
  
  .hero-sub{
    font-size: 14px;
  }
  
  .grid{
    grid-template-columns: 1fr;
  }
  
  .mode-cards{
    grid-template-columns: 1fr;
  }
  
  .fields{
    grid-template-columns: 1fr;
  }
  
  .steps{
    flex-direction: column;
    gap: 8px;
  }
  
  .step{
    width: 100%;
  }
  
  .quiz-body{
    padding: 24px;
  }
  
  .quiz-foot{
    flex-direction: column;
    gap: 16px;
  }
  
  .navigation-buttons, .finish-button{
    width: 100%;
  }
  
  .navigation-buttons{
    justify-content: space-between;
  }
  
  .login-shell{
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px){
  .wrap{
    width: calc(100% - 24px);
  }
  
  .hero-banner{
    padding: 24px 20px;
  }
  
  .modal-body{
    padding: 20px;
  }
  
  .modal-foot, .modal-head{
    padding: 20px;
  }
  
  .qnav-grid{
    grid-template-columns: repeat(4, 1fr);
  }
  
  .btn{
    width: 100%;
    justify-content: center;
  }
  
  .export-options .btn{
    flex: 1;
    min-width: 120px;
  }
}

/* =========================================================
  COLLAPSIBLES
========================================================= */
.collapsible {
  margin-top: 20px;
}

.collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
  transition: all .2s ease;
}

.collapsible-header:hover {
  background: rgba(59, 130, 246, 0.05);
  border-color: var(--brand-2);
}

.collapsible-content {
  padding: 20px;
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 12px 12px;
  background: var(--panel);
  display: none;
}

.collapsible-content.show {
  display: block;
}

/* =========================================================
  CHECKLIST
========================================================= */
.checklist{
  border: 1px solid var(--border);
  border-radius: 12px;
  background:var(--panel);
  padding: 12px;
  max-height: 200px;
  overflow: auto;
}

.chk-item{
  display:flex;
  gap:12px;
  align-items:flex-start;
  padding: 10px 12px;
  border-radius: 8px;
  cursor:pointer;
  transition: background .2s ease;
}

.chk-item:hover{
  background: rgba(59, 130, 246, 0.05);
}

.chk-item input{
  margin-top: 3px;
  accent-color: var(--brand-2);
}

.chk-item b{
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

.chk-item small{
  display:block;
  margin-top: 4px;
  color: var(--muted);
  font-weight: 500;
  font-size: 12px;
}

/* =========================================================
  GR√ÅFICOS DE DESEMPENHO
========================================================= */
.chart-container {
  margin: 24px 0;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 24px;
}

.chart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 16px;
}

.chart-title {
  font-weight: 600;
  color: var(--text);
  margin: 0;
  font-size: 18px;
}

.chart-selector {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.chart-selector button {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--panel);
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--text);
}

.chart-selector button.active {
  background: var(--brand-light);
  border-color: var(--brand-2);
  color: var(--brand);
  font-weight: 600;
}

.chart-selector button:hover:not(.active) {
  background: rgba(59, 130, 246, 0.05);
  border-color: var(--brand-2);
}

.chart-bar {
  margin-bottom: 16px;
}

.bar-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 500;
}

.bar-container {
  height: 24px;
  background: var(--panel-2);
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

.bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--brand-2), var(--brand));
  border-radius: 12px;
  transition: width 0.5s ease;
  min-width: 24px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 12px;
  color: white;
  font-size: 12px;
  font-weight: 600;
}

.bar-fill.worst {
  background: linear-gradient(90deg, #EF4444, #DC2626);
}

.chart-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.stat-item {
  background: var(--panel-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}

.stat-item h4 {
  margin: 0 0 8px 0;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-item p {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
}

/* =========================================================
  BOT√ïES DE REVIS√ÉO
========================================================= */
.review-buttons {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-top: 24px;
}

/* =========================================================
  TOAST GLOBAL
========================================================= */
#globalToast {
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  z-index: 2000;
  width: min(600px, calc(100% - 32px));
  display: none;
}

#globalToastInner {
  display:block;
  margin:0;
  box-shadow: var(--shadow-heavy);
}

/* =========================================================
  UTILIT√ÅRIOS
========================================================= */
.muted{
  color: var(--muted);
  font-weight: 500;
  font-size: 14px;
  line-height: 1.5;
}

.nowrap{
  white-space: nowrap;
}

.text-center{
  text-align: center;
}

.flex-center{
  display: flex;
  align-items: center;
  justify-content: center;
}

.flex-between{
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.flex-col{
  display: flex;
  flex-direction: column;
}

.gap-4{ gap: 4px; }
.gap-8{ gap: 8px; }
.gap-12{ gap: 12px; }
.gap-16{ gap: 16px; }
.gap-20{ gap: 20px; }
.gap-24{ gap: 24px; }

.mt-4{ margin-top: 4px; }
.mt-8{ margin-top: 8px; }
.mt-12{ margin-top: 12px; }
.mt-16{ margin-top: 16px; }
.mt-20{ margin-top: 20px; }
.mt-24{ margin-top: 24px; }

.mb-4{ margin-bottom: 4px; }
.mb-8{ margin-bottom: 8px; }
.mb-12{ margin-bottom: 12px; }
.mb-16{ margin-bottom: 16px; }
.mb-20{ margin-bottom: 20px; }
.mb-24{ margin-bottom: 24px; }

/* Scrollbar personalizada */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--panel-2);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--muted);
}

/* Selection */
::selection {
  background: rgba(59, 130, 246, 0.2);
  color: var(--text);
}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">Q</div>
      Simulador de Certifica√ß√µes
    </div>
    <nav class="nav">
      <a href="#" id="navHome" class="active">Dashboard</a>
      <a href="#" id="navQuiz">Simulado</a>
      <a href="#" id="navHistory">Hist√≥rico</a>
      <a href="#" id="navStats">Estat√≠sticas</a>
      <a href="#" id="navManuals">Manuais</a>
    </nav>
    <div class="top-actions">
      <div class="pill" id="pillUser">‚Äî</div>
      <button class="btn ghost small" id="btnLogout" type="button">Sair</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section class="view show" id="viewHome">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Simulador de Certifica√ß√µes</h1>
        <div class="hero-sub">Prepare-se para a certifica√ß√£o PQO com quest√µes atualizadas e simulados personalizados. Domine o conte√∫do com nossa plataforma educacional completa.</div>
      </div>
    </div>
    <h2 class="section-title">Certifica√ß√µes Dispon√≠veis <span class="muted" id="certCount">(1)</span></h2>
    <div class="grid" id="coursesGrid"></div>
  </section>

  <!-- QUIZ -->
  <section class="view" id="viewQuiz">
    <div class="quiz-layout">
      <aside class="qnav">
        <div class="qnav-head">
          <div class="qnav-title">Quest√µes</div>
          <div class="qnav-stats">
            <div class="qnav-stat"><span class="count" id="statTotal">0</span> total</div>
            <div class="qnav-stat"><span class="count" id="statAnswered">0</span> respondidas</div>
            <div class="qnav-stat"><span class="count" id="statCorrect">0</span> corrigidas</div>
            <div class="qnav-stat"><span class="count" id="statRight">0</span> ‚úÖ</div>
            <div class="qnav-stat"><span class="count" id="statWrong">0</span> ‚ùå</div>
          </div>
        </div>
        <div class="qnav-grid" id="qnavGrid"></div>
        <div class="qnav-legend">
          <span class="leg unanswered">N√£o respondida</span>
          <span class="leg answered">Respondida</span>
          <span class="leg correct">Acertou</span>
          <span class="leg wrong">Errou</span>
        </div>
      </aside>
      <div class="quiz-shell">
        <div class="quiz-top">
          <div class="left">
            <div class="q-counter" id="qCounter">1/0</div>
            <div class="q-mini">
              <span class="timer-fixed" id="qTimer">00:00</span><span class="sep">‚Ä¢</span>
              <span id="qCourseName">‚Äî</span><span class="sep">‚Ä¢</span>
              <span id="qMeta">‚Äî</span>
              <span id="qLimitPill" class="kpi-badge" style="display:none;">‚è≥ 03:00:00</span>
            </div>
          </div>
          <div class="progress"><div id="progressBar"></div></div>
        </div>
        <div class="quiz-body">
          <div class="quiz-header">
            <div class="quiz-header-left">
              <button class="star-btn" id="btnStar" type="button" title="Marcar para revis√£o">‚òÜ</button>
              <div class="q-id">
                <span id="qId">#‚Äî</span>
                <span class="difficulty" id="qDifficulty">‚Äî</span>
              </div>
            </div>
            <div class="quiz-header-right">
              <div class="q-mini" id="qStatus"></div>
              <button class="btn ghost small" id="btnToggleExplanation" type="button" style="display:none;">üìò Explica√ß√£o</button>
            </div>
          </div>
          <p class="q-text" id="qText">‚Äî</p>
          <div class="opts" id="qOptions"></div>
          <div class="explanation-box" id="explanationBox">
            <h3 class="explanation-title">Explica√ß√£o</h3>
            <p class="explanation-content" id="explanationText"></p>
          </div>
        </div>
        <div class="quiz-foot">
          <div class="navigation-buttons">
            <button class="btn" id="btnPrev" type="button">‚Üê Anterior</button>
            <button class="btn primary" id="btnCorrect" type="button" disabled>‚úì Corrigir</button>
            <button class="btn" id="btnNext" type="button">Pr√≥xima ‚Üí</button>
          </div>
          <div class="finish-button">
            <button class="btn danger" id="btnFinish" type="button">Finalizar Simulado</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section class="view" id="viewHistory">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Hist√≥rico de Simulados</h1>
        <div class="hero-sub">Acompanhe seu progresso e revise quest√µes j√° respondidas.</div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="history">Simulados Completos</div>
      <div class="tab" data-tab="bookmarks">Quest√µes Marcadas</div>
      <div class="tab" data-tab="wrong">Erros para Revisar</div>
    </div>
    <div id="historyContent"></div>
  </section>

  <!-- ESTAT√çSTICAS -->
  <section class="view" id="viewStats">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Dashboard de Desempenho</h1>
        <div class="hero-sub">Analise seu progresso e identifique √°reas para melhorar com indicadores.</div>
      </div>
    </div>
    <div class="export-panel">
      <h3 style="margin:0 0 12px 0; font-size:18px; font-weight:600;">Exportar Dados</h3>
      <div class="muted">Exporte seu hist√≥rico para an√°lise externa ou backup.</div>
      <div class="export-options">
        <button class="btn ghost" id="btnExportCSV" type="button">üìä Exportar CSV</button>
        <button class="btn ghost" id="btnExportJSON" type="button">üìù Exportar JSON</button>
        <button class="btn ghost" id="btnExportPDF" type="button" disabled>üìÑ Exportar PDF (em breve)</button>
      </div>
    </div>
    <div id="statsContent"></div>
  </section>

  <!-- MANUAIS -->
  <section class="view" id="viewManuals">
    <div class="hero-banner">
      <div>
        <h1 class="hero-title">Manuais</h1>
        <div class="hero-sub">Acesse materiais oficiais (ex.: Guia Por Dentro da B3).</div>
      </div>
    </div>
    <div class="manual-wrap">
      <div class="manual-head">
        <div>
          <div class="manual-title">üìò GUIA POR DENTRO DA B3 (2024)</div>
          <div class="muted">Visualize no navegador ou abra em uma nova aba.</div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <a class="btn ghost" id="btnOpenManualNewTab" href="#" target="_blank" rel="noopener">üîó Abrir em nova aba</a>
          <a class="btn primary" id="btnDownloadManual" href="#" download>‚¨áÔ∏è Baixar PDF</a>
        </div>
      </div>
      <iframe class="manual-iframe" id="manualIframe" title="Manual B3"></iframe>
    </div>
  </section>
</main>

<!-- LOGIN -->
<div class="backdrop show" id="loginBackdrop" aria-hidden="false">
  <div class="login-shell" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="login-left">
      <h1>Bem-vindo üëã</h1>
      <p>Entre para acessar simulados personalizados, hist√≥rico e quest√µes marcadas.</p>
      <p style="margin-top:16px; font-size:13px; opacity:.9;">
        üîê Seus dados ficam apenas neste navegador (modo local).
      </p>
    </div>
    <div class="login-right">
      <div class="head">
        <b id="loginTitle">Login</b>
        <div class="muted">Acesso local para iniciar</div>
      </div>
      <div class="body">
        <div class="fields" style="grid-template-columns: 1fr;">
          <div class="field">
            <label for="loginUser">Usu√°rio</label>
            <input id="loginUser" type="text" placeholder="Ex.: Gustavo" autocomplete="username" />
          </div>
          <div class="field">
            <label for="loginPass">Senha</label>
            <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:var(--text);">
              <input type="checkbox" id="rememberMe" checked />
              Lembrar de mim neste dispositivo
            </label>
            <div class="hint">Primeiro acesso? Qualquer usu√°rio/senha funciona.</div>
          </div>
        </div>
        <div class="toast show info" id="loginMsg">
          ‚ö° <b>Dica:</b> depois de escolher o curso, a configura√ß√£o abre automaticamente.
        </div>
      </div>
      <div class="foot">
        <div class="muted" id="loginInfo">Acesso local ‚Ä¢ sem servidor</div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- WIZARD MODAL -->
<div class="backdrop" id="wizardBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wizTitle">
    <div class="modal-head">
      <div>
        <h2 id="wizTitle">Configurar Simulado</h2>
        <div class="muted" id="wizSub">Personalize seu simulado</div>
      </div>
      <button class="btn ghost small" id="btnCloseWizard" type="button" aria-label="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="steps">
        <div class="step active" id="step1">
          <div class="dot">1</div>
          <div class="meta"><b>Modalidade</b><span>Tipo de simulado</span></div>
        </div>
        <div class="step" id="step2">
          <div class="dot">2</div>
          <div class="meta"><b>Configura√ß√µes</b><span>Op√ß√µes gerais</span></div>
        </div>
        <div class="step" id="step3" style="display:none;">
          <div class="dot">3</div>
          <div class="meta"><b>Filtros</b><span>Personalizar quest√µes</span></div>
        </div>
        <div class="step" id="step4">
          <div class="dot">4</div>
          <div class="meta"><b>Revis√£o</b><span>Confirmar e iniciar</span></div>
        </div>
      </div>

      <!-- PAGE 1 -->
      <div class="wiz-page" id="wizPage1">
        <div class="muted" style="margin-bottom:20px;">
          Curso selecionado: <b id="wizCourseName" style="color:var(--brand);">‚Äî</b>
        </div>
        <div class="mode-cards">
          <div class="mode selected" data-mode="exam">
            <div class="radio"></div>
            <div>
              <h3>Modo Prova</h3>
              <p>60 quest√µes com limite de 3h (simulado completo).</p>
            </div>
          </div>
          <div class="mode" data-mode="custom">
            <div class="radio"></div>
            <div>
              <h3>Personalizado</h3>
              <p>Configure filtros e quantidade conforme sua necessidade.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE 2 -->
      <div class="wiz-page" id="wizPage2" style="display:none;">
        <div class="muted" style="margin-bottom:20px;">Configura√ß√µes gerais do simulado:</div>
        <div class="fields">
          <div class="field">
            <label for="selQty">Quantidade de quest√µes</label>
            <select id="selQty">
              <option value="5">5 quest√µes (r√°pido)</option>
              <option value="10">10 quest√µes</option>
              <option value="20">20 quest√µes</option>
              <option value="30">30 quest√µes</option>
              <option value="40">40 quest√µes</option>
              <option value="50">50 quest√µes</option>
              <option value="60" selected>60 quest√µes (prova completa)</option>
            </select>
          </div>
          <div class="field full">
            <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:var(--text);">
              <input id="chkNoRepeat" type="checkbox" checked />
              Evitar quest√µes j√° respondidas
            </label>
            <div class="hint">Remove quest√µes que voc√™ j√° acertou anteriormente</div>
          </div>
          <div class="field full" id="durationField">
            <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:var(--text);">
              <input id="chkOfficialDuration" type="checkbox" />
              Dura√ß√£o oficial da prova (3h)
            </label>
            <div class="hint">Se marcado, ao atingir 03:00:00 o simulado encerra automaticamente</div>
          </div>
        </div>
        <div class="muted" style="margin-top:20px; padding:16px; background:var(--panel-2); border-radius:12px; border:1px solid var(--border);">
          <b>Pr√≥ximo passo:</b> No modo personalizado voc√™ pode ajustar filtros avan√ßados.
        </div>
      </div>

      <!-- PAGE 3 -->
      <div class="wiz-page" id="wizPage3" style="display:none;">
        <div class="muted" style="margin-bottom:20px;">Filtros b√°sicos:</div>
        <div class="fields">
          <div class="field">
            <label for="selTheme">Tema</label>
            <select id="selTheme"></select>
          </div>
          <div class="field">
            <label for="selLevel">Dificuldade</label>
            <select id="selLevel"></select>
          </div>
        </div>
        
        <div class="collapsible">
          <div class="collapsible-header" id="advancedHeader">
            <span>‚öôÔ∏è Filtros Avan√ßados</span>
            <span>‚ñº</span>
          </div>
          <div class="collapsible-content" id="advancedContent">
            <div class="fields">
              <div class="field">
                <label>M√≥dulos</label>
                <div class="checklist" id="listModule"></div>
                <div class="hint">Marque um ou mais m√≥dulos (sem Ctrl/‚åò).</div>
              </div>
              <div class="field">
                <label>Cap√≠tulos</label>
                <div class="checklist" id="listChapter"></div>
                <div class="hint">Se nenhum cap√≠tulo for marcado, considera todos.</div>
              </div>
              <div class="field full">
                <label for="searchText">Busca por texto</label>
                <input id="searchText" type="text" placeholder="Ex.: CCP, nova√ß√£o, margem, op√ß√µes..." />
                <div class="hint">Busca no texto da quest√£o e alternativas</div>
              </div>
              <div class="field full">
                <label style="display:flex;align-items:center;gap:10px;font-weight:500;color:var(--text);">
                  <input id="chkDistEnable" type="checkbox" />
                  Distribuir quest√µes por t√≠tulo/cap√≠tulo (opcional)
                </label>
                <div class="hint">Defina quantidade ou percentual por t√≠tulo/cap√≠tulo conforme estrutura oficial</div>
              </div>
            </div>
            <div class="dist-box" id="distBox" style="display:none;">
              <div class="dist-head">
                <div class="dist-title">
                  üìä Distribui√ß√£o por T√≠tulo e Cap√≠tulo
                  <span class="muted" style="font-size: 12px; margin-left: 8px;">
                    (Estrutura oficial da prova)
                  </span>
                </div>
                <div class="dist-controls">
                  <span class="pill-mini">
                    <input type="radio" name="distMode" id="distModeQty" checked />
                    <label for="distModeQty" style="cursor:pointer;">Quantidade</label>
                  </span>
                  <span class="pill-mini">
                    <input type="radio" name="distMode" id="distModePct" />
                    <label for="distModePct" style="cursor:pointer;">Percentual</label>
                  </span>
                  <span id="distSumBadge" class="kpi-badge">‚Äî</span>
                </div>
              </div>
              <table class="dist-table">
                <thead>
                  <tr>
                    <th>T√≠tulo / Cap√≠tulo</th>
                    <th style="width:160px;" id="distColTitle">Quantidade</th>
                  </tr>
                </thead>
                <tbody id="distRows"></tbody>
              </table>
              <div class="dist-note" id="distNote">
                <b>üí° Como usar:</b><br>
                1. Use os campos para definir quantidades por t√≠tulo/cap√≠tulo<br>
                2. Clique em "Preencher com distribui√ß√£o oficial" para usar os percentuais da prova<br>
                3. O sistema ajustar√° automaticamente para bater a quantidade total
              </div>
            </div>
          </div>
        </div>
        <div class="toast show info" id="filterInfo" style="margin-top:20px;">‚Äî</div>
      </div>

      <!-- PAGE 4 -->
      <div class="wiz-page" id="wizPage4" style="display:none;">
        <div class="muted" style="margin-bottom:20px;">Confira as configura√ß√µes do seu simulado:</div>
        <div class="manual-wrap" style="padding:24px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:24px;">
            <div>
              <h3 style="margin:0 0 8px 0; color:var(--brand);" id="confirmTitle">Simulado</h3>
              <div class="muted" id="confirmDetails">‚Äî</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:36px; font-weight:700; color:var(--brand-2);" id="confirmQty">0</div>
              <div class="muted">quest√µes</div>
            </div>
          </div>
          <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
            <div class="muted" style="margin-bottom:12px;">Configura√ß√µes aplicadas:</div>
            <div id="confirmFilters" style="font-size:14px; font-weight:500; line-height:1.6;"></div>
          </div>
        </div>
        <div class="toast show info" style="margin-top:20px;">‚≠ê Voc√™ pode marcar quest√µes para revisar depois.</div>
      </div>
    </div>
    <div class="modal-foot">
      <div class="muted" id="wizFooter">Selecione o tipo de simulado</div>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn" id="btnPrevStep" type="button" disabled>‚Üê Voltar</button>
        <button class="btn primary" id="btnNextStep" type="button">Continuar ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE RESULTADOS -->
<div class="backdrop" id="resultsBackdrop" aria-hidden="true">
  <div class="modal" style="max-width:900px;" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
    <div class="modal-head">
      <h2 id="resultsTitle">Resultado do Simulado</h2>
      <button class="btn ghost small" id="btnCloseResults" type="button" aria-label="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="resultsContent"></div>
    </div>
    <div class="modal-foot">
      <div class="muted" id="resultsFooter">Tempo total: 00:00</div>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn ghost" id="btnReviewAll" type="button">üìö Revisar Simulado</button>
        <button class="btn ghost" id="btnReviewWrong" type="button">üìù Revisar Erros</button>
        <button class="btn ghost" id="btnExportResult" type="button">üìä Exportar</button>
        <button class="btn primary" id="btnNewSimulado" type="button">üîÑ Novo Simulado</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST GLOBAL -->
<div id="globalToast" style="
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%);
  z-index: 2000;
  width: min(600px, calc(100% - 32px));
  display: none;
">
  <div id="globalToastInner" class="toast show info" style="display:block; margin:0;"></div>
</div>

<script>
;(() => {
  'use strict';
  
  // =========================================================
  // UTILIT√ÅRIOS GLOBAIS (Bug 1 corrigido)
  // =========================================================
  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => document.querySelectorAll(sel);
  const qs = (sel) => document.querySelector(sel); // Novo helper para querySelector
  
  const LS_AUTH = "sim_auth_v4";
  const LS_HIST = "sim_hist_v4";
  const LS_SESS = "sim_sess_v4";
  const LS_BOOK = "sim_book_v4";
  const LS_STATS = "sim_stats_v4";
  const LS_EXCLUDED = "sim_excluded_v2";

  // =========================================================
  // ESTRUTURA OFICIAL DA PROVA - PQO
  // =========================================================
  const examStructure = {
    "T√çTULO I ‚Äì Aspectos institucionais (10%)": {
      weight: 10,
      chapters: {
        "Cap√≠tulo I ‚Äì Sistema Financeiro Nacional (3%)": 3,
        "Cap√≠tulo II ‚Äì Infraestrutura do mercado (4%)": 4,
        "Cap√≠tulo III ‚Äì A B3 no mercado financeiro e de capitais (3%)": 3
      }
    },
    "T√çTULO II ‚Äì Mercados de bolsa e de balc√£o (35%)": {
      weight: 35,
      chapters: {
        "Cap√≠tulo I ‚Äì Mercado de renda vari√°vel (6%)": 6,
        "Cap√≠tulo II ‚Äì Mercado de derivativos (10%)": 10,
        "Cap√≠tulo III ‚Äì Mercado de renda fixa (5%)": 5,
        "Cap√≠tulo IV ‚Äì Mercado de c√¢mbio (3%)": 3,
        "Cap√≠tulo V ‚Äì Fundos de investimento (5%)": 5,
        "Cap√≠tulo VI ‚Äì Clubes de investimento (2%)": 2,
        "Cap√≠tulo VII ‚Äì Outros ativos e servi√ßos (2%)": 2,
        "Cap√≠tulo VIII ‚Äì Tributa√ß√£o do mercado financeiro (2%)": 2
      }
    },
    "T√çTULO III ‚Äì Estrutura de contas e cadastro (3%)": {
      weight: 3,
      chapters: {
        "Cap√≠tulo I ‚Äì Cadastro de investidores residentes (2%)": 2,
        "Cap√≠tulo II ‚Äì Cadastro de investidores n√£o residentes (1%)": 1
      }
    },
    "T√çTULO IV ‚Äì Gest√£o de risco (22%)": {
      weight: 22,
      chapters: {
        "Cap√≠tulo I ‚Äì Gest√£o de risco na C√¢mara (14%)": 14,
        "Cap√≠tulo II ‚Äì Risco corporativo e controles internos (8%)": 8
      }
    },
    "T√çTULO V ‚Äì Negocia√ß√£o (8%)": {
      weight: 8,
      chapters: {
        "Cap√≠tulo I ‚Äì Mercados organizados (5%)": 5,
        "Cap√≠tulo II ‚Äì Ambiente de negocia√ß√£o (3%)": 3
      }
    },
    "T√çTULO VI ‚Äì C√¢mara de compensa√ß√£o e liquida√ß√£o (17%)": {
      weight: 17,
      chapters: {
        "Cap√≠tulo I ‚Äì C√¢mara B3 (17%)": 17
      }
    },
    "T√çTULO VII ‚Äì Central deposit√°ria (3%)": {
      weight: 3,
      chapters: {
        "Cap√≠tulo I ‚Äì Central deposit√°ria da B3 (3%)": 3
      }
    },
    "T√çTULO VIII ‚Äì Compliance (2%)": {
      weight: 2,
      chapters: {
        "Cap√≠tulo I ‚Äì PLD/FTP (0,8%)": 0.8,
        "Cap√≠tulo II ‚Äì Prote√ß√£o de dados pessoais e privacidade (0,4%)": 0.4,
        "Cap√≠tulo III ‚Äì Adequa√ß√£o ao perfil do cliente ‚Äì Suitability (0,4%)": 0.4,
        "Cap√≠tulo IV ‚Äì Opera√ß√µes il√≠citas (0,4%)": 0.4
      }
    }
  };

  // =========================================================
  // CONFIGURA√á√ÉO INICIAL
  // =========================================================
  const MANUAL_PDF = "./GUIA_POR_DENTRO_DA_B3_2024_final-min%201.pdf";
  
  const courses = [
    {
      id: "PQO",
      name: "PQO - Programa de Qualifica√ß√£o Operacional",
      desc: "Preparat√≥rio completo para a certifica√ß√£o PQO com quest√µes atualizadas do mercado financeiro.",
      jsonUrl: "./QuestoesPQO.json",
      tag: "Dispon√≠vel",
      color: "#3B82F6",
      icon: "üìà",
      stats: { questions: 0, modules: 0, avgTime: 0 }
    }
  ];

  let selectedCourse = null;
  let currentUser = null;
  
  // =========================================================
  // ESTADO DO GR√ÅFICO DE DESEMPENHO (Bug 3 corrigido)
  // =========================================================
  let perfState = {
    modules: [],
    chapters: [],
    active: 'module'
  };

  // =========================================================
  // SISTEMA DE AUTENTICA√á√ÉO
  // =========================================================
  class AuthManager {
    static getAuth() {
      try {
        let auth = JSON.parse(localStorage.getItem(LS_AUTH) || "null");
        if (!auth) auth = JSON.parse(sessionStorage.getItem(LS_AUTH) || "null");
        if (auth && Date.now() - auth.at < 30 * 24 * 60 * 60 * 1000) return auth;
      } catch {}
      return null;
    }

    static setAuth(user, remember = true) {
      const auth = {
        user,
        at: Date.now(),
        session: Date.now().toString(36) + Math.random().toString(36).substr(2)
      };
      if (remember) localStorage.setItem(LS_AUTH, JSON.stringify(auth));
      else sessionStorage.setItem(LS_AUTH, JSON.stringify(auth));
      return auth;
    }

    static clearAuth() {
      localStorage.removeItem(LS_AUTH);
      sessionStorage.removeItem(LS_AUTH);
    }

    static requireLogin() {
      const auth = AuthManager.getAuth();
      if (auth?.user) {
        currentUser = auth.user;
        $("loginBackdrop").classList.remove("show");
        $("loginBackdrop").setAttribute("aria-hidden", "true");
        $("pillUser").textContent = auth.user;
        return true;
      }
      $("loginBackdrop").classList.add("show");
      $("loginBackdrop").setAttribute("aria-hidden", "false");
      $("pillUser").textContent = "‚Äî";
      return false;
    }
  }

  // =========================================================
  // SISTEMA DE HIST√ìRICO E ESTAT√çSTICAS
  // =========================================================
  class StatsManager {
    static getHistory() {
      try {
        return JSON.parse(localStorage.getItem(LS_HIST) || "[]");
      } catch {
        return [];
      }
    }

    static addSession(session) {
      const history = StatsManager.getHistory();
      history.unshift({
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        ...session,
        completedAt: Date.now()
      });
      if (history.length > 50) history.length = 50;
      localStorage.setItem(LS_HIST, JSON.stringify(history));
      return history;
    }

    static getQuestionStats() {
      try {
        return JSON.parse(localStorage.getItem(LS_STATS) || "{}");
      } catch {
        return {};
      }
    }

    static updateQuestionStats(questionId, correct, timeSpent = 0) {
      const stats = StatsManager.getQuestionStats();
      if (!stats[questionId]) {
        stats[questionId] = {
          attempts: 0,
          correct: 0,
          totalTime: 0,
          lastAttempt: Date.now()
        };
      }
      stats[questionId].attempts++;
      stats[questionId].totalTime += timeSpent;
      stats[questionId].lastAttempt = Date.now();
      if (correct) stats[questionId].correct++;
      localStorage.setItem(LS_STATS, JSON.stringify(stats));
      return stats[questionId];
    }

    static getWeakAreas(limit = 5) {
      const stats = StatsManager.getQuestionStats();
      const areas = {};
      Object.entries(stats).forEach(([id, data]) => {
        const parts = id.split('-');
        const area = parts.slice(0, 3).join('-');
        if (!areas[area]) areas[area] = { attempts: 0, correct: 0 };
        areas[area].attempts += data.attempts;
        areas[area].correct += data.correct;
      });
      return Object.entries(areas)
        .map(([area, data]) => ({
          area,
          accuracy: data.attempts > 0 ? (data.correct / data.attempts) * 100 : 0,
          attempts: data.attempts
        }))
        .sort((a, b) => a.accuracy - b.accuracy)
        .slice(0, limit);
    }
  }

  // =========================================================
  // SISTEMA DE BOOKMARKS
  // =========================================================
  class BookmarkManager {
    static getBookmarks() {
      try {
        return JSON.parse(localStorage.getItem(LS_BOOK) || "[]");
      } catch {
        return [];
      }
    }

    static toggleBookmark(questionId) {
      const bookmarks = BookmarkManager.getBookmarks();
      const index = bookmarks.indexOf(questionId);
      if (index === -1) bookmarks.push(questionId);
      else bookmarks.splice(index, 1);
      localStorage.setItem(LS_BOOK, JSON.stringify(bookmarks));
      return index === -1;
    }

    static isBookmarked(questionId) {
      const bookmarks = BookmarkManager.getBookmarks();
      return bookmarks.includes(questionId);
    }
  }

  // =========================================================
  // SISTEMA DE EXCLUS√ÉO DE ALTERNATIVAS
  // =========================================================
  class ExclusionManager {
    static getExclusions() {
      try {
        return JSON.parse(localStorage.getItem(LS_EXCLUDED) || "{}");
      } catch {
        return {};
      }
    }

    static toggleExclusion(questionId, optionLetter) {
      const exclusions = ExclusionManager.getExclusions();
      if (!exclusions[questionId]) exclusions[questionId] = [];
      const index = exclusions[questionId].indexOf(optionLetter);
      if (index === -1) exclusions[questionId].push(optionLetter);
      else exclusions[questionId].splice(index, 1);
      localStorage.setItem(LS_EXCLUDED, JSON.stringify(exclusions));
      return index === -1;
    }

    static getExcludedOptions(questionId) {
      const exclusions = ExclusionManager.getExclusions();
      return exclusions[questionId] || [];
    }
  }

  // =========================================================
  // SISTEMA DE SESS√ÉO ATIVA
  // =========================================================
  class SessionManager {
    static saveSession(session) {
      localStorage.setItem(LS_SESS, JSON.stringify(session));
    }

    static getSession() {
      try {
        const session = JSON.parse(localStorage.getItem(LS_SESS) || "null");
        if (session && Date.now() - session.startedAt < 24 * 60 * 60 * 1000) return session;
      } catch {}
      return null;
    }

    static clearSession() {
      localStorage.removeItem(LS_SESS);
    }
  }

  // =========================================================
  // BANCO DE QUEST√ïES
  // =========================================================
  const db = {
    all: [],
    modules: [],
    chapters: [],
    themes: [],
    levels: []
  };

  async function loadCourseDb(course) {
    const res = await fetch(course.jsonUrl, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("Formato inv√°lido: esperado array");
    
    const questions = data.map((q, index) => {
      const id = String(q.id || `Q${index + 1}`).trim();
      const questionText = String(q.q || "").trim();
      const answer = String(q.answer || "").trim().toUpperCase();
      
      if (!questionText || !answer) return null;
      
      const options = {};
      ['A','B','C','D','E'].forEach(letter => {
        const optionText = q.options?.[letter] || q[`option${letter}`] || "";
        if (String(optionText || "").trim()) options[letter] = String(optionText).trim();
      });
      
      if (Object.keys(options).length === 0) return null;
      if (!options[answer]) return null;
      
      return {
        id,
        module: String(q.module || "Geral").trim(),
        chapter: String(q.chapter || "N√£o especificado").trim(),
        theme: String(q.theme || "Geral").trim(),
        level: String(q.level || "M√©dia").trim(),
        q: questionText,
        options,
        answer,
        explain: String(q.explain || "").trim()
      };
    }).filter(Boolean);
    
    if (questions.length === 0) throw new Error("Nenhuma quest√£o v√°lida encontrada no arquivo");
    return questions;
  }

  function uniqueSorted(arr) {
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b) => a.localeCompare(b, "pt-BR"));
  }

  function buildFilters() {
    db.modules = uniqueSorted(db.all.map(q => q.module));
    db.chapters = uniqueSorted(db.all.map(q => q.chapter));
    db.themes = uniqueSorted(db.all.map(q => q.theme));
    db.levels = uniqueSorted(db.all.map(q => q.level));
    
    renderChecklist($("listModule"), db.modules);
    renderChecklist($("listChapter"), db.chapters);
    fillSelectSingle($("selTheme"), db.themes, "Todos os temas");
    fillSelectSingle($("selLevel"), db.levels, "Todas as dificuldades");
    
    buildDistUI();
  }

  function fillSelectSingle(select, values, placeholder) {
    select.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = placeholder;
    select.appendChild(defaultOption);
    
    values.forEach(value => {
      const option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
  }

  function renderChecklist(container, items, getSub = null){
    if (!container) return;
    container.innerHTML = "";
    items.forEach(val => {
      const row = document.createElement("label");
      row.className = "chk-item";
      row.innerHTML = `
        <input type="checkbox" value="${escapeHtmlAttr(val)}">
        <div>
          <b>${escapeHtml(val)}</b>
          ${getSub ? `<small>${escapeHtml(getSub(val) || "")}</small>` : ''}
        </div>
      `;
      container.appendChild(row);
    });
  }

  function getCheckedValues(container){
    if (!container) return [];
    return Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
      .map(i => i.value)
      .filter(Boolean);
  }

  // =========================================================
  // NAVEGA√á√ÉO / VIEWS
  // =========================================================
  function showView(name) {
    $$('.nav a').forEach(a => a.classList.remove('active'));
    const navId = `nav${name.charAt(0).toUpperCase() + name.slice(1)}`;
    $(navId)?.classList.add('active');
    
    $$('.view').forEach(v => v.classList.remove('show'));
    const viewId = `view${name.charAt(0).toUpperCase() + name.slice(1)}`;
    $(viewId)?.classList.add('show');
    
    if (name === 'history') loadHistoryView();
    if (name === 'stats') loadStatsView();
    if (name === 'manuals') loadManuals();
  }

  function loadManuals() {
    const url = MANUAL_PDF;
    $("manualIframe").src = url;
    $("btnOpenManualNewTab").href = url;
    $("btnDownloadManual").href = url;
  }

  function loadStatsView() {
    const container = $("statsContent");
    const history = StatsManager.getHistory();
    const stats = StatsManager.getQuestionStats();
    
    if (history.length === 0) {
      container.innerHTML = `
        <div class="manual-wrap" style="padding:32px; text-align:center;">
          <h3 style="color: var(--brand); margin: 0 0 12px 0;">Nenhum dado estat√≠stico</h3>
          <div class="muted">Complete seu primeiro simulado para ver estat√≠sticas detalhadas.</div>
        </div>
      `;
      return;
    }
    
    const totalQuestions = Object.keys(stats).length;
    const totalAttempts = Object.values(stats).reduce((sum, s) => sum + s.attempts, 0);
    const totalCorrect = Object.values(stats).reduce((sum, s) => sum + s.correct, 0);
    const overallAccuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
    const avgTimePerQuestion = totalAttempts > 0 ? Math.round(Object.values(stats).reduce((sum, s) => sum + s.totalTime, 0) / totalAttempts / 1000) : 0;
    
    const weakAreas = StatsManager.getWeakAreas(5);
    
    container.innerHTML = `
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Vis√£o Geral</h3>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:32px;">
          <div class="stat-item">
            <h4>Quest√µes Estudadas</h4>
            <p>${totalQuestions}</p>
          </div>
          <div class="stat-item">
            <h4>Tentativas Totais</h4>
            <p>${totalAttempts}</p>
          </div>
          <div class="stat-item">
            <h4>Taxa de Acerto</h4>
            <p>${overallAccuracy}%</p>
          </div>
          <div class="stat-item">
            <h4>Tempo M√©dio por Quest√£o</h4>
            <p>${avgTimePerQuestion}s</p>
          </div>
        </div>
        
        <div class="chart-header">
          <h3 class="chart-title">√Åreas que Precisam de Mais Aten√ß√£o</h3>
        </div>
        ${weakAreas.length > 0 ? weakAreas.map(area => `
          <div class="chart-bar">
            <div class="bar-label">
              <span>${escapeHtml(area.area)}</span>
              <span>${area.accuracy}% (${Math.round(area.attempts)} tentativas)</span>
            </div>
            <div class="bar-container">
              <div class="bar-fill ${area.accuracy < 50 ? 'worst' : ''}" style="width: ${Math.max(5, area.accuracy)}%">
                ${area.accuracy}%
              </div>
            </div>
          </div>
        `).join('') : '<div class="muted text-center" style="padding:20px;">N√£o h√° dados suficientes para an√°lise de √°reas fracas.</div>'}
      </div>
    `;
  }

  // =========================================================
  // CURSOS (Bug 1 corrigido - usando qs em vez de $)
  // =========================================================
  function renderCourses() {
    const grid = $("coursesGrid");
    if (!grid.dataset.loaded) grid.innerHTML = '<div class="loading"></div>';
    
    setTimeout(() => {
      $("certCount").textContent = `(${courses.length})`;
      
      grid.innerHTML = courses.map(course => {
        const history = StatsManager.getHistory().filter(h => h.course === course.id);
        const totalQuestions = history.reduce((a,s)=>a+(s.totalQuestions||0),0);
        const avgAcc = history.length ? Math.round((history.reduce((a,s)=>a+(s.accuracy||0),0)/history.length)*10)/10 : 0;
        
        return `
          <div class="course-card ${selectedCourse?.id === course.id ? 'selected' : ''}" data-course="${course.id}" style="border-left: 4px solid ${course.color}">
            ${totalQuestions > 0 ? `<div class="progress-ring" title="${avgAcc}% de acerto">${avgAcc}%</div>` : ''}
            <div class="thumb" style="background: linear-gradient(135deg, ${course.color}15, ${course.color}05);">
              <div class="label">${course.tag}</div>
            </div>
            <div class="course-body">
              <h3 class="course-name">${course.icon} ${course.name}</h3>
              <p class="course-desc">${course.desc}</p>
              <div class="course-meta">
                <span title="Quest√µes dispon√≠veis">üìö ${course.stats.questions}+ quest√µes</span>
                <span title="M√≥dulos">üìñ ${course.stats.modules} m√≥dulos</span>
              </div>
              <div class="course-foot">
                <span class="chip" style="border-color: ${course.color}30; background: ${course.color}10; color: ${course.color};">${course.id}</span>
                <span class="muted" style="font-size:12px;">Clique para configurar</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      grid.dataset.loaded = true;
      
      $$('.course-card').forEach(card => {
        card.addEventListener('click', () => {
          const courseId = card.dataset.course;
          selectCourse(courses.find(c => c.id === courseId), true);
        });
      });
    }, 200);
  }

  function selectCourse(course, autoOpenWizard = false) {
    selectedCourse = course;
    $$('.course-card').forEach(c => c.classList.remove('selected'));
    
    // Bug 1 corrigido: usando qs em vez de $
    const card = qs(`[data-course="${course.id}"]`);
    if (card) card.classList.add('selected');
    
    const loadPromise = (db.all.length === 0 || (selectedCourse && db.courseId !== selectedCourse.id))
      ? loadQuestionsForCourse(course)
      : Promise.resolve();
    
    loadPromise.then(() => {
      showToast(`Curso ${course.name} selecionado`, 'info');
      if (autoOpenWizard) openWizard();
    });
  }

  async function loadQuestionsForCourse(course) {
    try {
      const loadingToast = showToast(`Carregando quest√µes de ${course.id}...`, 'info', 0);
      const questions = await loadCourseDb(course);
      db.all = questions;
      db.courseId = course.id;
      course.stats.questions = questions.length;
      course.stats.modules = new Set(questions.map(q => q.module)).size;
      
      buildFilters();
      updateFilterInfo();
      updateConfirmText();
      
      loadingToast?.remove?.();
      showToast(`‚úÖ ${questions.length} quest√µes carregadas (${course.id})`, 'ok');
    } catch (error) {
      console.error("Erro ao carregar quest√µes:", error);
      showToast(`‚ùå Erro ao carregar quest√µes: ${error.message}`, 'bad', 4500);
      $("coursesGrid").innerHTML = `
        <div class="error-card" style="grid-column: 1 / -1;">
          <div class="error-title">Erro ao Carregar Quest√µes</div>
          <div class="muted">${error.message}</div>
          <button class="btn" onclick="location.reload()" style="margin-top: 16px;">Tentar Novamente</button>
        </div>
      `;
    }
  }

  // =========================================================
  // WIZARD (Bug 2 corrigido - fluxo do exam)
  // =========================================================
  let wizStep = 1;
  let wizMode = "exam";

  function openWizard() {
    if (!selectedCourse) {
      showToast("Selecione um curso primeiro", "bad");
      return;
    }
    
    if (db.all.length === 0) {
      loadQuestionsForCourse(selectedCourse).then(openWizard);
      return;
    }
    
    $("wizardBackdrop").classList.add("show");
    $("wizardBackdrop").setAttribute("aria-hidden", "false");
    $("wizCourseName").textContent = selectedCourse.name;
    $("wizCourseName").style.color = selectedCourse.color;
    wizStep = 1;
    wizRender();
  }

  function closeWizard() {
    $("wizardBackdrop").classList.remove("show");
    $("wizardBackdrop").setAttribute("aria-hidden", "true");
  }

  function wizRender() {
    // Bug 2 corrigido: Mapeamento correto dos steps
    const maxStep = wizMode === "exam" ? 3 : 4;
    
    // Mostrar/ocultar steps baseado no modo
    $("step3").style.display = wizMode === "exam" ? "none" : "flex";
    
    // Atualizar n√∫meros dos steps
    if (wizMode === "exam") {
      $("step2 .dot").textContent = "2";
      $("step2 .meta b").textContent = "Configura√ß√µes";
      $("step4 .dot").textContent = "3";
      $("step4 .meta b").textContent = "Revis√£o";
    } else {
      $("step2 .dot").textContent = "2";
      $("step2 .meta b").textContent = "Configura√ß√µes";
      $("step3 .dot").textContent = "3";
      $("step3 .meta b").textContent = "Filtros";
      $("step4 .dot").textContent = "4";
      $("step4 .meta b").textContent = "Revis√£o";
    }
    
    // Atualizar estado dos steps
    for (let i=1; i<=4; i++){
      const stepEl = $(`step${i}`);
      if (stepEl) {
        stepEl.classList.toggle("active", i === wizStep);
        stepEl.style.display = (wizMode === "exam" && i === 3) ? "none" : "flex";
      }
      
      const pageEl = $(`wizPage${i}`);
      if (pageEl) {
        pageEl.style.display = i === wizStep ? "" : "none";
      }
    }
    
    // Atualizar bot√µes
    $("btnPrevStep").disabled = wizStep === 1;
    $("btnNextStep").disabled = false;
    $("btnNextStep").textContent = wizStep === maxStep ? "Iniciar Simulado ‚Üí" : "Continuar ‚Üí";
    
    // Atualizar textos
    const footers = [
      "Selecione o tipo de simulado",
      "Ajuste as configura√ß√µes gerais",
      "Personalize os filtros (opcional)",
      "Revise e inicie seu simulado"
    ];
    $("wizFooter").textContent = footers[wizStep-1] || "";
    $("wizSub").textContent = `Passo ${wizStep} de ${maxStep}`;
    
    // Configura√ß√µes espec√≠ficas por p√°gina
    if (wizStep === 2) {
      if (wizMode === "exam") {
        $("selQty").value = "60";
        $("chkOfficialDuration").checked = true;
        $("durationField").style.display = "none";
      } else {
        $("durationField").style.display = "block";
      }
    }
    
    if (wizStep === 3){
      updateFilterInfo();
      updateDistUIState();
    }
    if (wizStep === (wizMode === "exam" ? 3 : 4)){
      updateConfirmText();
    }
  }

  function normalizeStr(s) {
    return String(s || "").toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\s]/g, " ");
  }

  function applyWizardFilters() {
    if (!db.all || db.all.length === 0) return { base: [], qty: 0 };
    
    let modulesSel = [], chaptersSel = [], theme = "", level = "", qty = 10, noRepeat = true, search = "", official = false, distEnabled = false;
    
    if (wizMode === "exam") {
      // Modo Prova: configura√ß√µes fixas
      qty = 60;
      official = true;
      noRepeat = $("chkNoRepeat").checked;
    } else {
      // Modo Personalizado: usa filtros do usu√°rio
      modulesSel = getCheckedValues($("listModule"));
      chaptersSel = getCheckedValues($("listChapter"));
      theme = $("selTheme").value;
      level = $("selLevel").value;
      qty = Math.min(200, Math.max(1, parseInt($("selQty").value || "10", 10)));
      noRepeat = $("chkNoRepeat").checked;
      search = normalizeStr($("searchText").value);
      official = $("chkOfficialDuration").checked;
      distEnabled = $("chkDistEnable").checked;
    }
    
    const questionStats = StatsManager.getQuestionStats();
    const answeredQuestions = noRepeat ? new Set(Object.keys(questionStats).filter(id => questionStats[id].correct > 0)) : new Set();
    
    let questions = db.all.filter(q => {
      if (modulesSel.length && !modulesSel.includes(q.module)) return false;
      if (chaptersSel.length && !chaptersSel.includes(q.chapter)) return false;
      if (theme && q.theme !== theme) return false;
      if (level && q.level !== level) return false;
      if (search) {
        const big = normalizeStr([q.id,q.module,q.chapter,q.theme,q.level,q.q,...Object.values(q.options),q.explain].join(" "));
        if (!big.includes(search)) return false;
      }
      if (noRepeat && answeredQuestions.has(q.id)) return false;
      return true;
    });
    
    const shuffle = (arr) => {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };
    
    if (distEnabled && wizMode === "custom") {
      const distMode = $("distModePct").checked ? "pct" : "qty";
      const dist = readDistInputs();
      
      const chapterMap = createChapterMapping(questions);
      const availableChapters = Object.keys(chapterMap).filter(chap => chapterMap[chap].length > 0);
      
      if (availableChapters.length === 0) {
        questions = shuffle(questions).slice(0, qty);
      } else {
        const targets = calculateDistributionTargets(dist, distMode, qty, availableChapters);
        let picked = selectQuestionsByDistribution(chapterMap, targets, qty);
        
        if (picked.length < qty) {
          const pickedIds = new Set(picked.map(q => q.id));
          const remaining = shuffle(db.all.filter(q => !pickedIds.has(q.id)));
          picked = picked.concat(remaining.slice(0, qty - picked.length));
        }
        
        questions = shuffle(picked).slice(0, qty);
      }
      
      return {
        base: questions,
        qty,
        noRepeat,
        modulesSel,
        chaptersSel,
        theme,
        level,
        s: $("searchText").value.trim(),
        official,
        distEnabled,
        distMode,
        dist
      };
    }
    
    questions = shuffle(questions).slice(0, qty);
    return {
      base: questions,
      qty,
      noRepeat,
      modulesSel,
      chaptersSel,
      theme,
      level,
      s: $("searchText").value.trim(),
      official,
      distEnabled: false
    };
  }

  function createChapterMapping(questions) {
    const chapterMap = {};
    
    questions.forEach(q => {
      let foundChapter = null;
      
      Object.entries(examStructure).forEach(([title, titleData]) => {
        Object.keys(titleData.chapters).forEach(chapterName => {
          const simpleChapter = chapterName.replace(/Cap√≠tulo [IVXLCDM]+ ‚Äì /, '').toLowerCase();
          const simpleQChapter = q.chapter.toLowerCase();
          
          if (simpleQChapter.includes(simpleChapter.substring(0, 15)) || 
              simpleChapter.includes(simpleQChapter.substring(0, 15))) {
            foundChapter = chapterName;
          }
        });
      });
      
      const chapterKey = foundChapter || q.chapter;
      if (!chapterMap[chapterKey]) chapterMap[chapterKey] = [];
      chapterMap[chapterKey].push(q);
    });
    
    return chapterMap;
  }

  function calculateDistributionTargets(dist, distMode, totalQty, availableChapters) {
    const targets = {};
    let totalNeeded = 0;
    
    if (distMode === "pct") {
      availableChapters.forEach(chapter => {
        const pct = dist.chapters[chapter] || 0;
        targets[chapter] = Math.floor((pct / 100) * totalQty);
        totalNeeded += targets[chapter];
      });
    } else {
      availableChapters.forEach(chapter => {
        targets[chapter] = dist.chapters[chapter] || 0;
        totalNeeded += targets[chapter];
      });
    }
    
    // Ajustar se necess√°rio
    if (totalNeeded < totalQty) {
      const remaining = totalQty - totalNeeded;
      let i = 0;
      while (remaining > 0 && availableChapters.length > 0) {
        const chapter = availableChapters[i % availableChapters.length];
        targets[chapter] = (targets[chapter] || 0) + 1;
        totalNeeded++;
        i++;
      }
    } else if (totalNeeded > totalQty) {
      const excess = totalNeeded - totalQty;
      const chaptersWithTargets = availableChapters.filter(ch => targets[ch] > 0);
      let i = 0;
      while (excess > 0 && chaptersWithTargets.length > 0) {
        const chapter = chaptersWithTargets[i % chaptersWithTargets.length];
        if (targets[chapter] > 0) {
          targets[chapter]--;
          totalNeeded--;
          excess--;
        }
        i++;
      }
    }
    
    return targets;
  }

  function selectQuestionsByDistribution(chapterMap, targets, totalQty) {
    let picked = [];
    
    Object.entries(targets).forEach(([chapter, targetQty]) => {
      if (targetQty <= 0) return;
      
      const pool = chapterMap[chapter] || [];
      if (pool.length === 0) return;
      
      const shuffled = [...pool].sort(() => Math.random() - 0.5);
      const take = Math.min(targetQty, shuffled.length);
      picked = picked.concat(shuffled.slice(0, take));
    });
    
    return picked;
  }

  function updateFilterInfo() {
    const filtered = applyWizardFilters();
    const total = db.all.length;
    const percent = total > 0 ? Math.round((filtered.base.length / total) * 100) : 0;
    const official = wizMode === "exam" ? true : $("chkOfficialDuration").checked;
    const badge = official ? " ‚Ä¢ ‚è≥ 3h" : "";
    
    $("filterInfo").innerHTML = `
      <b>${filtered.base.length} quest√µes encontradas</b> (${percent}% do total)${badge}<br>
      <span class="muted">Base total: ${total} quest√µes</span>
    `;
    
    updateDistSumBadge();
  }

  function updateConfirmText() {
    const cfg = applyWizardFilters();
    $("confirmTitle").textContent = `Simulado ${selectedCourse?.id || ""} - ${wizMode === "exam" ? "Modo Prova" : "Personalizado"}`;
    $("confirmQty").textContent = cfg.base.length;
    
    const parts = [];
    if (wizMode === "exam") {
      parts.push(`Modo: Prova completa`);
      parts.push(`Quest√µes: 60 fixas`);
      parts.push(`Dura√ß√£o: 3h fixas`);
    } else {
      parts.push(`Modo: Personalizado`);
      parts.push(`Quest√µes: ${cfg.qty}`);
      if (cfg.official) parts.push(`Dura√ß√£o: 3h`);
      if (cfg.modulesSel?.length) parts.push(`M√≥dulos: ${cfg.modulesSel.length} selecionado(s)`);
      if (cfg.chaptersSel?.length) parts.push(`Cap√≠tulos: ${cfg.chaptersSel.length} selecionado(s)`);
      if (cfg.theme) parts.push(`Tema: ${cfg.theme}`);
      if (cfg.level) parts.push(`Dificuldade: ${cfg.level}`);
      if (cfg.s) parts.push(`Busca: "${cfg.s}"`);
    }
    if (cfg.noRepeat) parts.push(`Evitar repetidas: sim`);
    
    if (cfg.distEnabled) {
      parts.push(`Distribui√ß√£o: ${cfg.distMode === "pct" ? "percentual oficial" : "quantidade personalizada"}`);
    }
    
    $("confirmDetails").innerHTML = `${cfg.base.length} quest√µes ‚Ä¢ ${cfg.official ? "Limite 3h" : "Sem limite de tempo"}`;
    $("confirmFilters").innerHTML = parts.length ? parts.map(p => `‚Ä¢ ${p}`).join("<br>") : `<span class="muted">Nenhum filtro aplicado</span>`;
  }

  // =========================================================
  // DISTRIBUI√á√ÉO POR M√ìDULO (UI)
  // =========================================================
  function buildDistUI() {
    const tbody = $("distRows");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    Object.entries(examStructure).forEach(([title, titleData]) => {
      const titleRow = document.createElement("tr");
      titleRow.style.background = "var(--panel-2)";
      titleRow.innerHTML = `
        <td><b>${escapeHtml(title)}</b> <span style="font-size:12px; color:var(--muted);">(${titleData.weight}%)</span></td>
        <td style="text-align:right;">
          <input class="dist-input" inputmode="numeric" data-title="${escapeHtmlAttr(title)}" value="0" />
        </td>
      `;
      tbody.appendChild(titleRow);
      
      Object.entries(titleData.chapters).forEach(([chapter, chapterWeight]) => {
        const chapterRow = document.createElement("tr");
        chapterRow.innerHTML = `
          <td style="padding-left: 24px; color: var(--muted);">${escapeHtml(chapter)} <span style="font-size:12px;">(${chapterWeight}%)</span></td>
          <td style="text-align:right;">
            <input class="dist-input" inputmode="numeric" data-chapter="${escapeHtmlAttr(chapter)}" data-parent="${escapeHtmlAttr(title)}" value="0" />
          </td>
        `;
        tbody.appendChild(chapterRow);
      });
    });
    
    const autoFillRow = document.createElement("tr");
    autoFillRow.innerHTML = `
      <td colspan="2" style="text-align:center; padding-top: 16px;">
        <button class="btn ghost small" id="btnAutoFill" type="button" style="font-size: 12px;">
          üîÑ Preencher com distribui√ß√£o oficial
        </button>
      </td>
    `;
    tbody.appendChild(autoFillRow);
    
    $$("#distRows .dist-input").forEach(inp => {
      inp.addEventListener("input", () => {
        const v = String(inp.value || "").replace(/[^\d.]/g, "");
        inp.value = v;
        updateDistSumBadge();
        updateFilterInfo();
        updateConfirmText();
      });
    });
    
    $("btnAutoFill")?.addEventListener("click", autoFillDistribution);
  }

  function autoFillDistribution() {
    const qty = parseInt($("selQty").value || "10", 10);
    const mode = $("distModePct").checked ? "pct" : "qty";
    
    if (mode === "pct") {
      Object.entries(examStructure).forEach(([title, titleData]) => {
        const titleInput = qs(`input[data-title="${escapeHtmlAttr(title)}"]`);
        if (titleInput) titleInput.value = titleData.weight;
        
        Object.entries(titleData.chapters).forEach(([chapter, chapterWeight]) => {
          const chapterInput = qs(`input[data-chapter="${escapeHtmlAttr(chapter)}"]`);
          if (chapterInput) chapterInput.value = chapterWeight;
        });
      });
    } else {
      Object.entries(examStructure).forEach(([title, titleData]) => {
        const titleQty = Math.round((titleData.weight / 100) * qty);
        const titleInput = qs(`input[data-title="${escapeHtmlAttr(title)}"]`);
        if (titleInput) titleInput.value = titleQty;
        
        const totalChapterWeight = Object.values(titleData.chapters).reduce((a, b) => a + b, 0);
        Object.entries(titleData.chapters).forEach(([chapter, chapterWeight]) => {
          const chapterInput = qs(`input[data-chapter="${escapeHtmlAttr(chapter)}"]`);
          if (chapterInput && totalChapterWeight > 0) {
            const chapterQty = Math.round((chapterWeight / totalChapterWeight) * titleQty);
            chapterInput.value = Math.max(1, chapterQty);
          }
        });
      });
    }
    
    updateDistSumBadge();
    updateFilterInfo();
    updateConfirmText();
    showToast("‚úÖ Distribui√ß√£o oficial aplicada!", "ok");
  }

  function readDistInputs() {
    const out = {
      titles: {},
      chapters: {},
      allChapters: []
    };
    
    $$("#distRows input[data-title]").forEach(inp => {
      const title = inp.getAttribute("data-title");
      out.titles[title] = Number(inp.value || 0);
    });
    
    $$("#distRows input[data-chapter]").forEach(inp => {
      const chapter = inp.getAttribute("data-chapter");
      out.chapters[chapter] = Number(inp.value || 0);
      out.allChapters.push(chapter);
    });
    
    return out;
  }

  function updateDistUIState() {
    const enabled = $("chkDistEnable").checked;
    $("distBox").style.display = enabled ? "" : "none";
    updateDistSumBadge();
    updateFilterInfo();
    updateConfirmText();
  }

  function updateDistSumBadge() {
    const badge = $("distSumBadge");
    if (!badge) return;
    
    if (!$("chkDistEnable").checked) {
      badge.textContent = "Distribui√ß√£o: desligada";
      badge.className = "kpi-badge";
      return;
    }
    
    const mode = $("distModePct").checked ? "pct" : "qty";
    const dist = readDistInputs();
    const sum = Object.values(dist.chapters).reduce((a,n)=>a+(Number(n)||0),0);
    
    if (mode === "pct") {
      badge.textContent = `Soma: ${sum}%`;
      badge.className = "kpi-badge " + (Math.round(sum) === 100 ? "ok" : "bad");
      $("distColTitle").textContent = "Percentual (%)";
      $("distNote").innerHTML = `<b>üí° Como usar:</b><br>
        1. No modo percentual, a soma ideal √© 100%<br>
        2. Use "Preencher com distribui√ß√£o oficial" para preencher automaticamente<br>
        3. O sistema ajustar√° automaticamente para fechar a quantidade total`;
    } else {
      const qty = parseInt($("selQty").value || "10", 10);
      badge.textContent = `Soma: ${sum}/${qty}`;
      badge.className = "kpi-badge " + (sum === qty ? "ok" : "bad");
      $("distColTitle").textContent = "Quantidade";
      $("distNote").innerHTML = `<b>üí° Como usar:</b><br>
        1. No modo quantidade, o ideal √© a soma bater a quantidade total (${qty})<br>
        2. Use "Preencher com distribui√ß√£o oficial" para calcular automaticamente<br>
        3. Se n√£o bater, o sistema completa com o restante`;
    }
  }

  // =========================================================
  // UTILIT√ÅRIOS
  // =========================================================
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  
  function escapeHtmlAttr(s){
    return escapeHtml(s);
  }

  // =========================================================
  // SIMULADO
  // =========================================================
  const sim = {
    queue: [],
    idx: 0,
    answers: {},
    startedAt: null,
    timerId: null,
    selected: null,
    corrected: false,
    questionStartTime: null,
    excludedOptions: {},
    officialDuration: false,
    durationLimitMs: 3 * 60 * 60 * 1000,
    reviewMode: null // 'all' | 'wrong' | null
  };

  function startSimulado(config) {
    sim.queue = config.base;
    sim.idx = 0;
    sim.answers = {};
    sim.excludedOptions = {};
    sim.startedAt = Date.now();
    sim.officialDuration = !!config.official;
    sim.reviewMode = null;
    
    sim.queue.forEach(q => {
      sim.excludedOptions[q.id] = ExclusionManager.getExcludedOptions(q.id);
    });
    
    SessionManager.saveSession({
      queue: sim.queue.map(q => q.id),
      idx: sim.idx,
      answers: sim.answers,
      excludedOptions: sim.excludedOptions,
      startedAt: sim.startedAt,
      course: selectedCourse.id,
      config
    });
    
    closeWizard();
    startTimer();
    renderQuiz();
    showView("quiz");
  }

  function startTimer() {
    if (sim.timerId) clearInterval(sim.timerId);
    
    $("qLimitPill").style.display = sim.officialDuration ? "inline-flex" : "none";
    $("qLimitPill").textContent = sim.officialDuration ? "‚è≥ 03:00:00" : "";
    
    sim.timerId = setInterval(() => {
      const elapsed = Date.now() - sim.startedAt;
      $("qTimer").textContent = formatTime(elapsed);
      
      if (sim.officialDuration) {
        const remaining = sim.durationLimitMs - elapsed;
        if (remaining <= 10 * 60 * 1000 && remaining > 0) {
          $("qTimer").style.color = "var(--warn)";
          $("qTimer").style.fontWeight = "600";
        }
        if (remaining <= 60 * 1000 && remaining > 0) {
          $("qTimer").style.color = "var(--bad)";
          $("qTimer").style.fontWeight = "600";
          $("qTimer").classList.add("timer-critical");
        } else {
          $("qTimer").classList.remove("timer-critical");
        }
        if (remaining <= 0) {
          stopTimer();
          showToast("‚è±Ô∏è Tempo limite (3h) atingido. Encerrando simulado...", "bad", 3500);
          finishSimulado(true);
        }
      }
    }, 200);
  }

  function stopTimer() {
    if (sim.timerId) {
      clearInterval(sim.timerId);
      sim.timerId = null;
    }
  }

  function formatTime(ms) {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    const HH = String(h).padStart(2,'0');
    const MM = String(m).padStart(2,'0');
    const SS = String(s).padStart(2,'0');
    return h > 0 ? `${HH}:${MM}:${SS}` : `${MM}:${SS}`;
  }

  function renderQuiz() {
    const total = sim.queue.length;
    const current = sim.queue[sim.idx];
    if (!current) {
      finishSimulado(false);
      return;
    }
    
    $("qCounter").textContent = `${sim.idx + 1}/${total}`;
    $("qCourseName").textContent = selectedCourse.name;
    $("qMeta").textContent = `${current.module} ‚Ä¢ ${current.theme}`;
    $("qId").textContent = `#${current.id}`;
    $("qDifficulty").textContent = current.level;
    $("qText").textContent = current.q;
    
    const savedAnswer = sim.answers[current.id];
    sim.selected = savedAnswer?.selected || null;
    sim.corrected = savedAnswer?.corrected || false;
    
    const progress = ((sim.idx) / total) * 100;
    $("progressBar").style.width = `${progress}%`;
    sim.questionStartTime = Date.now();
    
    $("btnPrev").disabled = sim.idx === 0;
    $("btnNext").disabled = false;
    $("btnCorrect").disabled = sim.corrected || !sim.selected || sim.reviewMode !== null;
    
    updateStarButton(current.id);
    updateQuestionStatus(savedAnswer);
    
    // Controle de explica√ß√£o
    const showExplanationBtn = $("btnToggleExplanation");
    if (sim.reviewMode !== null || (savedAnswer?.corrected && savedAnswer?.showExplanation)) {
      showExplanation(current, savedAnswer?.correct);
      showExplanationBtn.style.display = "inline-flex";
      showExplanationBtn.textContent = "üìò Ocultar explica√ß√£o";
    } else {
      $("explanationBox").classList.remove("show");
      showExplanationBtn.style.display = savedAnswer?.corrected ? "inline-flex" : "none";
      showExplanationBtn.textContent = "üìò Mostrar explica√ß√£o";
    }
    
    renderOptions(current);
    
    if (!sim.officialDuration) {
      $("qTimer").style.color = "";
      $("qTimer").style.fontWeight = "";
      $("qTimer").classList.remove("timer-critical");
    }
    
    renderQNav();
    updateQNavStats();
  }

  function updateQNavStats() {
    const total = sim.queue.length;
    let answered = 0;
    let corrected = 0;
    let correct = 0;
    let wrong = 0;
    
    sim.queue.forEach(q => {
      const a = sim.answers[q.id];
      if (a?.selected) answered++;
      if (a?.corrected) {
        corrected++;
        if (a.correct) correct++;
        else wrong++;
      }
    });
    
    $("statTotal").textContent = total;
    $("statAnswered").textContent = answered;
    $("statCorrect").textContent = corrected;
    $("statRight").textContent = correct;
    $("statWrong").textContent = wrong;
  }

  function renderQNav(){
    const grid = $("qnavGrid");
    if (!grid) return;
    
    const total = sim.queue.length;
    
    grid.innerHTML = "";
    
    for (let i = 0; i < total; i++){
      const q = sim.queue[i];
      const a = sim.answers[q.id];
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "qnav-btn";
      btn.textContent = String(i + 1);
      btn.title = `Quest√£o ${i + 1}: ${q.module} - ${q.theme}`;
      
      // Definir classe baseado no status
      if (i === sim.idx) {
        btn.classList.add("current");
      }
      
      if (a?.corrected) {
        if (a.correct) {
          btn.classList.add("correct");
          btn.title += " ‚úì Correta";
        } else {
          btn.classList.add("wrong");
          btn.title += " ‚úó Errada";
        }
      } else if (a?.selected) {
        btn.classList.add("answered");
        btn.title += " ‚åõ Respondida";
      } else {
        btn.classList.add("unanswered");
        btn.title += " ‚úé N√£o respondida";
      }
      
      btn.addEventListener("click", () => {
        sim.idx = i;
        renderQuiz();
      });
      grid.appendChild(btn);
    }
  }

  function updateStarButton(questionId) {
    const starBtn = $("btnStar");
    const isBookmarked = BookmarkManager.isBookmarked(questionId);
    starBtn.textContent = isBookmarked ? "‚òÖ" : "‚òÜ";
    starBtn.classList.toggle("active", isBookmarked);
    starBtn.title = isBookmarked ? "Remover da lista de revis√£o" : "Marcar para revis√£o";
  }

  function updateQuestionStatus(savedAnswer) {
    const el = $("qStatus");
    if (!savedAnswer) {
      el.innerHTML = '<span class="muted">N√£o respondida</span>';
      return;
    }
    
    if (savedAnswer.corrected) {
      const isCorrect = savedAnswer.correct;
      el.innerHTML = `
        <span class="result-indicator ${isCorrect ? 'correct' : 'incorrect'}">
          ${isCorrect ? '‚úÖ Correta' : '‚ùå Incorreta'}
        </span>
      `;
      return;
    }
    
    if (savedAnswer.selected) {
      el.innerHTML = '<span class="muted">Respondida (n√£o corrigida)</span>';
      return;
    }
    
    el.innerHTML = '<span class="muted">N√£o respondida</span>';
  }

  function renderOptions(current) {
    const optionsContainer = $("qOptions");
    optionsContainer.innerHTML = "";
    
    const letters = ['A','B','C','D','E'];
    const excluded = sim.excludedOptions[current.id] || [];
    
    letters.forEach(letter => {
      const optionText = current.options[letter];
      if (!optionText) return;
      
      const isExcluded = excluded.includes(letter);
      const optionDiv = document.createElement("div");
      optionDiv.className = `opt ${isExcluded ? 'excluded' : ''}`;
      if (sim.selected === letter) optionDiv.classList.add("selected");
      if (sim.corrected || sim.reviewMode !== null) {
        if (letter === current.answer) optionDiv.classList.add("correct");
        else if (letter === sim.selected) optionDiv.classList.add("wrong");
      }
      
      optionDiv.innerHTML = `
        <div class="choice-indicator"></div>
        <div class="txt"><span class="letter">${letter}.</span> ${escapeHtml(optionText)}</div>
        ${sim.reviewMode === null ? `<button class="exclude-btn" data-letter="${letter}" title="${isExcluded ? 'Restaurar alternativa' : 'Excluir alternativa'}">‚úÇÔ∏è</button>` : ''}
      `;
      
      if (sim.reviewMode === null && !sim.corrected && !isExcluded) {
        optionDiv.addEventListener("click", (e) => {
          if (!e.target.closest('.exclude-btn')) selectOption(letter);
        });
      }
      
      if (sim.reviewMode === null) {
        optionDiv.querySelector('.exclude-btn')?.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleExcludeOption(letter);
        });
      }
      
      optionsContainer.appendChild(optionDiv);
    });
  }

  function selectOption(letter) {
    if (sim.corrected || sim.reviewMode !== null) return;
    const currentQuestion = sim.queue[sim.idx];
    const excluded = sim.excludedOptions[currentQuestion.id] || [];
    if (excluded.includes(letter)) {
      showToast("Esta alternativa foi exclu√≠da. Restaure-a primeiro.", "bad");
      return;
    }
    
    sim.selected = letter;
    $$(".opt").forEach(opt => opt.classList.remove("selected"));
    $$(".opt").forEach(opt => {
      const l = opt.querySelector(".letter")?.textContent?.charAt(0);
      if (l === letter) opt.classList.add("selected");
    });
    $("btnCorrect").disabled = false;
    updateQuestionStatus(sim.answers[currentQuestion.id]);
    renderQNav();
    updateQNavStats();
  }

  function toggleExcludeOption(letter) {
    if (sim.reviewMode !== null) return;
    const currentQuestion = sim.queue[sim.idx];
    const excludedNow = ExclusionManager.toggleExclusion(currentQuestion.id, letter);
    
    if (!sim.excludedOptions[currentQuestion.id]) sim.excludedOptions[currentQuestion.id] = [];
    const idx = sim.excludedOptions[currentQuestion.id].indexOf(letter);
    if (idx === -1) sim.excludedOptions[currentQuestion.id].push(letter);
    else sim.excludedOptions[currentQuestion.id].splice(idx, 1);
    
    if (sim.selected === letter && excludedNow) {
      sim.selected = null;
      $("btnCorrect").disabled = true;
    }
    renderQuiz();
  }

  function toggleStar() {
    const current = sim.queue[sim.idx];
    const added = BookmarkManager.toggleBookmark(current.id);
    updateStarButton(current.id);
    showToast(added ? "‚≠ê Quest√£o marcada para revis√£o" : "üìù Marca√ß√£o removida", "info");
  }

  function correctAnswer() {
    if (sim.corrected || !sim.selected || sim.reviewMode !== null) return;
    const current = sim.queue[sim.idx];
    const isCorrect = sim.selected === current.answer;
    const timeSpent = Date.now() - sim.questionStartTime;
    
    sim.answers[current.id] = {
      selected: sim.selected,
      correct: isCorrect,
      corrected: true,
      timeSpent,
      showExplanation: true
    };
    sim.corrected = true;
    
    StatsManager.updateQuestionStats(current.id, isCorrect, timeSpent);
    $("btnCorrect").disabled = true;
    updateQuestionStatus(sim.answers[current.id]);
    showExplanation(current, isCorrect);
    renderOptions(current);
    renderQNav();
    updateQNavStats();
    
    SessionManager.saveSession({
      queue: sim.queue.map(q => q.id),
      idx: sim.idx,
      answers: sim.answers,
      excludedOptions: sim.excludedOptions,
      startedAt: sim.startedAt,
      course: selectedCourse.id
    });
  }

  function showExplanation(question, isCorrect) {
    const box = $("explanationBox");
    const txt = $("explanationText");
    if (!question.explain) return;
    
    txt.textContent = question.explain;
    box.classList.add("show");
    
    const title = box.querySelector('.explanation-title');
    title.innerHTML = `
      üìù Explica√ß√£o
      ${isCorrect !== undefined ? `<span class="result-indicator ${isCorrect ? 'correct' : 'incorrect'}">
        ${isCorrect ? '‚úÖ Correta' : '‚ùå Incorreta'}
      </span>` : ''}
    `;
  }

  function toggleExplanation() {
    const current = sim.queue[sim.idx];
    const answer = sim.answers[current.id];
    if (!answer) return;
    
    if (!answer.showExplanation) {
      answer.showExplanation = true;
      $("btnToggleExplanation").textContent = "üìò Ocultar explica√ß√£o";
      showExplanation(current, answer.correct);
    } else {
      answer.showExplanation = false;
      $("btnToggleExplanation").textContent = "üìò Mostrar explica√ß√£o";
      $("explanationBox").classList.remove("show");
    }
  }

  function nextQuestion() {
    if (sim.reviewMode === "wrong") {
      // Encontrar pr√≥xima quest√£o errada
      let nextIdx = sim.idx + 1;
      while (nextIdx < sim.queue.length) {
        const answer = sim.answers[sim.queue[nextIdx].id];
        if (answer?.corrected && !answer.correct) {
          sim.idx = nextIdx;
          renderQuiz();
          return;
        }
        nextIdx++;
      }
      // Se n√£o encontrou mais erros, finalizar revis√£o
      finishReview();
      return;
    }
    
    const current = sim.queue[sim.idx];
    if (sim.selected && !sim.corrected && sim.reviewMode === null) {
      if (!sim.answers[current.id]) {
        sim.answers[current.id] = {
          selected: sim.selected,
          correct: false,
          corrected: false,
          timeSpent: Date.now() - sim.questionStartTime
        };
      } else {
        sim.answers[current.id].selected = sim.selected;
        sim.answers[current.id].corrected = false;
        sim.answers[current.id].timeSpent = Date.now() - sim.questionStartTime;
      }
    } else if (!sim.selected && !sim.answers[current.id] && sim.reviewMode === null) {
      sim.answers[current.id] = {
        selected: null,
        correct: false,
        corrected: false,
        timeSpent: 0
      };
    }
    
    sim.idx++;
    if (sim.idx >= sim.queue.length) {
      if (sim.reviewMode === "all") {
        finishReview();
      } else {
        finishSimulado(false);
      }
    } else {
      renderQuiz();
    }
  }

  function prevQuestion() {
    if (sim.idx === 0) return;
    
    if (sim.reviewMode === "wrong") {
      // Encontrar quest√£o errada anterior
      let prevIdx = sim.idx - 1;
      while (prevIdx >= 0) {
        const answer = sim.answers[sim.queue[prevIdx].id];
        if (answer?.corrected && !answer.correct) {
          sim.idx = prevIdx;
          renderQuiz();
          return;
        }
        prevIdx--;
      }
      return;
    }
    
    sim.idx--;
    renderQuiz();
  }

  function finishSimulado(endedByTime = false) {
    const current = sim.queue[sim.idx];
    if (current && sim.selected && !sim.corrected && !sim.answers[current.id] && sim.reviewMode === null) {
      sim.answers[current.id] = {
        selected: sim.selected,
        correct: false,
        corrected: false,
        timeSpent: Date.now() - sim.questionStartTime
      };
    }
    
    const uncorrected = sim.queue.filter(q => !sim.answers[q.id]?.corrected);
    sim.queue.forEach(q => {
      if (!sim.answers[q.id] && sim.reviewMode === null) {
        sim.answers[q.id] = {
          selected: null,
          correct: false,
          corrected: false,
          timeSpent: 0
        };
      }
    });
    
    if (sim.reviewMode === null) {
      uncorrected.forEach(q => {
        const rec = sim.answers[q.id];
        if (!rec.selected) {
          rec.correct = false;
          rec.corrected = true;
          return;
        }
        rec.correct = rec.selected === q.answer;
        rec.corrected = true;
        StatsManager.updateQuestionStats(q.id, rec.correct, rec.timeSpent || 0);
      });
    }
    
    stopTimer();
    
    const total = sim.queue.length;
    const correct = Object.values(sim.answers).filter(a => a.correct).length;
    const blank = Object.values(sim.answers).filter(a => !a.selected).length;
    const accuracy = total > 0 ? (correct / total) * 100 : 0;
    const totalTime = Date.now() - sim.startedAt;
    
    if (sim.reviewMode === null) {
      StatsManager.addSession({
        course: selectedCourse.id,
        totalQuestions: total,
        correctAnswers: correct,
        blankAnswers: blank,
        accuracy: Math.round(accuracy * 10) / 10,
        timeSpent: totalTime,
        date: new Date().toISOString(),
        answers: sim.answers,
        autoCorrected: uncorrected.length,
        endedByTime: !!endedByTime
      });
      
      SessionManager.clearSession();
    }
    
    showResults({
      total,
      correct,
      blank,
      accuracy,
      totalTime,
      answers: sim.answers,
      questions: sim.queue,
      autoCorrected: uncorrected.length,
      endedByTime
    });
  }

  function startReviewMode(mode) {
    sim.reviewMode = mode;
    
    if (mode === "wrong") {
      // Encontrar primeira quest√£o errada
      for (let i = 0; i < sim.queue.length; i++) {
        const answer = sim.answers[sim.queue[i].id];
        if (answer?.corrected && !answer.correct) {
          sim.idx = i;
          break;
        }
      }
    } else {
      sim.idx = 0;
    }
    
    $("resultsBackdrop").classList.remove("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "true");
    
    // Ajustar UI para modo revis√£o
    $("btnCorrect").style.display = "none";
    $("btnFinish").textContent = "Finalizar revis√£o";
    $("btnFinish").onclick = finishReview;
    
    renderQuiz();
    showView("quiz");
  }

  function finishReview() {
    sim.reviewMode = null;
    $("btnCorrect").style.display = "inline-flex";
    $("btnFinish").textContent = "Finalizar Simulado";
    $("btnFinish").onclick = () => finishSimulado(false);
    
    // Voltar para resultados
    showResults({
      total: sim.queue.length,
      correct: Object.values(sim.answers).filter(a => a.correct).length,
      blank: Object.values(sim.answers).filter(a => !a.selected).length,
      accuracy: sim.queue.length > 0 ? (Object.values(sim.answers).filter(a => a.correct).length / sim.queue.length) * 100 : 0,
      totalTime: Date.now() - sim.startedAt,
      answers: sim.answers,
      questions: sim.queue,
      autoCorrected: 0,
      endedByTime: false
    });
  }

  // =========================================================
  // GR√ÅFICO DE DESEMPENHO (Bug 3 corrigido)
  // =========================================================
  function calculatePerformance(results) {
    const modules = {};
    const chapters = {};
    
    results.questions.forEach(q => {
      const answer = results.answers[q.id];
      
      // Agrupar por m√≥dulo
      if (!modules[q.module]) {
        modules[q.module] = { total: 0, correct: 0 };
      }
      modules[q.module].total++;
      if (answer?.correct) modules[q.module].correct++;
      
      // Agrupar por cap√≠tulo
      if (!chapters[q.chapter]) {
        chapters[q.chapter] = { total: 0, correct: 0 };
      }
      chapters[q.chapter].total++;
      if (answer?.correct) chapters[q.chapter].correct++;
    });
    
    // Converter para arrays
    const moduleData = Object.entries(modules).map(([name, data]) => ({
      name,
      total: data.total,
      correct: data.correct,
      percent: data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0
    }));
    
    const chapterData = Object.entries(chapters).map(([name, data]) => ({
      name,
      total: data.total,
      correct: data.correct,
      percent: data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0
    }));
    
    return { modules: moduleData, chapters: chapterData };
  }

  function renderPerformanceChart(type = 'module') {
    const groups = type === 'module' ? perfState.modules : perfState.chapters;
    
    // Ordenar por percentual (pior para melhor)
    const sorted = [...groups].sort((a, b) => a.percent - b.percent);
    const worst = sorted.slice(0, 5);
    
    let html = `
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Desempenho por ${type === 'module' ? 'M√≥dulo' : 'Cap√≠tulo'}</h3>
          <div class="chart-selector">
            <button class="${type === 'module' ? 'active' : ''}" data-perf="module">M√≥dulo</button>
            <button class="${type === 'chapter' ? 'active' : ''}" data-perf="chapter">Cap√≠tulo</button>
          </div>
        </div>
    `;
    
    // Gr√°fico de barras
    sorted.forEach(group => {
      const isWorst = worst.some(w => w.name === group.name);
      html += `
        <div class="chart-bar">
          <div class="bar-label">
            <span>${escapeHtml(group.name)}</span>
            <span>${group.correct}/${group.total} (${group.percent}%)</span>
          </div>
          <div class="bar-container">
            <div class="bar-fill ${isWorst ? 'worst' : ''}" style="width: ${group.percent}%">
              ${group.percent}%
            </div>
          </div>
        </div>
      `;
    });
    
    // Estat√≠sticas
    html += `
      <div class="chart-stats">
        <div class="stat-item">
          <h4>Melhor desempenho</h4>
          <p>${sorted.length > 0 ? escapeHtml(sorted[sorted.length-1].name) : '‚Äî'} (${sorted.length > 0 ? sorted[sorted.length-1].percent : 0}%)</p>
        </div>
        <div class="stat-item">
          <h4>Pior desempenho</h4>
          <p>${sorted.length > 0 ? escapeHtml(sorted[0].name) : '‚Äî'} (${sorted.length > 0 ? sorted[0].percent : 0}%)</p>
        </div>
        <div class="stat-item">
          <h4>M√©dia geral</h4>
          <p>${groups.length > 0 ? Math.round(groups.reduce((a, g) => a + g.percent, 0) / groups.length) : 0}%</p>
        </div>
      </div>
    </div>`;
    
    return html;
  }

  function showResults(results) {
    const content = $("resultsContent");
    const timePerQuestion = results.total > 0 ? Math.round(results.totalTime / results.total / 1000) : 0;
    
    // Bug 3 corrigido: calcular desempenho e armazenar no estado global
    perfState = calculatePerformance(results);
    
    content.innerHTML = `
      <div class="manual-wrap" style="padding:24px;">
        <h2 style="margin:0 0 8px 0; font-weight:700; color:${selectedCourse.color};">Simulado Conclu√≠do!</h2>
        <div class="muted">${selectedCourse.name} ‚Ä¢ ${new Date().toLocaleDateString('pt-BR')} ${results.endedByTime ? '‚Ä¢ ‚è±Ô∏è Encerrado por tempo' : ''}</div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-top:24px;">
          <div style="background:#fff; border:1px solid var(--border); border-radius:14px; padding:20px; text-align:center;">
            <div class="muted" style="font-weight:600; text-transform:uppercase; letter-spacing:.6px; font-size:12px;">Taxa de acerto</div>
            <div style="font-size:36px; font-weight:700; color:${results.accuracy>=70?'var(--ok)':results.accuracy>=50?'var(--warn)':'var(--bad)'}">${Math.round(results.accuracy)}%</div>
            <div class="muted">${results.correct}/${results.total} acertos ‚Ä¢ ${results.blank} em branco</div>
          </div>
          <div style="background:#fff; border:1px solid var(--border); border-radius:14px; padding:20px; text-align:center;">
            <div class="muted" style="font-weight:600; text-transform:uppercase; letter-spacing:.6px; font-size:12px;">Tempo total</div>
            <div style="font-size:36px; font-weight:700; color:var(--brand-2);">${formatTime(results.totalTime)}</div>
            <div class="muted">${timePerQuestion}s por quest√£o</div>
          </div>
          <div style="background:#fff; border:1px solid var(--border); border-radius:14px; padding:20px; text-align:center;">
            <div class="muted" style="font-weight:600; text-transform:uppercase; letter-spacing:.6px; font-size:12px;">Corre√ß√£o</div>
            <div style="font-size:36px; font-weight:700; color:var(--brand-2);">${results.autoCorrected}</div>
            <div class="muted">corrigidas automaticamente</div>
          </div>
        </div>
        
        <!-- Gr√°fico de desempenho -->
        ${renderPerformanceChart('module')}
        
        <!-- Bot√µes de revis√£o -->
        <div class="review-buttons">
          <button class="btn primary" id="btnReviewAll" type="button">üìö Revisar Simulado Completo</button>
          ${(results.total - results.correct) > 0 ? `<button class="btn ghost" id="btnReviewWrong" type="button">üìù Revisar apenas Erros (${results.total - results.correct})</button>` : ''}
        </div>
        
        ${
          (results.total - results.correct) > 0 ? `
          <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
            <h4 style="margin: 0 0 12px 0; color: var(--brand);">Quest√µes erradas (${results.total - results.correct})</h4>
            <div class="muted" style="max-height: 220px; overflow-y: auto; font-size: 13px;">
              ${Object.entries(results.answers)
                .filter(([_, a]) => a.selected && !a.correct)
                .map(([id, answer]) => {
                  const q = results.questions.find(qq => qq.id === id);
                  if (!q) return '';
                  return `
                    <div style="margin-bottom: 12px; padding: 12px; background: var(--bad-light); border-radius: 10px; border-left: 3px solid var(--bad);">
                      <div style="font-weight: 600; color: var(--bad);">${q.id} ‚Ä¢ ${escapeHtml(q.theme)}</div>
                      <div style="margin: 6px 0; font-weight: 500;">${escapeHtml(String(q.q).slice(0, 120))}${q.q.length>120?'...':''}</div>
                      <div style="font-size: 12px;">
                        <span style="color: var(--bad);">Sua resposta: ${answer.selected}</span> |
                        <span style="color: var(--ok);">Correta: ${q.answer}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
            </div>
          </div>
          ` : `
          <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); text-align:center;">
            <div style="font-weight:700; color:var(--ok);">üéâ Parab√©ns! Nenhum erro.</div>
          </div>
          `
        }
      </div>
    `;
    
    $("resultsFooter").textContent = `Tempo total: ${formatTime(results.totalTime)} ‚Ä¢ ${results.endedByTime ? 'Encerrado por tempo' : 'Conclu√≠do'}`;
    $("resultsBackdrop").classList.add("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "false");
    
    // Adicionar event listeners para os bot√µes de revis√£o
    $("btnReviewAll")?.addEventListener("click", () => startReviewMode('all'));
    $("btnReviewWrong")?.addEventListener("click", () => startReviewMode('wrong'));
    
    // Bug 3 corrigido: Adicionar listeners para os bot√µes do gr√°fico de desempenho
    setTimeout(() => {
      $$('[data-perf]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const type = e.target.dataset.perf;
          perfState.active = type;
          
          // Atualizar bot√µes ativos
          $$('[data-perf]').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          // Substituir o gr√°fico
          const chartContainer = content.querySelector('.chart-container');
          if (chartContainer) {
            chartContainer.outerHTML = renderPerformanceChart(type);
            
            // Re-aplicar listeners aos novos bot√µes
            $$('[data-perf]').forEach(newBtn => {
              newBtn.addEventListener('click', (e2) => {
                const newType = e2.target.dataset.perf;
                perfState.active = newType;
                
                $$('[data-perf]').forEach(b => b.classList.remove('active'));
                e2.target.classList.add('active');
                
                const newChartContainer = content.querySelector('.chart-container');
                if (newChartContainer) {
                  newChartContainer.outerHTML = renderPerformanceChart(newType);
                }
              });
            });
          }
        });
      });
    }, 100);
  }

  // =========================================================
  // HIST√ìRICO
  // =========================================================
  function loadHistoryView() {
    const container = $("historyContent");
    const history = StatsManager.getHistory();
    const bookmarks = BookmarkManager.getBookmarks();
    const activeTab = document.querySelector('.tab.active')?.dataset.tab || 'history';
    
    if (activeTab === 'history') {
      if (history.length === 0) {
        container.innerHTML = `
          <div class="manual-wrap" style="padding:32px; text-align:center;">
            <h3 style="color: var(--brand); margin: 0 0 12px 0;">Nenhum simulado encontrado</h3>
            <div class="muted">Comece fazendo seu primeiro simulado!</div>
            <button class="btn primary" onclick="showView('home')" style="margin-top: 16px;">Iniciar</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Curso</th>
              <th>Quest√µes</th>
              <th>Acerto</th>
              <th>Tempo</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${history.map(s => `
              <tr>
                <td>${new Date(s.completedAt).toLocaleDateString('pt-BR')}</td>
                <td><strong>${s.course}</strong></td>
                <td>${s.totalQuestions}</td>
                <td>
                  <span class="badge ${s.accuracy >= 70 ? 'correct' : s.accuracy >= 50 ? 'pending' : 'incorrect'}">
                    ${s.accuracy}%
                  </span>
                </td>
                <td>${formatTime(s.timeSpent)}</td>
                <td>${s.endedByTime ? '<span class="badge incorrect">tempo</span>' : '<span class="badge correct">ok</span>'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      return;
    }
    
    if (activeTab === 'bookmarks') {
      if (bookmarks.length === 0) {
        container.innerHTML = `
          <div class="manual-wrap" style="padding:32px; text-align:center;">
            <h3 style="color: var(--brand); margin: 0 0 12px 0;">Nenhuma quest√£o marcada</h3>
            <div class="muted">Marque quest√µes durante o simulado clicando no ‚≠ê</div>
          </div>
        `;
        return;
      }
      container.innerHTML = `
        <div class="manual-wrap" style="padding:24px;">
          <h3 style="color: var(--brand); margin: 0 0 12px 0;">${bookmarks.length} Quest√µes Marcadas</h3>
          <div class="muted">Estas s√£o as quest√µes que voc√™ marcou para revis√£o.</div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = `
      <div class="manual-wrap" style="padding:24px;">
        <h3 style="color: var(--brand); margin: 0 0 12px 0;">Erros para revisar</h3>
        <div class="muted">Em breve: lista inteligente por tema/m√≥dulo.</div>
      </div>
    `;
  }

  // =========================================================
  // UTILIT√ÅRIOS
  // =========================================================
  function showToast(message, type = "info", duration = 3000) {
    const wrap = $("globalToast");
    const inner = $("globalToastInner");
    if (!wrap || !inner) return null;
    
    inner.className = `toast show ${type}`;
    inner.textContent = message;
    wrap.style.display = "block";
    
    if (duration > 0) {
      setTimeout(() => {
        wrap.style.display = "none";
        inner.textContent = "";
      }, duration);
    }
    return inner;
  }

  function exportData(format) {
    const history = StatsManager.getHistory();
    const stats = StatsManager.getQuestionStats();
    let data, filename, mimeType;
    
    if (format === 'csv') {
      let csv = "ID,Tentativas,Acertos,Taxa de Acerto,Tempo M√©dio (s),√öltima Tentativa\n";
      Object.entries(stats).forEach(([id, st]) => {
        const accuracy = st.attempts > 0 ? (st.correct / st.attempts * 100).toFixed(1) : "0";
        const avgTime = st.attempts > 0 ? Math.round(st.totalTime / st.attempts / 1000) : "0";
        csv += `"${id}",${st.attempts},${st.correct},${accuracy}%,${avgTime},"${new Date(st.lastAttempt).toLocaleDateString('pt-BR')}"\n`;
      });
      data = csv;
      filename = `historico-simulado-${new Date().toISOString().split('T')[0]}.csv`;
      mimeType = 'text/csv;charset=utf-8;';
    } else {
      data = JSON.stringify({
        history,
        stats,
        exportedAt: new Date().toISOString(),
        user: currentUser
      }, null, 2);
      filename = `historico-simulado-${new Date().toISOString().split('T')[0]}.json`;
      mimeType = 'application/json';
    }
    
    const blob = new Blob([data], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showToast(`‚úÖ Dados exportados: ${filename}`, 'ok');
  }

  // =========================================================
  // EVENT LISTENERS
  // =========================================================
  $("btnLogin").addEventListener("click", () => {
    const user = ($("loginUser").value || "").trim();
    const pass = ($("loginPass").value || "").trim();
    const remember = $("rememberMe").checked;
    
    if (!user || !pass) {
      showToast("Preencha usu√°rio e senha", "bad");
      return;
    }
    
    AuthManager.setAuth(user, remember);
    AuthManager.requireLogin();
    renderCourses();
    showToast(`‚úÖ Bem-vindo, ${user}!`, "ok");
  });
  
  $("btnLogout").addEventListener("click", () => {
    AuthManager.clearAuth();
    selectedCourse = null;
    db.all = [];
    showView("home");
    AuthManager.requireLogin();
    showToast("‚úÖ Logout realizado", "ok");
  });
  
  $$('.nav a').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const view = a.id.replace('nav', '').toLowerCase();
      showView(view);
    });
  });
  
  $$('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      loadHistoryView();
    });
  });
  
  $("btnCloseWizard").addEventListener("click", closeWizard);
  
  $("wizardBackdrop").addEventListener("click", (e) => {
    if (e.target === $("wizardBackdrop")) closeWizard();
  });
  
  $("btnPrevStep").addEventListener("click", () => {
    wizStep = Math.max(1, wizStep - 1);
    wizRender();
  });
  
  $("btnNextStep").addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    // Validar se pode avan√ßar
    const maxStep = wizMode === "exam" ? 3 : 4; // Bug 2 corrigido
    
    if (wizStep === (wizMode === "exam" ? 2 : 3)) {
      const config = applyWizardFilters();
      if (!config.base || config.base.length === 0) {
        showToast("Nenhuma quest√£o encontrada com esses filtros", "bad");
        return;
      }
    }
    
    if (wizStep === maxStep) {
      const config = applyWizardFilters();
      startSimulado(config);
      return;
    }
    
    wizStep++;
    wizRender();
  });
  
  $$('.mode[data-mode]').forEach(mode => {
    mode.addEventListener('click', () => {
      $$('.mode[data-mode]').forEach(m => m.classList.remove('selected'));
      mode.classList.add('selected');
      wizMode = mode.dataset.mode;
      
      // Ajustar configura√ß√µes baseadas no modo
      if (wizMode === 'exam') {
        $("selQty").value = "60";
        $("chkOfficialDuration").checked = true;
      }
      
      wizRender();
    });
  });
  
  $("advancedHeader").addEventListener("click", () => {
    const content = $("advancedContent");
    const isShowing = content.classList.contains("show");
    if (isShowing) {
      content.classList.remove("show");
      $("advancedHeader").querySelector("span:last-child").textContent = "‚ñº";
    } else {
      content.classList.add("show");
      $("advancedHeader").querySelector("span:last-child").textContent = "‚ñ≤";
    }
  });
  
  ['selTheme','selLevel','selQty','chkNoRepeat','chkOfficialDuration','chkDistEnable'].forEach(id => {
    $(id).addEventListener('change', () => {
      updateDistUIState();
      updateFilterInfo();
      updateConfirmText();
    });
  });
  
  ["listModule","listChapter"].forEach(id => {
    $(id).addEventListener("change", () => {
      updateFilterInfo();
      updateConfirmText();
    });
  });
  
  $("distModeQty").addEventListener("change", () => {
    updateDistSumBadge();
    updateFilterInfo();
    updateConfirmText();
  });
  
  $("distModePct").addEventListener("change", () => {
    updateDistSumBadge();
    updateFilterInfo();
    updateConfirmText();
  });
  
  function debounce(func, wait) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => func(...args), wait);
    };
  }
  
  $("searchText").addEventListener('input', debounce(() => {
    updateFilterInfo();
    updateConfirmText();
  }, 250));
  
  $("btnCorrect").addEventListener("click", correctAnswer);
  $("btnNext").addEventListener("click", nextQuestion);
  $("btnPrev").addEventListener("click", prevQuestion);
  $("btnStar").addEventListener("click", toggleStar);
  $("btnToggleExplanation").addEventListener("click", toggleExplanation);
  $("btnFinish").addEventListener("click", () => {
    if (sim.reviewMode !== null) {
      finishReview();
    } else {
      finishSimulado(false);
    }
  });
  
  $("btnCloseResults").addEventListener("click", () => {
    $("resultsBackdrop").classList.remove("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "true");
    showView("home");
  });
  
  $("btnNewSimulado").addEventListener("click", () => {
    $("resultsBackdrop").classList.remove("show");
    $("resultsBackdrop").setAttribute("aria-hidden", "true");
    openWizard();
  });
  
  $("btnExportCSV").addEventListener("click", () => exportData('csv'));
  $("btnExportJSON").addEventListener("click", () => exportData('json'));

  // =========================================================
  // INIT
  // =========================================================
  async function init() {
    AuthManager.requireLogin();
    loadManuals();
    
    selectedCourse = courses[0];
    try {
      await loadQuestionsForCourse(selectedCourse);
    } catch(e){}
    
    renderCourses();
  }
  
  // Exportar fun√ß√µes para uso global
  window.showView = showView;
  window.renderPerformanceChart = renderPerformanceChart;
  
  // Iniciar a aplica√ß√£o
  init();
})();
</script>
</body>
</html>
