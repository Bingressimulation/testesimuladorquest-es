<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Quest√µes</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f4f6fb;
      --panel:#ffffff;
      --border: rgba(2,8,23,.10);
      --shadow: 0 12px 36px rgba(2,8,23,.08);

      --text:#0b1220;
      --muted:#667085;

      /* ‚Äúroxo‚Äù do print + bot√µes */
      --purple:#6b6bcf;
      --purple-2:#5a5ad0;

      --btn-red:#ef4444;
      --btn-green:#10b981;
      --btn-gray:#6b7280;

      --radius:14px;
      --radius-lg:18px;

      --container: 1180px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== Topbar (igual vibe plataforma) ===== */
    .topbar{
      height:64px;
      background: linear-gradient(180deg, #1f2937, #111827);
      color:#fff;
      display:flex;
      align-items:center;
      position: sticky;
      top:0;
      z-index: 50;
      box-shadow: 0 8px 28px rgba(0,0,0,.12);
    }
    .topbar .inner{
      width: min(var(--container), 100%);
      margin: 0 auto;
      padding: 0 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .brand-badge{
      width: 34px; height: 34px;
      border-radius: 10px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
      font-weight: 950;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.95);
      white-space: nowrap;
    }
    .chip b{ color: #e5e7eb; }

    /* ===== Page container ===== */
    .container{
      width: min(var(--container), 100%);
      margin: 18px auto;
      padding: 0 16px 26px 16px;
    }

    /* ===== Card ===== */
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-body{ padding: 18px; }
    .title{
      font-size: 18px;
      font-weight: 950;
      margin: 0 0 6px 0;
      letter-spacing: .2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 650;
      line-height: 1.35;
    }

    /* ===== Stepper (4 etapas) ===== */
    .stepper{
      margin-top: 10px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 14px;
    }
    .step{
      flex: 1 1 0;
      position: relative;
      text-align: center;
      padding: 10px 6px 0 6px;
    }
    .step::before{
      content:"";
      position:absolute;
      top: 22px;
      left: -50%;
      width: 100%;
      height: 4px;
      background: rgba(17,24,39,.10);
      z-index: 0;
    }
    .step:first-child::before{ display:none; }

    .dot{
      width: 44px; height: 44px;
      border-radius: 999px;
      margin: 0 auto;
      display:grid;
      place-items:center;
      font-weight: 950;
      border: 4px solid rgba(17,24,39,.10);
      background: #fff;
      position: relative;
      z-index: 1;
      color: rgba(17,24,39,.65);
    }
    .step.active .dot{
      background: #111827;
      color:#fff;
      border-color: rgba(17,24,39,.15);
    }
    .step.done .dot{
      background: #111827;
      color:#fff;
      border-color: rgba(17,24,39,.15);
    }
    .step.done::before{
      background: #111827;
    }
    .step h4{
      margin: 10px 0 4px 0;
      font-size: 13px;
      font-weight: 950;
      color: #111827;
    }
    .step p{
      margin: 0;
      font-size: 12px;
      font-weight: 650;
      color: var(--muted);
    }

    /* ===== Wizard blocks ===== */
    .wizard-grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .grid-3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .mode-card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      cursor:pointer;
      transition: .15s ease;
      background: #fff;
      min-height: 92px;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .mode-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(2,8,23,.10);
      border-color: rgba(17,24,39,.22);
    }
    .mode-card.selected{
      border-color: rgba(17,24,39,.35);
      background: rgba(17,24,39,.04);
    }
    .mode-card strong{
      font-size: 13px;
      font-weight: 950;
      color:#111827;
    }
    .mode-card span{
      font-size: 12px;
      font-weight: 650;
      color: var(--muted);
      line-height: 1.3;
    }

    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 6px;
    }
    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color:#111827;
    }
    .field select, .field input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#fff;
      font-weight: 650;
      font-size: 13px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(17,24,39,.35);
      box-shadow: 0 0 0 4px rgba(17,24,39,.10);
    }

    .wizard-foot{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background:#fff;
      color:#111827;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      gap: 10px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: #111827;
      color:#fff;
      border-color: rgba(17,24,39,.35);
    }
    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
      transform:none;
    }

    .toggle-row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background:#fff;
    }
    .toggle-row strong{
      font-size: 12px;
      font-weight: 950;
      color:#111827;
    }
    .toggle-row span{
      display:block;
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
    }
    .switch{
      width: 42px; height: 24px;
      border-radius: 999px;
      background: rgba(17,24,39,.16);
      border: 1px solid rgba(17,24,39,.16);
      position: relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:2px; left:2px;
      width: 18px; height: 18px;
      border-radius: 999px;
      background:#fff;
      transition: .15s ease;
    }
    .switch.on{ background: rgba(17,24,39,.75); border-color: rgba(17,24,39,.55); }
    .switch.on::after{ transform: translateX(18px); }

    /* ===== QUIZ (tela igual print) ===== */
    .quiz-wrap{
      margin-top: 16px;
    }

    .progressbar{
      height: 18px;
      background: #d1d5db;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(2,8,23,.10);
    }
    .progressbar > div{
      height: 100%;
      width: 0%;
      background: #22c55e;
      font-size: 12px;
      font-weight: 900;
      color: #0b1220;
      display:flex;
      align-items:center;
      padding-left: 10px;
      white-space: nowrap;
    }

    .q-header{
      margin-top: 10px;
      background: var(--purple);
      color: #fff;
      border-radius: 12px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .q-header-left{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 220px;
    }
    .q-header-left strong{
      font-size: 16px;
      font-weight: 950;
    }
    .q-header-left small{
      font-size: 12px;
      opacity: .9;
      font-weight: 650;
    }
    .q-header-right{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .qbtn{
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 950;
      font-size: 13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      color:#fff;
      transition: .15s ease;
    }
    .qbtn.gray{ background: var(--btn-gray); }
    .qbtn.red{ background: var(--btn-red); }
    .qbtn.green{ background: var(--btn-green); }
    .qbtn:disabled{ opacity:.55; cursor:not-allowed; }

    .q-card{
      margin-top: 10px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .q-body{ padding: 16px; }

    .meta{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-bottom: 10px;
      font-weight: 750;
      font-size: 13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(2,8,23,.10);
      background: rgba(2,8,23,.04);
      font-size: 12px;
      font-weight: 900;
      color:#111827;
    }
    .pill.yellow{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); }
    .q-text{
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 14px;
      color: rgba(11,18,32,.92);
      margin: 0 0 14px 0;
    }

    .options{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .opt{
      display:flex;
      align-items:center;
      gap: 10px;
      border: 1px solid rgba(2,8,23,.10);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(2,8,23,.04);
      cursor:pointer;
      user-select:none;
      transition: .15s ease;
      max-width: 420px; /* parecido com o print */
    }
    .opt:hover{ transform: translateY(-1px); border-color: rgba(2,8,23,.18); }
    .opt input{ margin:0; }
    .opt.selected{
      background: rgba(16,185,129,.10);
      border-color: rgba(16,185,129,.30);
    }

    .explain{
      margin-top: 14px;
      display:none;
      border-radius: 12px;
      border: 1px solid rgba(2,8,23,.12);
      background: rgba(2,8,23,.04);
      padding: 12px;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.45;
    }
    .explain.show{ display:block; }

    /* ===== Dashboard ===== */
    .dash-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .kpi .lbl{ font-size: 12px; font-weight: 900; color: var(--muted); }
    .kpi .val{ font-size: 18px; font-weight: 950; margin-top: 4px; color:#111827; }

    .muted{ color: var(--muted); font-weight: 650; font-size: 12px; line-height: 1.45; }

    .view{ display:none; }
    .view.show{ display:block; }

    @media (max-width: 980px){
      .grid-3{ grid-template-columns: 1fr; }
      .filters{ grid-template-columns: 1fr; }
      .dash-grid{ grid-template-columns: 1fr; }
      .opt{ max-width: 100%; }
      .q-header{ align-items:flex-start; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="brand-badge">PQO</div>
        <div>
          <div style="font-size:13px; font-weight:950; line-height:1;">PQO Risco</div>
          <div style="font-size:12px; opacity:.85; font-weight:650;">Simulador ‚Ä¢ estilo eumebanco</div>
        </div>
      </div>
      <div class="top-actions">
        <div class="chip">Base: <b id="chipBase">0</b></div>
        <div class="chip">Selecionadas: <b id="chipSelected">0</b></div>
        <div class="chip">Timer: <b id="chipTimer">00:00:00</b></div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- ===== WIZARD (4 passos) ===== -->
    <section class="view show" id="viewWizard">
      <div class="card">
        <div class="card-body">
          <h1 class="title">Resolver Quest√µes</h1>
          <p class="sub">Fluxo em 4 etapas (Identifica√ß√£o ‚Üí Modalidade ‚Üí Filtros ‚Üí Confirma√ß√£o)</p>

          <div class="stepper" style="margin-top:12px;">
            <div class="step active" id="st1">
              <div class="dot">1</div>
              <h4>Identifica√ß√£o</h4>
              <p>Pronto para come√ßar</p>
            </div>
            <div class="step" id="st2">
              <div class="dot">2</div>
              <h4>Modalidade</h4>
              <p>Como montar o simulado</p>
            </div>
            <div class="step" id="st3">
              <div class="dot">3</div>
              <h4>Filtros</h4>
              <p>Encontre as quest√µes</p>
            </div>
            <div class="step" id="st4">
              <div class="dot">4</div>
              <h4>Confirma√ß√£o</h4>
              <p>Preparar e iniciar</p>
            </div>
          </div>

          <div class="wizard-grid">

            <!-- STEP 1 -->
            <div class="card" style="box-shadow:none;" id="step1Box">
              <div class="card-body">
                <h2 class="title" style="font-size:16px;">1) Identifica√ß√£o</h2>
                <p class="sub">Aqui voc√™ pode simplesmente seguir (igual ao print, sem login real).</p>

                <div class="wizard-foot">
                  <div class="muted" id="dbStatus">Carregando base‚Ä¶</div>
                  <button class="btn primary" id="btnGo2" type="button">Prosseguir ‚Üí</button>
                </div>
              </div>
            </div>

            <!-- STEP 2 -->
            <div class="card" style="box-shadow:none; display:none;" id="step2Box">
              <div class="card-body">
                <h2 class="title" style="font-size:16px;">2) Modalidade</h2>
                <p class="sub">Escolha a forma como deseja buscar as quest√µes.</p>

                <div class="grid-3" style="margin-top:12px;">
                  <div class="mode-card selected" id="modeModule">
                    <strong>Escolher por M√≥dulo</strong>
                    <span>Seleciona por T√≠tulo/Cap√≠tulo/Tema (modo recomendado).</span>
                  </div>
                  <div class="mode-card" id="modeQuestions" title="Somente visual (n√£o implementado aqui)">
                    <strong>Escolher por Quest√µes</strong>
                    <span>Filtro quest√£o-a-quest√£o (pode ser evolu√≠do depois).</span>
                  </div>
                  <div class="mode-card" id="modeSubjects" title="Somente visual (n√£o implementado aqui)">
                    <strong>Escolher por Assuntos</strong>
                    <span>Seleciona quantidade por assunto (evolu√ß√£o futura).</span>
                  </div>
                </div>

                <div class="wizard-foot">
                  <button class="btn" id="btnBack1" type="button">‚Üê Voltar</button>
                  <button class="btn primary" id="btnGo3" type="button">Prosseguir ‚Üí</button>
                </div>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="card" style="box-shadow:none; display:none;" id="step3Box">
              <div class="card-body">
                <h2 class="title" style="font-size:16px;">3) Filtros</h2>
                <p class="sub">Defina m√≥dulo/cap√≠tulo/tema/dificuldade e/ou fa√ßa busca por texto.</p>

                <div class="filters">
                  <div class="field">
                    <label for="selModule">T√≠tulo (M√≥dulo)</label>
                    <select id="selModule"></select>
                  </div>
                  <div class="field">
                    <label for="selChapter">Cap√≠tulo</label>
                    <select id="selChapter"></select>
                  </div>
                  <div class="field">
                    <label for="selTheme">Tema</label>
                    <select id="selTheme"></select>
                  </div>
                  <div class="field">
                    <label for="selLevel">Dificuldade</label>
                    <select id="selLevel"></select>
                  </div>
                  <div class="field" style="grid-column:1/-1;">
                    <label for="searchText">Busca (texto livre)</label>
                    <input id="searchText" type="text" placeholder="Ex.: margem, CCP, nova√ß√£o, op√ß√µes, ICVM..." />
                  </div>
                </div>

                <div class="wizard-foot">
                  <button class="btn" id="btnBack2" type="button">‚Üê Voltar</button>
                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn" id="btnClearFilters" type="button">Limpar filtros</button>
                    <button class="btn primary" id="btnGo4" type="button">Prosseguir ‚Üí</button>
                  </div>
                </div>

                <div class="muted" style="margin-top:10px;" id="filterInfo">‚Äî</div>
              </div>
            </div>

            <!-- STEP 4 -->
            <div class="card" style="box-shadow:none; display:none;" id="step4Box">
              <div class="card-body">
                <h2 class="title" style="font-size:16px;">4) Confirma√ß√£o</h2>
                <p class="sub">Confirme as prefer√™ncias e inicie o simulado.</p>

                <div class="grid-3" style="margin-top:12px;">
                  <div class="toggle-row">
                    <div>
                      <strong>Remover as que j√° respondi</strong>
                      <span>Usa hist√≥rico local do navegador (N√£o repetir).</span>
                    </div>
                    <div id="swNoRepeat" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
                  </div>

                  <div class="toggle-row">
                    <div>
                      <strong>Embaralhar</strong>
                      <span>Mistura a ordem das quest√µes.</span>
                    </div>
                    <div id="swShuffle" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
                  </div>

                  <div class="toggle-row">
                    <div>
                      <strong>Modo prova (60)</strong>
                      <span>Seleciona at√© 60 quest√µes.</span>
                    </div>
                    <div id="swExam" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none; margin-top:12px;">
                  <div class="card-body">
                    <div class="muted" id="confirmText">‚Äî</div>
                  </div>
                </div>

                <div class="wizard-foot">
                  <button class="btn" id="btnBack3" type="button">‚Üê Voltar</button>
                  <button class="btn primary" id="btnStart" type="button">Iniciar Exame</button>
                </div>
              </div>
            </div>

          </div><!-- wizard-grid -->
        </div>
      </div>
    </section>

    <!-- ===== QUIZ ===== -->
    <section class="view" id="viewQuiz">
      <div class="quiz-wrap">
        <div class="progressbar">
          <div id="pbFill">0% (Quest√£o 0/0)</div>
        </div>

        <div class="q-header">
          <div class="q-header-left">
            <strong id="qTopTitle">Quest√£o 1</strong>
            <small id="qTopSub">Identificador: ‚Äî</small>
          </div>
          <div class="q-header-right">
            <button class="qbtn gray" id="btnPrev" type="button" disabled>‚óÄ Anterior</button>
            <button class="qbtn red" id="btnFinish" type="button" disabled>Finalizar üèÅ</button>
            <button class="qbtn green" id="btnConfirm" type="button" disabled>Corrigir Quest√£o ‚úÖ</button>
            <button class="qbtn gray" id="btnNext" type="button" disabled>Pr√≥xima ‚ñ∂</button>
          </div>
        </div>

        <div class="q-card">
          <div class="q-body">
            <div class="meta" id="qMeta"></div>
            <p class="q-text" id="qText"></p>
            <div class="options" id="qOptions"></div>

            <div class="explain" id="qExplain"></div>
            <div class="muted" style="margin-top:10px;" id="qStatus">Selecione uma alternativa.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== DASHBOARD ===== -->
    <section class="view" id="viewDashboard">
      <div class="card">
        <div class="card-body">
          <h2 class="title">Dashboard final</h2>
          <p class="sub">Tempo, taxa de acerto e desempenho por m√≥dulo/tema</p>

          <div class="dash-grid">
            <div class="card" style="box-shadow:none;">
              <div class="card-body">
                <div class="kpis">
                  <div class="kpi">
                    <div class="lbl">Dura√ß√£o</div>
                    <div class="val" id="finalTime">00:00:00</div>
                  </div>
                  <div class="kpi">
                    <div class="lbl">Taxa de acerto</div>
                    <div class="val" id="finalAcc">0%</div>
                  </div>
                  <div class="kpi">
                    <div class="lbl">Quantidade</div>
                    <div class="val" id="finalQtd">0</div>
                  </div>
                  <div class="kpi">
                    <div class="lbl">Acertos</div>
                    <div class="val" id="finalHits">0/0</div>
                  </div>
                </div>

                <div class="muted" style="margin-top:10px;" id="finalNotes"></div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                  <button class="btn" id="btnReviewWrong" type="button">Refazer erradas</button>
                  <button class="btn" id="btnExportJson" type="button">Exportar resultado (JSON)</button>
                  <button class="btn primary" id="btnNewRun" type="button">Novo simulado</button>
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="card-body">
                <div style="height:360px;">
                  <canvas id="chartByModule"></canvas>
                </div>
                <div class="muted" style="margin-top:10px;">
                  Acertos por ‚ÄúM√≥dulo ‚Äî Tema‚Äù (quantidade).
                </div>
              </div>
            </div>

            <div class="card" style="box-shadow:none; grid-column:1/-1;">
              <div class="card-body">
                <h3 class="title" style="font-size:15px; margin-bottom:8px;">Erradas (revis√£o r√°pida)</h3>
                <div id="wrongList" class="muted">‚Äî</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </main>

  <script>
    ;(() => {
      const $ = (id) => document.getElementById(id);

      /* =========================
         Helpers
      ========================== */
      const safeText = (v) => (v ?? '').toString();

      function normalizeStr(s){
        return safeText(s).toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      }

      const uniq = (arr) =>
        Array.from(new Set(arr.filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b,'pt-BR'));

      function shuffle(arr){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [a[i],a[j]]=[a[j],a[i]];
        }
        return a;
      }

      const fmtTime = (ms) => {
        const total = Math.max(0, Math.floor(ms/1000));
        const h = String(Math.floor(total/3600)).padStart(2,'0');
        const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
        const s = String(total%60).padStart(2,'0');
        return `${h}:${m}:${s}`;
      };

      /* =========================
         Storage
      ========================== */
      const LS_PREFS = "pqo_prefs_eumebanco_v1";
      const LS_HIST  = "pqo_history_eumebanco_v1";

      /* =========================
         State
      ========================== */
      const state = {
        all: [],
        filtered: [],
        queue: [],
        idx: 0,

        started: false,
        startAt: null,
        elapsedMs: 0,
        timerId: null,

        noRepeat: false,
        shuffle: true,
        examMode: false,

        current: null,
        selected: null,
        confirmed: false,

        answers: [] // {id,module,chapter,theme,level,selected,correct,ts}
      };

      /* =========================
         Views
      ========================== */
      const views = {
        wizard: $("viewWizard"),
        quiz: $("viewQuiz"),
        dash: $("viewDashboard")
      };
      function showView(name){
        Object.entries(views).forEach(([k, el]) => el.classList.toggle("show", k===name));
      }

      /* =========================
         Stepper / Wizard
      ========================== */
      let wizardStep = 1;

      function setStepper(step){
        wizardStep = step;
        const steps = [1,2,3,4];
        steps.forEach(n => {
          const el = $("st"+n);
          el.classList.toggle("active", n===step);
          el.classList.toggle("done", n<step);
        });
        $("step1Box").style.display = step===1 ? "" : "none";
        $("step2Box").style.display = step===2 ? "" : "none";
        $("step3Box").style.display = step===3 ? "" : "none";
        $("step4Box").style.display = step===4 ? "" : "none";
      }

      /* =========================
         Preferences
      ========================== */
      function loadPrefs(){
        try{
          const raw = localStorage.getItem(LS_PREFS);
          if(!raw) return;
          const p = JSON.parse(raw);
          state.noRepeat = !!p.noRepeat;
          state.shuffle = p.shuffle !== false;
          state.examMode = !!p.examMode;
        }catch{}
      }
      function savePrefs(){
        localStorage.setItem(LS_PREFS, JSON.stringify({
          noRepeat: state.noRepeat,
          shuffle: state.shuffle,
          examMode: state.examMode
        }));
      }

      function getHistorySet(){
        try{ return new Set(JSON.parse(localStorage.getItem(LS_HIST) || "[]")); }
        catch{ return new Set(); }
      }
      function addToHistory(id){
        const s = getHistorySet();
        s.add(id);
        localStorage.setItem(LS_HIST, JSON.stringify([...s]));
      }

      /* =========================
         Switch UI
      ========================== */
      function setSwitch(el, on){
        el.classList.toggle("on", !!on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      }
      function bindSwitch(el, getter, setter){
        const toggle = () => {
          setter(!getter());
          setSwitch(el, getter());
          savePrefs();
          applyFilters();
          updateConfirmText();
        };
        el.addEventListener("click", toggle);
        el.addEventListener("keydown", (e) => {
          if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggle(); }
        });
      }

      /* =========================
         Filters
      ========================== */
      function fillSelect(sel, values, placeholder){
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = placeholder;
        sel.appendChild(opt0);

        values.forEach(v => {
          const op = document.createElement("option");
          op.value = v;
          op.textContent = v;
          sel.appendChild(op);
        });
      }

      function buildFilterOptions(){
        fillSelect($("selModule"), uniq(state.all.map(x=>x.module)), "Todos");
        fillSelect($("selChapter"), uniq(state.all.map(x=>x.chapter)), "Todos");
        fillSelect($("selTheme"), uniq(state.all.map(x=>x.theme)), "Todos");
        fillSelect($("selLevel"), uniq(state.all.map(x=>x.level)), "Todas");
      }

      function applyFilters(){
        const m = $("selModule").value;
        const c = $("selChapter").value;
        const t = $("selTheme").value;
        const l = $("selLevel").value;
        const s = normalizeStr($("searchText").value);

        const hist = getHistorySet();

        const base = state.all.filter(q => {
          if(m && q.module !== m) return false;
          if(c && q.chapter !== c) return false;
          if(t && q.theme !== t) return false;
          if(l && q.level !== l) return false;

          if(s){
            const blob = normalizeStr([q.id,q.module,q.chapter,q.theme,q.level,q.q,
              q.options?.A,q.options?.B,q.options?.C,q.options?.D,q.options?.E,q.explain].join(" "));
            if(!blob.includes(s)) return false;
          }

          if(state.noRepeat && hist.has(q.id)) return false;
          return true;
        });

        state.filtered = base;
        let q = state.shuffle ? shuffle(base) : base.slice();
        if(state.examMode) q = q.slice(0, 60);
        state.queue = q;
        state.idx = 0;

        $("chipSelected").textContent = String(state.queue.length);
        $("filterInfo").textContent = `Encontradas: ${state.queue.length} quest√µes (base: ${state.all.length}).`;
        updateConfirmText();
      }

      function clearFiltersUi(){
        $("selModule").value = "";
        $("selChapter").value = "";
        $("selTheme").value = "";
        $("selLevel").value = "";
        $("searchText").value = "";
        applyFilters();
      }

      function updateConfirmText(){
        const mode = state.examMode ? "Prova (60)" : "Treino";
        const nr = state.noRepeat ? "Sim" : "N√£o";
        const sh = state.shuffle ? "Sim" : "N√£o";
        $("confirmText").textContent =
          `Modo: ${mode}. N√£o repetir: ${nr}. Embaralhar: ${sh}. ` +
          `Quest√µes selecionadas: ${state.queue.length}.`;
        $("chipSelected").textContent = String(state.queue.length);
      }

      /* =========================
         Quiz
      ========================== */
      function updateProgressBar(){
        const total = state.queue.length || 0;
        const current = Math.min(state.idx + 1, total);
        const pct = total ? Math.round((current/total)*100) : 0;
        const fill = $("pbFill");
        fill.style.width = `${pct}%`;
        fill.textContent = `${pct}% (Quest√£o ${current}/${total})`;
      }

      function renderQuestion(q){
        if(!q) return;

        state.current = q;
        state.selected = null;
        state.confirmed = false;

        $("qTopTitle").textContent = `Quest√£o ${state.idx + 1}`;
        $("qTopSub").textContent = `Identificador: ${q.id || "‚Äî"}`;

        // meta
        $("qMeta").innerHTML = "";
        const pill = (txt, cls="") => {
          const s = document.createElement("span");
          s.className = `pill ${cls}`.trim();
          s.textContent = txt;
          return s;
        };
        $("qMeta").appendChild(pill(`M√≥dulo: ${q.module || "‚Äî"}`));
        if(q.theme) $("qMeta").appendChild(pill(`Assunto: ${q.theme}`, "yellow"));
        if(q.level) $("qMeta").appendChild(pill(`N√≠vel: ${q.level}`));

        $("qText").textContent = safeText(q.q);

        // options
        const opts = $("qOptions");
        opts.innerHTML = "";

        const letters = ["A","B","C","D","E"];
        letters.forEach(L => {
          const v = q.options?.[L];
          if(v == null || safeText(v).trim()==="") return;

          const row = document.createElement("div");
          row.className = "opt";

          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "opt";
          radio.value = L;

          const txt = document.createElement("div");
          txt.style.fontWeight = "750";
          txt.style.fontSize = "13px";
          txt.textContent = `${L}) ${safeText(v)}`;

          row.appendChild(radio);
          row.appendChild(txt);

          const selectThis = () => {
            if(state.confirmed) return;
            [...opts.querySelectorAll(".opt")].forEach(x => x.classList.remove("selected"));
            row.classList.add("selected");
            radio.checked = true;
            state.selected = L;
            $("qStatus").textContent = "Alternativa selecionada. Clique em ‚ÄúCorrigir Quest√£o‚Äù.";
            $("btnConfirm").disabled = false;
          };

          row.addEventListener("click", selectThis);
          radio.addEventListener("change", selectThis);

          opts.appendChild(row);
        });

        // explain
        $("qExplain").classList.remove("show");
        $("qExplain").textContent = safeText(q.explain || "");

        $("btnConfirm").disabled = true;
        $("btnNext").disabled = true;
        $("btnPrev").disabled = state.idx === 0; // visual
        $("btnFinish").disabled = false;

        $("qStatus").textContent = "Selecione uma alternativa.";
        updateProgressBar();
      }

      function confirmAnswer(){
        if(!state.current || !state.selected || state.confirmed) return;
        state.confirmed = true;

        const q = state.current;
        const correct = (state.selected === q.answer);

        state.answers.push({
          id: q.id,
          module: q.module,
          chapter: q.chapter,
          theme: q.theme,
          level: q.level,
          selected: state.selected,
          correct,
          ts: Date.now()
        });

        addToHistory(q.id);

        // mostra explica√ß√£o (igual ‚Äúcorrigir quest√£o‚Äù)
        $("qExplain").classList.add("show");
        $("qStatus").textContent = correct ? "‚úÖ Correto." : "‚ùå Incorreto.";
        $("btnConfirm").disabled = true;
        $("btnNext").disabled = false;
      }

      function nextQuestion(){
        if(!state.confirmed){
          $("qStatus").textContent = "Corrija a quest√£o antes de avan√ßar.";
          return;
        }
        state.idx++;
        if(state.idx >= state.queue.length){
          finishQuiz();
          return;
        }
        renderQuestion(state.queue[state.idx]);
      }

      function prevQuestion(){
        // Mantive s√≥ visual (como no print). Se quiser ‚Äúvoltar e editar‚Äù, eu implemento certinho depois.
        if(state.idx===0) return;
        state.idx--;
        renderQuestion(state.queue[state.idx]);
      }

      /* =========================
         Timer / Start / Finish
      ========================== */
      function tick(){
        state.elapsedMs = Date.now() - state.startAt;
        $("chipTimer").textContent = fmtTime(state.elapsedMs);
      }

      function startQuiz(){
        if(!state.queue.length){
          alert("Nenhuma quest√£o encontrada com esses filtros.");
          return;
        }

        state.answers = [];
        state.idx = 0;
        state.started = true;

        state.startAt = Date.now();
        state.elapsedMs = 0;
        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(tick, 250);

        showView("quiz");
        renderQuestion(state.queue[0]);
      }

      function finishQuiz(){
        clearInterval(state.timerId);
        state.timerId = null;
        state.started = false;

        buildFinalDashboard();
        showView("dash");
      }

      /* =========================
         Dashboard
      ========================== */
      let chartRef = null;

      function buildFinalDashboard(){
        const total = state.queue.length;
        const answered = state.answers.length;
        const hits = state.answers.filter(x=>x.correct).length;
        const acc = total ? Math.round((hits/total)*100) : 0;

        $("finalTime").textContent = fmtTime(state.elapsedMs);
        $("finalAcc").textContent = `${acc}%`;
        $("finalQtd").textContent = String(total);
        $("finalHits").textContent = `${hits}/${total}`;

        const notes = [];
        notes.push(`Respondidas: ${answered}/${total}.`);
        notes.push(`Modo: ${state.examMode ? "Prova (60)" : "Treino"}.`);
        $("finalNotes").textContent = notes.join(" ");

        // erradas
        const wrong = state.answers.filter(x=>!x.correct);
        const box = $("wrongList");
        if(!wrong.length){
          box.textContent = "Nenhuma errada üéâ";
        }else{
          const ul = document.createElement("ul");
          ul.style.margin = "0";
          ul.style.paddingLeft = "18px";
          ul.style.lineHeight = "1.5";
          wrong.slice(0, 250).forEach(w => {
            const li = document.createElement("li");
            li.innerHTML = `<b>${w.id}</b> ‚Äî ${safeText(w.module)} ‚Ä¢ ${safeText(w.theme)} (marcou ${w.selected}, gabarito ${findAnswerLetter(w.id)})`;
            ul.appendChild(li);
          });
          box.innerHTML = "";
          box.appendChild(ul);
        }

        // chart por m√≥dulo/tema
        const map = new Map();
        state.answers.forEach(a => {
          const key = `${a.module} ‚Äî ${a.theme}`;
          const cur = map.get(key) || {hits:0,total:0};
          cur.total += 1;
          if(a.correct) cur.hits += 1;
          map.set(key, cur);
        });

        const entries = [...map.entries()].sort((a,b)=>b[1].total - a[1].total);
        const labels = entries.map(e=>e[0]);
        const dataHits = entries.map(e=>e[1].hits);

        const ctx = $("chartByModule").getContext("2d");
        if(chartRef) chartRef.destroy();

        chartRef = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label: "Acertos", data: dataHits }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { maxRotation: 60, minRotation: 0 } },
              y: { beginAtZero: true, precision: 0 }
            }
          }
        });
      }

      function findAnswerLetter(id){
        const q = state.all.find(x => x.id === id);
        return q?.answer || "?";
      }

      function reviewWrong(){
        const wrongIds = new Set(state.answers.filter(x=>!x.correct).map(x=>x.id));
        const wrongQs = state.all.filter(q => wrongIds.has(q.id));
        state.queue = state.shuffle ? shuffle(wrongQs) : wrongQs.slice();
        state.idx = 0;
        state.answers = [];
        state.started = false;
        $("chipSelected").textContent = String(state.queue.length);

        showView("quiz");
        startQuiz();
      }

      function exportResultJson(){
        const payload = {
          generatedAt: new Date().toISOString(),
          durationMs: state.elapsedMs,
          totalQuestions: state.queue.length,
          answers: state.answers
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "resultado_pqo_risco.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }

      /* =========================
         DB Load
      ========================== */
      async function loadDb(){
        const url = "./QuestoesPQO.json"; // <- sem acento (recomendado)
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      }

      function sanitizeDb(data){
        const arr = Array.isArray(data) ? data : [];
        return arr.map(q => ({
          id: safeText(q.id),
          module: safeText(q.module),
          chapter: safeText(q.chapter),
          theme: safeText(q.theme),
          level: safeText(q.level),
          q: safeText(q.q),
          options: q.options || {},
          answer: safeText(q.answer).trim().toUpperCase(),
          explain: safeText(q.explain)
        })).filter(q => q.id && q.q && q.options && q.answer);
      }

      /* =========================
         Bind
      ========================== */
      function bind(){
        // switches (step 4)
        bindSwitch($("swNoRepeat"), () => state.noRepeat, v => state.noRepeat = v);
        bindSwitch($("swShuffle"), () => state.shuffle, v => state.shuffle = v);
        bindSwitch($("swExam"), () => state.examMode, v => state.examMode = v);

        // wizard navigation
        $("btnGo2").addEventListener("click", () => setStepper(2));
        $("btnBack1").addEventListener("click", () => setStepper(1));
        $("btnGo3").addEventListener("click", () => setStepper(3));
        $("btnBack2").addEventListener("click", () => setStepper(2));
        $("btnGo4").addEventListener("click", () => setStepper(4));
        $("btnBack3").addEventListener("click", () => setStepper(3));

        // modality cards (visual)
        const selectMode = (el) => {
          ["modeModule","modeQuestions","modeSubjects"].forEach(id => $(id).classList.remove("selected"));
          el.classList.add("selected");
        };
        $("modeModule").addEventListener("click", () => selectMode($("modeModule")));
        $("modeQuestions").addEventListener("click", () => selectMode($("modeQuestions")));
        $("modeSubjects").addEventListener("click", () => selectMode($("modeSubjects")));

        // filters change
        ["selModule","selChapter","selTheme","selLevel"].forEach(id => {
          $(id).addEventListener("change", applyFilters);
        });
        $("searchText").addEventListener("keydown", (e) => {
          if(e.key==="Enter"){ e.preventDefault(); applyFilters(); }
        });
        $("searchText").addEventListener("input", () => applyFilters());

        $("btnClearFilters").addEventListener("click", clearFiltersUi);

        // start
        $("btnStart").addEventListener("click", () => {
          applyFilters();
          startQuiz();
        });

        // quiz
        $("btnConfirm").addEventListener("click", confirmAnswer);
        $("btnNext").addEventListener("click", nextQuestion);
        $("btnPrev").addEventListener("click", prevQuestion);
        $("btnFinish").addEventListener("click", finishQuiz);

        // dashboard
        $("btnReviewWrong").addEventListener("click", reviewWrong);
        $("btnExportJson").addEventListener("click", exportResultJson);
        $("btnNewRun").addEventListener("click", () => {
          showView("wizard");
          setStepper(1);
        });
      }

      /* =========================
         Boot
      ========================== */
      async function boot(){
        loadPrefs();
        setSwitch($("swNoRepeat"), state.noRepeat);
        setSwitch($("swShuffle"), state.shuffle);
        setSwitch($("swExam"), state.examMode);

        bind();

        try{
          const raw = await loadDb();
          state.all = sanitizeDb(raw);
          $("dbStatus").textContent = `Base carregada ‚úÖ (QuestoesPQO.json) ‚Ä¢ Total: ${state.all.length}`;
        }catch(err){
          state.all = [];
          $("dbStatus").textContent =
            "N√£o consegui carregar o JSON ‚ùå Confirme se o arquivo est√° no mesmo diret√≥rio e se chama QuestoesPQO.json (sem acento).";
          console.error(err);
        }

        $("chipBase").textContent = String(state.all.length);

        buildFilterOptions();
        applyFilters();
        updateConfirmText();
        setStepper(1);
      }

      boot();
      window.__PQO = state;
    })();
  </script>
</body>
</html>
