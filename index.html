<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PQO Risco ‚Äî Simulador</title>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Paleta azul + verde (com neutros) */
      --bg: #F6F9FC;
      --panel: #FFFFFF;
      --panel-2: #F0F6FF;

      --text: #0B1220;
      --muted: #5B677A;

      --border: rgba(15, 23, 42, .10);
      --shadow: 0 14px 40px rgba(2, 8, 23, .08);

      --blue-950:#07132B;
      --blue-900:#0B1B3A;
      --blue-800:#0E2A5A;
      --blue-700:#1742A3;
      --blue-600:#2563EB;
      --blue-500:#3B82F6;

      --green-700:#0D7A4E;
      --green-600:#16A34A;
      --green-500:#22C55E;
      --green-200:#BBF7D0;

      --warn:#F59E0B;
      --danger:#EF4444;

      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;

      --side-w: 292px;
      --top-h: 64px;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== Layout geral (Sidebar + Conte√∫do) ===== */
    .app{
      display:grid;
      grid-template-columns: var(--side-w) 1fr;
      min-height: 100vh;
    }

    /* ===== Sidebar (estilo B3) ===== */
    .sidebar{
      position: sticky;
      top: 0;
      height: 100vh;
      background: linear-gradient(180deg, var(--blue-900), var(--blue-950));
      color: #EAF1FF;
      padding: 18px 14px;
      border-right: 1px solid rgba(255,255,255,.08);
      overflow: hidden;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px 16px 12px;
    }
    .brand-badge{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: rgba(59,130,246,.18);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.12);
    }
    .brand-badge svg{ width: 20px; height: 20px; fill:#CFE2FF; }
    .brand h1{
      font-size: 14px;
      margin:0;
      line-height: 1.15;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .brand small{
      display:block;
      opacity:.8;
      font-weight: 600;
      margin-top: 2px;
      font-size: 12px;
    }

    .side-section{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.06);
    }
    .side-title{
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .4px;
      opacity: .95;
      margin: 0 0 10px 2px;
      text-transform: uppercase;
    }

    .nav{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .nav button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: #EAF1FF;
      border-radius: 12px;
      padding: 10px 10px;
      text-align:left;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      transition: .15s ease;
      font-weight: 800;
      font-size: 13px;
    }
    .nav button:hover{ background: rgba(59,130,246,.16); border-color: rgba(59,130,246,.35); }
    .nav button.active{ background: rgba(59,130,246,.22); border-color: rgba(59,130,246,.45); }
    .nav .hint{
      font-weight: 800;
      opacity: .75;
      font-size: 12px;
    }

    .side-controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      font-weight: 800;
      color: rgba(234,241,255,.92);
    }
    .switch{
      width: 42px; height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.18);
      position: relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      top: 2px; left: 2px;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 999px;
      transition: .15s ease;
    }
    .switch.on{ background: rgba(34,197,94,.28); border-color: rgba(34,197,94,.45); }
    .switch.on::after{ transform: translateX(18px); }

    .side-footer{
      position:absolute;
      bottom: 14px;
      left: 14px;
      right: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .pill{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
      font-size: 12px;
      color: rgba(234,241,255,.92);
    }
    .pill strong{ font-size: 12px; }
    .pill .mini{ opacity:.78; font-weight: 750; }

    /* ===== √Årea principal ===== */
    .main{
      display:flex;
      flex-direction: column;
      min-width: 0;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      height: var(--top-h);
      background: rgba(246,249,252,.82);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 18px;
      gap: 12px;
    }

    .page-title{
      display:flex;
      flex-direction: column;
      min-width: 0;
    }
    .page-title strong{
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .page-title span{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 8px 18px rgba(2, 8, 23, .06);
      font-size: 12px;
      font-weight: 900;
      color: var(--blue-900);
      white-space: nowrap;
    }
    .chip b{ color: var(--green-700); }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      transition: .15s ease;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      box-shadow: 0 10px 22px rgba(2, 8, 23, .06);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue-700), var(--blue-600));
      border-color: rgba(37,99,235,.55);
      color:#fff;
    }
    .btn.success{
      background: linear-gradient(135deg, var(--green-700), var(--green-600));
      border-color: rgba(22,163,74,.6);
      color:#fff;
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(37,99,235,.25);
      color: var(--blue-700);
      box-shadow: none;
    }
    .btn.danger{
      background: #fff;
      border-color: rgba(239,68,68,.35);
      color: var(--danger);
    }
    .btn:disabled{
      opacity: .55;
      cursor:not-allowed;
      transform:none;
    }

    .content{
      padding: 18px;
      min-width: 0;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,0));
    }
    .card-header h2{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .card-header .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
    }
    .card-body{ padding: 16px; }

    /* ===== HOME (clean) ===== */
    .home-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      align-items: start;
    }
    .hero{
      padding: 18px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background:
        radial-gradient(1200px 400px at 10% 0%, rgba(37,99,235,.12), transparent 55%),
        radial-gradient(900px 420px at 90% 30%, rgba(34,197,94,.10), transparent 55%),
        #fff;
      box-shadow: var(--shadow);
    }
    .hero h1{
      margin:0 0 6px 0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: .2px;
      color: var(--blue-900);
    }
    .hero p{
      margin:0;
      color: var(--muted);
      font-weight: 700;
      line-height: 1.45;
      font-size: 13px;
    }

    .action-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .action{
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      padding: 14px;
      cursor:pointer;
      transition: .15s ease;
      box-shadow: 0 10px 22px rgba(2,8,23,.06);
    }
    .action:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 34px rgba(2,8,23,.10);
      border-color: rgba(37,99,235,.25);
    }
    .action .top{
      display:flex; align-items:center; justify-content: space-between; gap: 12px;
    }
    .badge{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:grid; place-items:center;
      font-weight: 950;
      color: #fff;
      background: linear-gradient(135deg, var(--blue-700), var(--blue-600));
    }
    .badge.green{
      background: linear-gradient(135deg, var(--green-700), var(--green-600));
    }
    .badge.gray{
      background: linear-gradient(135deg, #475569, #0f172a);
    }
    .action h3{
      margin: 10px 0 4px 0;
      font-size: 14px;
      font-weight: 950;
      color: var(--text);
    }
    .action p{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      line-height: 1.35;
    }

    .home-side{
      display:flex;
      flex-direction: column;
      gap: 16px;
    }

    .mini-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(34,197,94,.08), rgba(255,255,255,0));
      padding: 12px 12px;
    }
    .kpi .lbl{
      font-size: 12px;
      font-weight: 850;
      color: var(--muted);
    }
    .kpi .val{
      font-size: 18px;
      font-weight: 950;
      margin-top: 4px;
      letter-spacing: .2px;
      color: var(--blue-900);
    }

    .note{
      border-radius: 16px;
      border: 1px dashed rgba(37,99,235,.35);
      background: rgba(37,99,235,.05);
      padding: 12px;
      color: rgba(11,18,32,.88);
      font-size: 12px;
      font-weight: 700;
      line-height: 1.45;
    }

    /* ===== QUIZ ===== */
    .quiz-layout{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
      align-items: start;
    }

    .q-meta{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.18);
      font-size: 12px;
      font-weight: 900;
      color: var(--blue-900);
    }
    .tag.green{
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.18);
      color: var(--green-700);
    }
    .tag.gray{
      background: rgba(15,23,42,.06);
      border-color: rgba(15,23,42,.10);
      color: var(--muted);
    }

    .q-title{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .2px;
      margin: 0 0 10px 0;
    }
    .q-text{
      margin: 0 0 14px 0;
      line-height: 1.55;
      font-size: 14px;
      color: rgba(11,18,32,.92);
      white-space: pre-wrap;
    }

    .options{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .opt{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      cursor:pointer;
      transition: .15s ease;
      user-select: none;
    }
    .opt:hover{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 12px 26px rgba(2,8,23,.08);
      transform: translateY(-1px);
    }
    .opt .letter{
      width: 28px; height: 28px;
      border-radius: 10px;
      display:grid; place-items:center;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.18);
      font-weight: 950;
      color: var(--blue-900);
      flex: 0 0 auto;
    }
    .opt .txt{
      font-size: 13px;
      font-weight: 700;
      color: rgba(11,18,32,.92);
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .opt.selected{
      border-color: rgba(22,163,74,.45);
      background: rgba(34,197,94,.07);
    }
    .opt.selected .letter{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.25);
      color: var(--green-700);
    }

    .explain{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(37,99,235,.18);
      background: rgba(37,99,235,.06);
      color: rgba(11,18,32,.92);
      font-size: 13px;
      line-height: 1.45;
      display:none;
      white-space: pre-wrap;
    }
    .explain.show{ display:block; }

    .status{
      font-size: 13px;
      font-weight: 950;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .status.ok{ color: var(--green-700); border-color: rgba(22,163,74,.30); background: rgba(34,197,94,.08); }
    .status.bad{ color: var(--danger); border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.06); }
    .status.neutral{ color: var(--muted); }

    .quiz-footer{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .quiz-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ===== DASHBOARD ===== */
    .final{ display:none; }
    .final.show{ display:block; }

    .final-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .chart-wrap{
      padding: 12px;
    }
    .hr{
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }
    .muted{
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      line-height: 1.45;
    }

    /* ===== Modal ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(2,8,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width: min(860px, 100%);
      border-radius: 18px;
      background: #fff;
      border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 24px 60px rgba(2,8,23,.35);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,0));
    }
    .modal-head h2{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .modal-body{
      padding: 16px;
    }
    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: var(--blue-900);
    }
    .field select, .field input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 13px;
      font-weight: 700;
      outline: none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .modal-foot{
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      background: #fff;
    }

    /* ===== Views ===== */
    .view{ display:none; }
    .view.show{ display:block; }

    /* Responsivo */
    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position: relative; height: auto; }
      .side-footer{ position: static; margin-top: 10px; }
      .home-grid{ grid-template-columns: 1fr; }
      .quiz-layout{ grid-template-columns: 1fr; }
      .final-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- ========================= SIDEBAR ========================= -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 2a10 10 0 0 0-3.16 19.49c.5.09.68-.22.68-.48v-1.7c-2.77.6-3.36-1.18-3.36-1.18-.46-1.17-1.12-1.48-1.12-1.48-.91-.62.07-.61.07-.61 1 .07 1.53 1.04 1.53 1.04.9 1.54 2.37 1.09 2.95.83.09-.66.35-1.09.64-1.34-2.21-.25-4.54-1.11-4.54-4.95 0-1.09.39-1.98 1.03-2.68-.1-.25-.45-1.27.1-2.65 0 0 .84-.27 2.75 1.02A9.6 9.6 0 0 1 12 6.8c.85 0 1.71.12 2.51.35 1.91-1.29 2.75-1.02 2.75-1.02.55 1.38.2 2.4.1 2.65.64.7 1.03 1.59 1.03 2.68 0 3.85-2.33 4.7-4.55 4.95.36.31.68.92.68 1.86v2.76c0 .26.18.58.69.48A10 10 0 0 0 12 2z"/>
          </svg>
        </div>
        <div>
          <h1>PQO Risco</h1>
          <small>Simulador ‚Ä¢ Banco de Quest√µes</small>
        </div>
      </div>

      <div class="side-section">
        <div class="side-title">Navega√ß√£o</div>
        <div class="nav">
          <button id="navHome" class="active" type="button">
            In√≠cio
            <span class="hint">üè†</span>
          </button>
          <button id="navQuiz" type="button">
            Simulado
            <span class="hint" id="navCount">0</span>
          </button>
          <button id="navDashboard" type="button">
            Dashboard
            <span class="hint">üìä</span>
          </button>
        </div>
      </div>

      <div class="side-section">
        <div class="side-title">Prefer√™ncias</div>
        <div class="side-controls">
          <div class="toggle" title="Evita repetir quest√µes j√° feitas">
            N√£o repetir
            <div id="swNoRepeat" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
          <div class="toggle" title="Embaralha a ordem das quest√µes">
            Embaralhar
            <div id="swShuffle" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
        </div>

        <div class="side-controls" style="margin-top:10px;">
          <div class="toggle" title="Revela explica√ß√£o ap√≥s confirmar a resposta">
            Mostrar explica√ß√£o
            <div id="swExplain" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
          <div class="toggle" title="Modo prova (60 quest√µes)">
            Modo prova (60)
            <div id="swExam" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
        </div>

        <div class="side-controls" style="margin-top:10px;">
          <button class="btn danger" id="btnResetHistory" type="button" style="width:100%; justify-content:center; box-shadow:none;">
            Limpar hist√≥rico
          </button>
        </div>
      </div>

      <div class="side-footer">
        <div class="pill">
          <div>
            <strong>Progresso</strong>
            <div class="mini" id="pillProgress">0 / 0</div>
          </div>
          <div class="mini" id="pillAccuracy">‚Äî</div>
        </div>
        <div class="pill">
          <div>
            <strong>Tempo</strong>
            <div class="mini" id="pillTime">00:00:00</div>
          </div>
          <div class="mini" id="pillMode">Treino</div>
        </div>
      </div>
    </aside>

    <!-- ========================= MAIN ========================= -->
    <main class="main">
      <header class="topbar">
        <div class="page-title">
          <strong id="topTitle">In√≠cio</strong>
          <span id="topSub">Tudo em um fluxo simples: configurar ‚Üí responder ‚Üí ver dashboard.</span>
        </div>

        <div class="topbar-right">
          <div class="chip">Base: <b id="chipBase">0</b></div>
          <div class="chip">Filtro: <b id="chipFilter">0</b></div>
          <div class="chip">Timer: <b id="chipTimer">00:00:00</b></div>
        </div>
      </header>

      <section class="content">

        <!-- ========================= HOME VIEW ========================= -->
        <section class="view show" id="viewHome">
          <div class="home-grid">
            <div>
              <div class="hero">
                <h1>PQO Risco ‚Äî Simulador</h1>
                <p>
                  P√°gina inicial limpa. Voc√™ s√≥ faz 3 coisas: <b>come√ßar</b> (com filtro), <b>continuar</b> (se tiver sess√£o) e ver o <b>dashboard</b>.
                </p>

                <div class="action-grid" style="margin-top:14px;">
                  <div class="action" id="actNew">
                    <div class="top">
                      <div class="badge">‚ñ∂</div>
                      <span class="muted">Configurar</span>
                    </div>
                    <h3>Novo simulado</h3>
                    <p>Escolha filtros, modo prova e prefer√™ncias. Depois, come√ßar.</p>
                  </div>

                  <div class="action" id="actContinue">
                    <div class="top">
                      <div class="badge green">‚èµ</div>
                      <span class="muted">Retomar</span>
                    </div>
                    <h3>Continuar</h3>
                    <p>Volta para a quest√£o atual (se houver sess√£o em andamento).</p>
                  </div>

                  <div class="action" id="actDashboard">
                    <div class="top">
                      <div class="badge gray">üìä</div>
                      <span class="muted">Resultado</span>
                    </div>
                    <h3>Dashboard</h3>
                    <p>Tempo, taxa de acerto e desempenho por m√≥dulo/tema.</p>
                  </div>

                  <div class="action" id="actQuickExam">
                    <div class="top">
                      <div class="badge">60</div>
                      <span class="muted">Atalho</span>
                    </div>
                    <h3>Prova r√°pida</h3>
                    <p>Ativa modo prova (60) e abre a configura√ß√£o.</p>
                  </div>
                </div>
              </div>

              <div class="card" style="margin-top:16px;">
                <div class="card-header">
                  <div>
                    <h2>Como funciona</h2>
                    <div class="sub">Sem bagun√ßa: cada tela tem um objetivo</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="muted">
                    1) <b>Novo simulado</b> ‚Üí abre um modal para filtrar.<br/>
                    2) <b>Simulado</b> ‚Üí tela focada. A√ß√µes s√≥ no rodap√© (Confirmar / Pr√≥xima / Finalizar).<br/>
                    3) <b>Dashboard</b> ‚Üí voc√™ v√™ o desempenho completo e revisa erradas.
                  </div>
                </div>
              </div>
            </div>

            <div class="home-side">
              <div class="card">
                <div class="card-header">
                  <div>
                    <h2>Status</h2>
                    <div class="sub" id="dbInfo">Carregando base‚Ä¶</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mini-grid">
                    <div class="kpi">
                      <div class="lbl">Modo</div>
                      <div class="val" id="kpiMode">Treino</div>
                    </div>
                    <div class="kpi">
                      <div class="lbl">Quest√µes</div>
                      <div class="val" id="kpiTotal">0</div>
                    </div>
                    <div class="kpi">
                      <div class="lbl">Respondidas</div>
                      <div class="val" id="kpiAnswered">0</div>
                    </div>
                    <div class="kpi">
                      <div class="lbl">Restantes</div>
                      <div class="val" id="kpiRemaining">0</div>
                    </div>
                  </div>

                  <div class="hr"></div>

                  <div class="note" id="noteLoad">
                    Carregamento autom√°tico via GitHub Pages:
                    <b>./Quest√µesPQO.json</b><br/>
                    Se der erro, renomeie para <b>QuestoesPQO.json</b> (sem acento).
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ========================= QUIZ VIEW ========================= -->
        <section class="view" id="viewQuiz">
          <div class="quiz-layout">
            <section class="card">
              <div class="card-header">
                <div>
                  <h2 id="quizHeaderTitle">Simulado</h2>
                  <div class="sub" id="quizHeaderSub">Responda e avance. Resultado s√≥ no dashboard final.</div>
                </div>
                <div class="sub" id="quizProgressText">‚Äî</div>
              </div>

              <div class="card-body">
                <div id="questionArea" style="display:none;">
                  <div class="q-meta" id="qMeta"></div>
                  <h3 class="q-title" id="qTitle"></h3>
                  <p class="q-text" id="qText"></p>

                  <div class="options" id="qOptions"></div>

                  <div class="quiz-footer">
                    <span class="status neutral" id="qStatus">Selecione uma alternativa.</span>

                    <div class="quiz-actions">
                      <button class="btn" id="btnConfirm" type="button" disabled>Confirmar</button>
                      <button class="btn ghost" id="btnExplain" type="button" disabled>Explica√ß√£o</button>
                      <button class="btn" id="btnNext" type="button" disabled>Pr√≥xima</button>
                      <button class="btn success" id="btnFinish" type="button" disabled>Finalizar</button>
                    </div>
                  </div>

                  <div class="explain" id="qExplain"></div>
                  <div class="muted" id="qHint" style="margin-top:10px;"></div>
                </div>

                <div id="quizEmpty" class="muted">
                  Nenhuma quest√£o carregada ainda. Volte para <b>In√≠cio</b> e clique em <b>Novo simulado</b>.
                </div>
              </div>
            </section>

            <aside class="card">
              <div class="card-header">
                <div>
                  <h2>Resumo</h2>
                  <div class="sub">Sem spoilers no meio</div>
                </div>
              </div>
              <div class="card-body">
                <div class="mini-grid">
                  <div class="kpi">
                    <div class="lbl">No modo</div>
                    <div class="val" id="kpiMode2">Treino</div>
                  </div>
                  <div class="kpi">
                    <div class="lbl">Qtd. quest√µes</div>
                    <div class="val" id="kpiTotal2">0</div>
                  </div>
                  <div class="kpi">
                    <div class="lbl">Respondidas</div>
                    <div class="val" id="kpiAnswered2">0</div>
                  </div>
                  <div class="kpi">
                    <div class="lbl">Restantes</div>
                    <div class="val" id="kpiRemaining2">0</div>
                  </div>
                </div>

                <div class="hr"></div>

                <div class="muted">
                  ‚Ä¢ ‚ÄúN√£o repetir‚Äù usa hist√≥rico local do navegador.<br/>
                  ‚Ä¢ Resultado (acertos/erros) aparece apenas no <b>Dashboard</b>.<br/>
                  ‚Ä¢ ‚ÄúModo prova (60)‚Äù seleciona at√© 60 quest√µes do filtro.
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- ========================= DASHBOARD VIEW ========================= -->
        <section class="view" id="viewDashboard">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>Dashboard final</h2>
                <div class="sub">Tempo, taxa de acerto e desempenho por m√≥dulo/tema</div>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btnReviewWrong" type="button">Refazer erradas</button>
                <button class="btn" id="btnExportJson" type="button">Exportar resultado (JSON)</button>
              </div>
            </div>

            <div class="card-body">
              <div class="final-grid">
                <div class="card" style="box-shadow:none;">
                  <div class="card-header">
                    <div>
                      <h2>KPIs</h2>
                      <div class="sub">Vis√£o geral do simulado</div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="mini-grid">
                      <div class="kpi">
                        <div class="lbl">Dura√ß√£o</div>
                        <div class="val" id="finalTime">00:00:00</div>
                      </div>
                      <div class="kpi">
                        <div class="lbl">Taxa de acerto</div>
                        <div class="val" id="finalAcc">0%</div>
                      </div>
                      <div class="kpi">
                        <div class="lbl">Quantidade</div>
                        <div class="val" id="finalQtd">0</div>
                      </div>
                      <div class="kpi">
                        <div class="lbl">Acertos</div>
                        <div class="val" id="finalHits">0/0</div>
                      </div>
                    </div>
                    <div class="hr"></div>
                    <div class="muted" id="finalNotes"></div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none;">
                  <div class="card-header">
                    <div>
                      <h2>Acertos por M√≥dulo/Tema</h2>
                      <div class="sub">Barras em quantidade (acertos)</div>
                    </div>
                  </div>
                  <div class="card-body chart-wrap">
                    <div style="height:360px;">
                      <canvas id="chartByModule"></canvas>
                    </div>
                    <div class="muted" style="margin-top:10px;">
                      Dica: use os filtros na pr√≥xima rodada para treinar exatamente onde estiver errando.
                    </div>
                  </div>
                </div>

                <div class="card" style="box-shadow:none; grid-column: 1 / -1;">
                  <div class="card-header">
                    <div>
                      <h2>Erradas (revis√£o r√°pida)</h2>
                      <div class="sub">Lista resumida das quest√µes erradas</div>
                    </div>
                  </div>
                  <div class="card-body" id="wrongList"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </section>
    </main>
  </div>

  <!-- ========================= MODAL CONFIG ========================= -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <h2 id="modalTitle">Configurar simulado</h2>
          <div class="muted" id="modalSub">Filtre por T√≠tulo, Cap√≠tulo, Tema e Dificuldade</div>
        </div>
        <button class="btn ghost" id="btnCloseModal" type="button">Fechar</button>
      </div>

      <div class="modal-body">
        <div class="filters">
          <div class="field">
            <label for="selModule">T√≠tulo (M√≥dulo)</label>
            <select id="selModule"></select>
          </div>
          <div class="field">
            <label for="selChapter">Cap√≠tulo</label>
            <select id="selChapter"></select>
          </div>

          <div class="field">
            <label for="selTheme">Tema</label>
            <select id="selTheme"></select>
          </div>
          <div class="field">
            <label for="selLevel">Dificuldade</label>
            <select id="selLevel"></select>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="searchText">Busca (texto livre)</label>
            <input id="searchText" type="text" placeholder="Ex.: margem, CCP, nova√ß√£o, op√ß√µes, ICVM..." />
          </div>
        </div>

        <div class="hr"></div>

        <div class="muted">
          O simulado ser√° montado usando: <b>N√£o repetir</b>, <b>Embaralhar</b> e <b>Modo prova</b> (definidos na barra lateral).
        </div>
      </div>

      <div class="modal-foot">
        <div class="muted" id="modalInfo">‚Äî</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btnClearFilters" type="button">Limpar filtros</button>
          <button class="btn primary" id="btnStartQuiz" type="button">Come√ßar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    ;(() => {
      /* =========================
         Helpers
      ========================== */
      const $ = (id) => document.getElementById(id);

      const fmtTime = (ms) => {
        const total = Math.max(0, Math.floor(ms/1000));
        const h = String(Math.floor(total/3600)).padStart(2,'0');
        const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
        const s = String(total%60).padStart(2,'0');
        return `${h}:${m}:${s}`;
      };

      const uniq = (arr) =>
        Array.from(new Set(arr.filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b,'pt-BR'));

      const safeText = (v) => (v ?? '').toString();

      function normalizeStr(s){
        return safeText(s).toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      }

      function shuffle(arr){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [a[i],a[j]]=[a[j],a[i]];
        }
        return a;
      }

      /* =========================
         Storage Keys
      ========================== */
      const LS_PREFS = "pqo_prefs_v3";
      const LS_HIST  = "pqo_history_v3";
      const LS_SESSION = "pqo_session_v3"; // permite continuar

      /* =========================
         State
      ========================== */
      const state = {
        all: [],
        filtered: [],
        queue: [],
        idx: 0,
        started: false,
        startAt: null,
        elapsedMs: 0,
        timerId: null,

        // settings
        noRepeat: false,
        shuffle: true,
        showExplain: true,
        examMode: false,

        // current
        current: null,
        selected: null,
        confirmed: false,

        // results
        answers: [] // {id,module,chapter,theme,level,selected,correct,ts}
      };

      /* =========================
         Preferences
      ========================== */
      function loadPrefs(){
        try{
          const raw = localStorage.getItem(LS_PREFS);
          if(!raw) return;
          const p = JSON.parse(raw);
          state.noRepeat = !!p.noRepeat;
          state.shuffle = p.shuffle !== false;
          state.showExplain = p.showExplain !== false;
          state.examMode = !!p.examMode;
        }catch{}
      }
      function savePrefs(){
        const p = {
          noRepeat: state.noRepeat,
          shuffle: state.shuffle,
          showExplain: state.showExplain,
          examMode: state.examMode
        };
        localStorage.setItem(LS_PREFS, JSON.stringify(p));
      }

      function getHistorySet(){
        try{
          return new Set(JSON.parse(localStorage.getItem(LS_HIST) || "[]"));
        }catch{
          return new Set();
        }
      }
      function addToHistory(id){
        const s = getHistorySet();
        s.add(id);
        localStorage.setItem(LS_HIST, JSON.stringify([...s]));
      }

      function clearHistory(){
        localStorage.removeItem(LS_HIST);
        localStorage.removeItem(LS_SESSION);
      }

      /* =========================
         Switch UI
      ========================== */
      function setSwitch(el, on){
        el.classList.toggle("on", !!on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      }

      function bindSwitch(el, getter, setter){
        const toggle = () => {
          setter(!getter());
          setSwitch(el, getter());
          savePrefs();
          refreshModeBadges();
          updateHomeKpis();
        };
        el.addEventListener("click", toggle);
        el.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(); }
        });
      }

      /* =========================
         Views
      ========================== */
      const views = {
        home: $("viewHome"),
        quiz: $("viewQuiz"),
        dash: $("viewDashboard")
      };

      function showView(name){
        Object.entries(views).forEach(([k, el]) => el.classList.toggle("show", k === name));

        $("navHome").classList.toggle("active", name==="home");
        $("navQuiz").classList.toggle("active", name==="quiz");
        $("navDashboard").classList.toggle("active", name==="dash");

        if(name==="home"){
          $("topTitle").textContent = "In√≠cio";
          $("topSub").textContent = "Tudo em um fluxo simples: configurar ‚Üí responder ‚Üí ver dashboard.";
        }
        if(name==="quiz"){
          $("topTitle").textContent = "Simulado";
          $("topSub").textContent = "Tela focada. A√ß√µes apenas no rodap√©. Resultado no dashboard.";
        }
        if(name==="dash"){
          $("topTitle").textContent = "Dashboard";
          $("topSub").textContent = "Tempo, taxa de acerto e desempenho por m√≥dulo/tema.";
        }
      }

      /* =========================
         Modal
      ========================== */
      function openModal(){
        $("modalBackdrop").classList.add("show");
        $("modalBackdrop").setAttribute("aria-hidden","false");
      }
      function closeModal(){
        $("modalBackdrop").classList.remove("show");
        $("modalBackdrop").setAttribute("aria-hidden","true");
      }

      /* =========================
         Filters (Modal)
      ========================== */
      function fillSelect(sel, values, placeholder){
        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = placeholder;
        sel.appendChild(opt0);

        values.forEach(v => {
          const op = document.createElement("option");
          op.value = v;
          op.textContent = v;
          sel.appendChild(op);
        });
      }

      function buildFilterOptions(){
        fillSelect($("selModule"), uniq(state.all.map(x=>x.module)), "Todos");
        fillSelect($("selChapter"), uniq(state.all.map(x=>x.chapter)), "Todos");
        fillSelect($("selTheme"), uniq(state.all.map(x=>x.theme)), "Todos");
        fillSelect($("selLevel"), uniq(state.all.map(x=>x.level)), "Todas");
      }

      function applyFilters(){
        const m = $("selModule").value;
        const c = $("selChapter").value;
        const t = $("selTheme").value;
        const l = $("selLevel").value;
        const s = normalizeStr($("searchText").value);

        const hist = getHistorySet();

        const base = state.all.filter(q => {
          if(m && q.module !== m) return false;
          if(c && q.chapter !== c) return false;
          if(t && q.theme !== t) return false;
          if(l && q.level !== l) return false;

          if(s){
            const blob = normalizeStr([q.id,q.module,q.chapter,q.theme,q.level,q.q,
              q.options?.A,q.options?.B,q.options?.C,q.options?.D,q.options?.E,q.explain].join(" "));
            if(!blob.includes(s)) return false;
          }

          if(state.noRepeat && hist.has(q.id)) return false;
          return true;
        });

        state.filtered = base;

        let q = state.shuffle ? shuffle(base) : base.slice();
        if(state.examMode) q = q.slice(0, 60);

        state.queue = q;
        state.idx = 0;

        $("navCount").textContent = String(state.queue.length);
        $("chipFilter").textContent = String(state.queue.length);
        $("modalInfo").textContent = `Encontradas: ${state.queue.length} quest√µes (base: ${state.all.length}).`;

        updateHomeKpis();
      }

      function clearFiltersUi(){
        $("selModule").value = "";
        $("selChapter").value = "";
        $("selTheme").value = "";
        $("selLevel").value = "";
        $("searchText").value = "";
        applyFilters();
      }

      /* =========================
         Quiz rendering
      ========================== */
      function setQuizEmpty(show){
        $("quizEmpty").style.display = show ? "" : "none";
        $("questionArea").style.display = show ? "none" : "";
      }

      function resetTimerUi(){
        $("chipTimer").textContent = "00:00:00";
        $("pillTime").textContent = "00:00:00";
      }

      function updateCounters(){
        $("chipBase").textContent = String(state.all.length);
        $("chipFilter").textContent = String(state.queue.length);

        const total = state.queue.length;
        const done = state.answers.length;

        $("pillProgress").textContent = `${done} / ${total}`;
        $("pillAccuracy").textContent = state.started ? "‚Äî" : "‚Äî"; // sem spoilers no meio

        $("quizProgressText").textContent = total ? `${done}/${total} respondidas` : "‚Äî";

        // KPIs home + quiz side
        const remaining = Math.max(0, total - done);

        $("kpiTotal").textContent = String(total);
        $("kpiAnswered").textContent = String(done);
        $("kpiRemaining").textContent = String(remaining);

        $("kpiTotal2").textContent = String(total);
        $("kpiAnswered2").textContent = String(done);
        $("kpiRemaining2").textContent = String(remaining);

        $("kpiMode").textContent = state.examMode ? "Prova" : "Treino";
        $("kpiMode2").textContent = state.examMode ? "Prova" : "Treino";

        $("pillMode").textContent = state.examMode ? "Prova (60)" : "Treino";

        $("dbInfo").textContent = `Base: ${state.all.length} ‚Ä¢ Filtro atual: ${state.queue.length}`;
      }

      function refreshModeBadges(){
        $("kpiMode").textContent = state.examMode ? "Prova" : "Treino";
        $("kpiMode2").textContent = state.examMode ? "Prova" : "Treino";
        $("pillMode").textContent = state.examMode ? "Prova (60)" : "Treino";
      }

      function updateHomeKpis(){
        updateCounters();
      }

      function renderQuestion(q){
        if(!q){
          setQuizEmpty(true);
          return;
        }

        setQuizEmpty(false);

        // header
        $("quizHeaderTitle").textContent = state.examMode ? "Simulado (Modo Prova)" : "Simulado (Treino)";
        $("quizHeaderSub").textContent = "Resultado (acertos/erros) s√≥ aparece no dashboard.";
        $("qTitle").textContent = `Quest√£o ${state.idx + 1} de ${state.queue.length}`;
        $("qText").textContent = safeText(q.q);

        // tags
        $("qMeta").innerHTML = "";
        const mkTag = (txt, cls="") => {
          const s = document.createElement("span");
          s.className = `tag ${cls}`.trim();
          s.textContent = txt;
          return s;
        };
        $("qMeta").appendChild(mkTag(q.module || "Sem m√≥dulo"));
        $("qMeta").appendChild(mkTag(q.chapter || "Sem cap√≠tulo","gray"));
        $("qMeta").appendChild(mkTag(q.theme || "Sem tema","gray"));
        $("qMeta").appendChild(mkTag(q.level || "N√≠vel","green"));

        // options
        const opts = $("qOptions");
        opts.innerHTML = "";

        state.selected = null;
        state.confirmed = false;

        const letters = ["A","B","C","D","E"];
        letters.forEach(L => {
          const v = q.options?.[L];
          if(v == null || safeText(v).trim() === "") return;

          const row = document.createElement("div");
          row.className = "opt";
          row.tabIndex = 0;

          const box = document.createElement("div");
          box.className = "letter";
          box.textContent = L;

          const txt = document.createElement("div");
          txt.className = "txt";
          txt.textContent = safeText(v);

          row.appendChild(box);
          row.appendChild(txt);

          const selectThis = () => {
            if(state.confirmed) return;
            [...opts.querySelectorAll(".opt")].forEach(x => x.classList.remove("selected"));
            row.classList.add("selected");
            state.selected = L;
            $("qStatus").textContent = "Alternativa selecionada. Confirme para registrar.";
            $("qStatus").className = "status neutral";
            $("btnConfirm").disabled = false;
          };

          row.addEventListener("click", selectThis);
          row.addEventListener("keydown", (e) => {
            if(e.key === "Enter" || e.key === " "){
              e.preventDefault();
              selectThis();
            }
          });

          opts.appendChild(row);
        });

        // explain
        $("qExplain").classList.remove("show");
        $("qExplain").textContent = safeText(q.explain || "");

        $("qStatus").textContent = "Selecione uma alternativa.";
        $("qStatus").className = "status neutral";

        $("btnConfirm").disabled = true;
        $("btnExplain").disabled = !state.showExplain;
        $("btnNext").disabled = true;
        $("btnFinish").disabled = false;

        $("qHint").textContent = state.noRepeat
          ? "Dica: ao confirmar, esta quest√£o entra no seu hist√≥rico local (n√£o repetir)."
          : "Dica: ative ‚ÄúN√£o repetir‚Äù para variar as quest√µes nas pr√≥ximas sess√µes.";

        updateCounters();
      }

      function confirmAnswer(){
        if(!state.current || !state.selected || state.confirmed) return;

        state.confirmed = true;
        const q = state.current;
        const correct = (state.selected === q.answer);

        state.answers.push({
          id: q.id,
          module: q.module,
          chapter: q.chapter,
          theme: q.theme,
          level: q.level,
          selected: state.selected,
          correct,
          ts: Date.now()
        });

        addToHistory(q.id);

        // Feedback m√≠nimo (sem ‚Äúconsolidado‚Äù de acertos)
        $("qStatus").textContent = "Resposta registrada.";
        $("qStatus").className = correct ? "status ok" : "status bad";

        $("btnNext").disabled = false;
        $("btnFinish").disabled = false;
        $("btnConfirm").disabled = true;

        // mant√©m sess√£o para continuar
        persistSession();

        updateCounters();
      }

      function toggleExplain(){
        if(!state.current) return;
        $("qExplain").classList.toggle("show");
      }

      function nextQuestion(){
        if(!state.started) return;

        if(!state.confirmed){
          $("qStatus").textContent = "Confirme a resposta antes de avan√ßar.";
          $("qStatus").className = "status neutral";
          return;
        }

        state.idx++;
        if(state.idx >= state.queue.length){
          finishQuiz();
          return;
        }

        state.current = state.queue[state.idx];
        renderQuestion(state.current);

        persistSession();
      }

      /* =========================
         Timer / Start / Finish
      ========================== */
      function tick(){
        state.elapsedMs = Date.now() - state.startAt;
        const t = fmtTime(state.elapsedMs);
        $("chipTimer").textContent = t;
        $("pillTime").textContent = t;
      }

      function startQuizFromCurrentQueue(){
        if(!state.queue.length){
          alert("Nenhuma quest√£o encontrada com esses filtros.");
          return;
        }

        // reset resultados
        state.answers = [];
        state.idx = 0;
        state.current = state.queue[0];
        state.started = true;

        // timer
        state.startAt = Date.now();
        state.elapsedMs = 0;
        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(tick, 250);

        // render
        showView("quiz");
        renderQuestion(state.current);

        persistSession();
      }

      function finishQuiz(){
        if(!state.started) return;

        clearInterval(state.timerId);
        state.timerId = null;
        state.started = false;

        buildFinalDashboard();
        showView("dash");

        clearSession(); // encerrou
      }

      /* =========================
         Dashboard
      ========================== */
      let chartRef = null;

      function buildFinalDashboard(){
        const total = state.queue.length;
        const answered = state.answers.length;
        const hits = state.answers.filter(x=>x.correct).length;
        const acc = total ? Math.round((hits/total)*100) : 0;

        $("finalTime").textContent = fmtTime(state.elapsedMs);
        $("finalAcc").textContent = `${acc}%`;
        $("finalQtd").textContent = String(total);
        $("finalHits").textContent = `${hits}/${total}`;

        const notes = [];
        notes.push(`Respondidas: ${answered}/${total}.`);
        if(answered < total) notes.push(`Voc√™ finalizou antes de responder todas as quest√µes.`);
        notes.push(`Modo: ${state.examMode ? "Prova (60)" : "Treino"}.`);
        $("finalNotes").textContent = notes.join(" ");

        // erradas
        const wrong = state.answers.filter(x=>!x.correct);
        const wrongBox = $("wrongList");
        wrongBox.innerHTML = "";
        if(!wrong.length){
          wrongBox.innerHTML = `<div class="muted">Nenhuma errada üéâ</div>`;
        }else{
          const ul = document.createElement("ul");
          ul.style.margin = "0";
          ul.style.paddingLeft = "18px";
          ul.style.lineHeight = "1.5";

          wrong.slice(0, 200).forEach(w => {
            const li = document.createElement("li");
            li.innerHTML = `<b>${w.id}</b> ‚Äî ${safeText(w.module)} ‚Ä¢ ${safeText(w.theme)} (marcou ${w.selected}, gabarito ${findAnswerLetter(w.id)})`;
            ul.appendChild(li);
          });

          wrongBox.appendChild(ul);

          if(wrong.length > 200){
            const more = document.createElement("div");
            more.className = "muted";
            more.style.marginTop = "10px";
            more.textContent = `+ ${wrong.length - 200} itens ocultos para n√£o poluir a tela.`;
            wrongBox.appendChild(more);
          }
        }

        // chart por m√≥dulo/tema
        const map = new Map();
        state.answers.forEach(a => {
          const key = `${a.module} ‚Äî ${a.theme}`;
          const cur = map.get(key) || {hits:0,total:0};
          cur.total += 1;
          if(a.correct) cur.hits += 1;
          map.set(key, cur);
        });

        const entries = [...map.entries()].sort((a,b)=>b[1].total - a[1].total);
        const labels = entries.map(e=>e[0]);
        const dataHits = entries.map(e=>e[1].hits);

        const ctx = $("chartByModule").getContext("2d");
        if(chartRef) chartRef.destroy();

        chartRef = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Acertos",
              data: dataHits
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { maxRotation: 60, minRotation: 0 } },
              y: { beginAtZero: true, precision: 0 }
            }
          }
        });

        // Sidebar accuracy agora pode mostrar
        $("pillAccuracy").textContent = total ? `${acc}%` : "‚Äî";
        updateCounters();
      }

      function findAnswerLetter(id){
        const q = state.all.find(x => x.id === id);
        return q?.answer || "?";
      }

      function reviewWrong(){
        const wrongIds = new Set(state.answers.filter(x=>!x.correct).map(x=>x.id));
        const wrongQs = state.all.filter(q => wrongIds.has(q.id));

        state.queue = state.shuffle ? shuffle(wrongQs) : wrongQs.slice();
        state.idx = 0;
        state.answers = [];
        state.current = null;

        resetTimerUi();
        showView("home");
        openModal();
        $("modalInfo").textContent = `Revis√£o: ${state.queue.length} quest√µes erradas selecionadas. Clique ‚ÄúCome√ßar‚Äù.`;
        $("navCount").textContent = String(state.queue.length);
        $("chipFilter").textContent = String(state.queue.length);
        updateCounters();
      }

      function exportResultJson(){
        const payload = {
          generatedAt: new Date().toISOString(),
          durationMs: state.elapsedMs,
          totalQuestions: state.queue.length,
          answers: state.answers
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "resultado_pqo_risco.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }

      /* =========================
         Session (Continue)
      ========================== */
      function persistSession(){
        try{
          const snapshot = {
            started: state.started,
            startAt: state.startAt,
            elapsedMs: state.elapsedMs,
            prefs: {
              noRepeat: state.noRepeat,
              shuffle: state.shuffle,
              showExplain: state.showExplain,
              examMode: state.examMode
            },
            // fila atual por ids (reconstroi com base)
            queueIds: state.queue.map(q=>q.id),
            idx: state.idx,
            answers: state.answers
          };
          localStorage.setItem(LS_SESSION, JSON.stringify(snapshot));
        }catch{}
      }

      function clearSession(){
        localStorage.removeItem(LS_SESSION);
      }

      function loadSession(){
        try{
          const raw = localStorage.getItem(LS_SESSION);
          if(!raw) return null;
          return JSON.parse(raw);
        }catch{
          return null;
        }
      }

      function canContinue(){
        const s = loadSession();
        return !!(s && s.queueIds && s.queueIds.length && typeof s.idx === "number");
      }

      function continueSession(){
        const s = loadSession();
        if(!s) return;

        // aplica prefs salvos (pra ficar consistente)
        if(s.prefs){
          state.noRepeat = !!s.prefs.noRepeat;
          state.shuffle = s.prefs.shuffle !== false;
          state.showExplain = s.prefs.showExplain !== false;
          state.examMode = !!s.prefs.examMode;
        }
        setSwitch($("swNoRepeat"), state.noRepeat);
        setSwitch($("swShuffle"), state.shuffle);
        setSwitch($("swExplain"), state.showExplain);
        setSwitch($("swExam"), state.examMode);
        savePrefs();

        // reconstroi queue
        const map = new Map(state.all.map(q => [q.id, q]));
        state.queue = s.queueIds.map(id => map.get(id)).filter(Boolean);
        state.idx = Math.min(Math.max(0, s.idx), Math.max(0, state.queue.length-1));
        state.answers = Array.isArray(s.answers) ? s.answers : [];

        // timer
        state.started = !!s.started;
        state.startAt = s.startAt || Date.now();
        state.elapsedMs = s.elapsedMs || 0;

        if(state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(tick, 250);

        // re-render
        state.current = state.queue[state.idx] || null;
        showView("quiz");
        renderQuestion(state.current);

        updateCounters();
      }

      /* =========================
         DB Load (GitHub Pages)
      ========================== */
      async function loadDbFromGithub(){
        // Se voc√™ renomear para "QuestoesPQO.json", troque a linha abaixo:
        const url = "./Quest√µesPQO.json";

        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        return data;
      }

      function sanitizeDb(data){
        const arr = Array.isArray(data) ? data : [];
        return arr.map(q => ({
          id: safeText(q.id),
          module: safeText(q.module),
          chapter: safeText(q.chapter),
          theme: safeText(q.theme),
          level: safeText(q.level),
          q: safeText(q.q),
          options: q.options || {},
          answer: safeText(q.answer).trim().toUpperCase(),
          explain: safeText(q.explain)
        })).filter(q => q.id && q.q && q.options && q.answer);
      }

      /* =========================
         Bind events
      ========================== */
      function bind(){
        // switches
        bindSwitch($("swNoRepeat"), () => state.noRepeat, v => state.noRepeat = v);
        bindSwitch($("swShuffle"), () => state.shuffle, v => state.shuffle = v);
        bindSwitch($("swExplain"), () => state.showExplain, v => state.showExplain = v);
        bindSwitch($("swExam"), () => state.examMode, v => state.examMode = v);

        // nav
        $("navHome").addEventListener("click", () => showView("home"));
        $("navQuiz").addEventListener("click", () => showView("quiz"));
        $("navDashboard").addEventListener("click", () => {
          if(state.answers.length){
            buildFinalDashboard();
            showView("dash");
          }else{
            alert("Finalize um simulado (ou responda ao menos 1 quest√£o) para ver o Dashboard.");
          }
        });

        // home actions
        $("actNew").addEventListener("click", () => { openModal(); applyFilters(); });
        $("actQuickExam").addEventListener("click", () => {
          state.examMode = true;
          setSwitch($("swExam"), true);
          savePrefs();
          refreshModeBadges();
          openModal();
          applyFilters();
        });
        $("actDashboard").addEventListener("click", () => {
          if(state.answers.length){
            buildFinalDashboard();
            showView("dash");
          }else{
            alert("Sem resultados ainda. Inicie um simulado e finalize para ver o Dashboard.");
          }
        });
        $("actContinue").addEventListener("click", () => {
          if(!canContinue()){
            alert("N√£o existe sess√£o para continuar.");
            return;
          }
          continueSession();
        });

        // modal
        $("btnCloseModal").addEventListener("click", closeModal);
        $("modalBackdrop").addEventListener("click", (e) => {
          if(e.target === $("modalBackdrop")) closeModal();
        });

        $("btnClearFilters").addEventListener("click", clearFiltersUi);

        ["selModule","selChapter","selTheme","selLevel","searchText"].forEach(id => {
          $(id).addEventListener("change", applyFilters);
          if(id==="searchText"){
            $(id).addEventListener("keydown", (e) => {
              if(e.key === "Enter"){ e.preventDefault(); applyFilters(); }
            });
          }
        });

        $("btnStartQuiz").addEventListener("click", () => {
          applyFilters();
          closeModal();
          startQuizFromCurrentQueue();
        });

        // quiz actions
        $("btnConfirm").addEventListener("click", confirmAnswer);
        $("btnExplain").addEventListener("click", toggleExplain);
        $("btnNext").addEventListener("click", nextQuestion);
        $("btnFinish").addEventListener("click", finishQuiz);

        // dashboard
        $("btnReviewWrong").addEventListener("click", reviewWrong);
        $("btnExportJson").addEventListener("click", exportResultJson);

        // clear history
        $("btnResetHistory").addEventListener("click", () => {
          if(confirm("Tem certeza que deseja limpar o hist√≥rico local (n√£o repetir + sess√£o)?")){
            clearHistory();
            state.answers = [];
            state.queue = state.filtered = [];
            state.idx = 0;
            state.current = null;
            resetTimerUi();
            updateCounters();
            alert("Hist√≥rico limpo.");
          }
        });
      }

      /* =========================
         Boot
      ========================== */
      async function boot(){
        loadPrefs();
        setSwitch($("swNoRepeat"), state.noRepeat);
        setSwitch($("swShuffle"), state.shuffle);
        setSwitch($("swExplain"), state.showExplain);
        setSwitch($("swExam"), state.examMode);
        refreshModeBadges();

        bind();

        try{
          const raw = await loadDbFromGithub();
          state.all = sanitizeDb(raw);

          $("noteLoad").innerHTML = `Base carregada automaticamente ‚úÖ<br/>Arquivo: <b>./Quest√µesPQO.json</b>`;
        }catch(err){
          // fallback: deixa claro o erro e orienta renomear
          state.all = [];
          $("noteLoad").innerHTML =
            `N√£o consegui carregar o JSON automaticamente ‚ùå<br/>` +
            `Confirme se o arquivo existe no reposit√≥rio e tente renomear para <b>QuestoesPQO.json</b> (sem acento).`;
          console.error(err);
        }

        buildFilterOptions();
        applyFilters();

        // Sess√£o em andamento?
        if(canContinue()){
          $("actContinue").style.opacity = "1";
        }else{
          $("actContinue").style.opacity = ".65";
        }

        updateCounters();
        setQuizEmpty(true);

        $("chipBase").textContent = String(state.all.length);
        $("chipFilter").textContent = String(state.queue.length);

        // timer parado na home
        resetTimerUi();
      }

      boot();

      // debug
      window.__PQO = state;
    })();
  </script>
</body>
</html>
